<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI手机应用</title>
    <style>
        /* 所有现有样式保持不变 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .phone-container {
            width: 380px;
            height: 666px;
            background: white;
            border: 16px solid #000;
            border-radius: 36px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
        }

        .screen {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            border-radius: 20px;
        }

        .interface {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            background: white;
            display: flex;
            flex-direction: column;
            border-radius: 20px;
        }

        .interface.active {
            opacity: 1;
            pointer-events: all;
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 5px solid #000;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .back-button {
            position: absolute;
            left: 0;
            background: white;
            border: 1px solid #000;
            padding: 6px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1;
        }

        .header h1 {
            font-size: 21px;
            font-weight: 600;
            margin: 0;
            display: flex;
            gap: 8px;
        }

        .toggle-persona {
            position: absolute;
            right: 0;
            top: 0;
            background: white;
            border: 1px solid #000;
            padding: 6px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
        }

        .desktop-interface {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            color: #000;
            /* 减少顶部内边距，使内容更靠上 */
            padding-top: 20px;
        }

        .desktop-interface.active {
            display: flex;
        }

        .app-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            /* 减少上边距，使图标更靠上 */
            margin-top: 30px;
            padding: 0 20px;
        }

        .app-icon {
            width: 80px;
            height: 80px;
            background: #ffffff;
            border-radius: 27px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 30px;
        }

        .app-icon:hover {
            transform: scale(1.1);
            background: #000000; 
        }

        .app-label {
            margin-top: 10px;
            font-size: 15px;
            text-align: center;
            color: #000;
        }

        .app-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .desktop-time {
            font-size: 110px;
            font-weight: 1000;
            /* 减少底部边距 */
            margin-bottom: 10px;
            color: #000;
        }

        .desktop-signature {
            font-size: 18px;
            color: #000;
            /* 减少底部边距 */
            margin-bottom: 20px;
            text-align: center;
            min-height: 24px;
            padding: 0 20px;
            width: 100%;
            cursor: text;
            transition: all 0.3s ease;
            outline: none;
            border: none;
            background: transparent;
            font-family: inherit;
        }

        .desktop-signature:focus {
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
        }

        .chat-interface {
            padding-bottom: 0;
        }

        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 0;
            -webkit-overflow-scrolling: touch;
            overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .scrollable-content::-webkit-scrollbar {
            display: none;
            width: 0;
            background: transparent;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #000;
            background: #fafafa;
            margin-bottom: 10px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .chat-messages::-webkit-scrollbar {
            display: none;
            width: 0;
            background: transparent;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-input-container {
            flex-shrink: 0;
            margin-top: auto;
            padding: 5px 0;
            background: white;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #000;
            border-radius: 5px;
        }

        .chat-input button {
            padding: 10px 20px;
            border: 1px solid #000;
            background: white;   
            border-radius: 5px;
            cursor: pointer;
        }

        .persona-section {
            margin-top: 10px;
            padding: 15px;
            border: 1px solid #000;
        }

        .persona-section h3 {
            margin-bottom: 10px;
        }

        .persona-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #000;
            margin-bottom: 10px;
            border-radius: 5px;
        } 

        .persona-buttons {
            display: flex;
            gap: 10px;
        }

        .persona-buttons button {
            flex: 1;
            padding: 8px;
            border: 1px solid #000;
            background: white;
            border-radius: 5px;
            cursor: pointer;
        } 

        /* 新增备份功能样式 */
        .backup-section {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #000;
            border-radius: 8px;
            background: #fafafa;
        }
        
        .backup-section h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .backup-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .backup-buttons button {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #000;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            min-width: 120px;
        }
        
        .backup-buttons button:hover {
            background: #f0f0f0;
        }
        
        .backup-file-input {
            display: none;
        }
        
        .backup-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            display: none;
            font-size: 12px;
        }
        
        .backup-success {
            background: #f0f0f0;
            border: 1px solid #000;
            color: #000;
        }
        
        .backup-error {
            background: #f0f0f0;
            border: 1px solid #000;
            color: #000;
        }
        
        .backup-info {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
            text-align: center;
        }

        .message {
            max-width: 100%;
            padding: 10px;
            margin: 5px 0;
            border-radius: 20px;
            word-wrap: break-word;
            position: relative;
            transition: all 0.3s ease;
            opacity: 1;
            transform: scale(1);
        }

        .user-message {
            background: white;
            border: 1px solid #000;
            margin-left: auto;
        }

        .ai-message {
            background: white;
            border: 1px solid #000;
            margin-right: auto;
        }

        .message-sender {
            font-size: 16px;
            color: #000;
            margin-bottom: 3px;
            font-weight: 800;
        }
        
        .message-content {
            font-size: 13px; 
        }

        .message-actions {
            position: absolute;
            top: 5px;
            display: none;
            right: 10px;
            gap: 5px;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .message-action {
            background: rgba(255,255,255,0.9);
            border: 1px solid #000;
            border-radius: 3px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
        }

        .message.editing {
            background: #FFFFFF;
            border-color: #FFFFFF;
        }

        .message.deleting {
            opacity: 0;
            transform: scale(0.5);
            max-height: 0;
            margin: 0;
            padding: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .chat-input input:focus {
            border: 3px solid #4a6ee0 !important;
            outline: none !important;
            box-shadow: none !important;
        }

        .input:focus, textarea:focus, select:focus {
            border: 3px solid #4a6ee0 !important;
            outline: none !important;
        }

        .edit-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #000;
            border-radius: 9px;
            font-size: 13px;
            resize: vertical;
            min-height: 80px;
        }

        .edit-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: flex-end;
        }

        .edit-actions button {
            padding: 5px 10px;
            border: 1px solid #000;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .persona-editor {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-bottom: 10px;
        }

        .persona-editor.expanded {
            max-height:  100px;
        }
        
        .persona-form {
            padding: 15px;
            border: 2px solid #000;
            border-radius: 5px;
            background: #fafafa;
        }        

        .form-group {
            margin-bottom: 5px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #000;
            border-radius: 9px;
            background: white;
        }

        .persona-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .persona-actions button {
            flex: 1;
            padding: 5px;
            border: 1px solid #000;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            min-width: 50px;
        }
        
        input, textarea {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 12px 15px;
            width: 100%;
            background: white;
        }

        input:focus, textarea:focus {
            border: 3px solid #4a6ee0 !important;
            outline: none;
            box-shadow: none;
        }

        input:-webkit-autofill {
            -webkit-box-shadow: 0 0 0px 1000px white inset;
            border: 3px solid #4a6ee0 !important;
        }

        #api-interface .header h1 {
             margin-left: 20px;  /* 向右移动20像素 */
        }

        .api-section {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #000;
        }

        .api-section h3 {
            margin-bottom: 10px;
        }

        .api-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #000;   
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .api-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .api-buttons button {
            padding: 8px 15px;
            border: 1px solid #000;
            background: white;
            border-radius: 5px;  
            cursor: pointer;
            flex: 1;
        }

        .api-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }   

        .status-success {
            background: #f0f0f0;
            border: 1px solid #000;
        }

        .status-error {
            background: #f0f0f0;
            border: 1px solid #000;
        }

        .style-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 400px;
        }  

        .ai-circle {
            width: 120px;
            height: 120px;
            border: 3px solid #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            font-weight: bold;
            margin: 20px 0;
        }

        .css-editor {
            width: 100%;
            height: 200px;
            padding: 10px;    
            border: 1px solid #000;
            border-radius: 8px;
            font-family: monospace;
            resize: vertical;
        }

        .apply-css {
            width = 100%;
            padding: 10px;
            border: 1px solid #000;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;   
        }

        .app-navigation {
            position: relative;
            width: 100%;
            height: 2px;
            background: #000;
            flex-shrink: 0;
            display: none;
        }

        .desktop-interface .app-navigation {
            display: none;
        }

        #api-interface .app-navigation,
        #style-interface .app-navigation,
        #chat-interface .app-navigation {
            display: none;
        }

        .interface.exiting {
            transform: translateX(-100%);
            opacity: 0;
        }

        .interface.entering {
            transform: translateX(100%);
        }

        .interface.entering.active {
            transform: translateX(0);
        }

        .scroll-hint {   
            text-align: center;
            font-size: 10px;
            color: #666;
            margin-top: 10px;
            display: none;
        }

        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .confirm-content {
            background: white;
            padding: 20px;
            border: 2px solid #000;
            border-radius: 10px;
            text-align: center;
            max-width: 300px;
            margin: 0 20px;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .confirm-buttons button { 
            flex: 1;
            padding: 8px;
            border: 1px solid #000;
            background: white;
            border-radius: 5px;
            cursor: pointer;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
            transition: all 0.3s ease;
        }

        .status-online {
            background: #00ff00;
        }

        .status-offline {
            background: #ff0000;
        }

        .status-generating {
            background: #00ff00;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .typing-indicator {
            display: inline-block;
            margin-left: 5px;  
        }

        .typing-dot {
            display: inline-block;
            width: 4px;
            height: 4px;
            background: #000;
            border-radius: 50%;
            margin: 0 1px;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }   

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        .model-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #000;
            margin-top: 10px;   
            padding: 10px;
            background: #fafafa;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .model-list::-webkit-scrollbar {
            display: none;
            width: 0;
            background: transparent;
        }

        .model-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .model-item:hover {
            background: #f0f0f0;
        }

        .model-item:last-child {
            border-bottom: none;
        }   

        .refresh-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .refresh-button {
            background: white;
            border: 1px solid #000;
            padding: 5px 10px;
            borderRadius: 3px;
            cursor: pointer;
        }    

        .last-updated {
            font-size: 12px;
            color: #666;
        }

        .model-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding: 5px;
            background: #ffffff;   
            border-radius: 3px;
        }

        .current-model {
            font-size: 14px;
            font-weight: 600;
        }

        .model-badge {
            background: #000;
            color: white;
            padding: 3px 6px;
            border-radius: 10px;
            font-size: 12px;
        }    

        .persona-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .modal-content {
            background: white;    
            width: 90%;
            max-width: 350px;
            max-height: 80vh;
            border: 2px solid #000;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #000;
            background: #fafafa;
            display: flex;
            justify-content: space-between;
            align-items: center;    
        }

        .modal-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;   
            justify-content: center;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .modal-body::-webkit-scrollbar {
            display: none;
            width: 0;
            background: transparent;
        }

        .persona-tabs {
            display: flex;
            border-bottom: 1px solid #000;
            margin-bottom: 15px;
        }     

        .persona-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: none;
            background: white;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .persona-tab.active {
            border-bottom: 2px solid #000;
            font-weight: 600;
        }

        .persona-form-section {
            display: none;
        }     

        .persona-form-section.active {
            display: block;
        }

        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #000;
            border-radius: 5px;
        }

        .form-section h4 {
            margin-bottom: 10px;
            font-size: 14px;  
        }

        .persona-preview {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #000;
            border-radius: 5px;
            background: #fafafa;
            font-size: 12px;
        }

        .persona-preview h5 {
            margin-bottom: 5px;
            font-size: 12px;     
        }
        
        #style-interface .header h1 {
             margin-left: 30px;  /* 向右移动20像素 */
        }
        
        .style-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
            width: 100%;
        }
        
        .style-buttons button {
            flex: 1;
            padding: 10px;
            border: 1px solid #000;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            min-width: 120px;
        }

        /* 音乐播放器样式 - 优化后的版本 */
        .music-player {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: white;
        }
        
        /* 固定部分 - 唱片、歌曲信息、进度条、控制按钮 */
        .music-fixed-area {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px 5px;
            /* 减少底部内边距，使文件选择区域更靠近 */
        }
        
        /* 可滚动部分 - 文件上传和播放列表 */
        .music-scrollable-area {
            flex: 1;
            overflow-y: auto;
            padding: 5px 15px 15px;
            /* 减少顶部内边距，使内容更靠近固定区域 */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .music-scrollable-area::-webkit-scrollbar {
            display: none;
            width: 0;
            background: transparent;
        }
        
        /* 唱片区域 */
        .disc-container {
            width: 220px;
            height: 220px;
            margin: 15px 0 20px;
            /* 减少唱片区域的上下边距 */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .disc {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #333 0%, #000 100%);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            /* 去掉阴影效果 */
            position: relative;
            animation: rotate 20s linear infinite;
            animation-play-state: paused;
        }
        
        .disc-center {
            width: 40px;
            height: 40px;
            background-color: #fff;
            border-radius: 50%;
            z-index: 2;
        }
        
        .disc.playing {
            animation-play-state: running;
        }
        
        /* 歌曲信息 */
        .song-info {
            margin-bottom: 15px;
            /* 减少歌曲信息的底部边距 */
            width: 100%;
            text-align: center;
        }
        
        .song-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #000;
        }
        
        .song-artist {
            font-size: 14px;
            color: #555;
        }
        
        /* 进度条 */
        .progress-container {
            width: 100%;
            margin-bottom: 15px;
            /* 减少进度条的底部边距 */
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 12px;
            color: #555;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #ddd;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: #000;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s;
        }
        
        /* 控制按钮 */
        .control-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-bottom: 15px;
            /* 减少控制按钮的底部边距 */
        }
        
        .btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #000;
            width: 20px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background-color: #f0f0f0;
        }
        
        .btn-play {
            width: 50px;
            height: 50px;
            background-color: #000;
            color: #fff;
            font-size: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding-bottom: 2px;
        }
        
        .btn-play:hover {
            background-color: #333;
            transform: scale(1.05);
        }
        
        .btn-loop {
            font-size: 18px;
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 20px; 
        }
    
        /* 文件上传区域 */
        .import-section {
            margin-top: 5px;
            /* 减少文件上传区域的上边距，使其更靠近控制按钮 */
            width: 100%;
            max-width: 100%;
        }
        
        .import-btn {
            width: 100%;
            padding: 10px;
            background: white;
            border: 2px solid #000;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.2s ease;
            font-size: 14px;
        }
        
        .import-btn:hover {
            background: #f0f0f0;
        }
        
        .file-input {
            display: none;
        }
        
        .playlist {
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-top: 10px;
            border: 2px solid #000000; 
            font-size: 12px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .playlist::-webkit-scrollbar {
            display: none;
            width: 0;
            background: transparent;
        }
        
        .playlist-item {
            padding: 6px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .playlist-item:last-child {
            border-bottom: none;
        }
        
        .playlist-item:hover {
            background: #f9f9f9;
        }
        
        .playlist-item.active {
            background: #f0f0f0;
            font-weight: bold;
        }
        
        .song-duration {
            font-size: 10px;
            color: #666;
            margin-left: 8px;
        }
        
        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        #music-interface .header h1 {
              margin-left: 30px;  /* 向右移动20像素 */
        }
        
        .music-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .music-artist {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
            text-align: center;
            width: 100%;
        }
        
        /* 确保唱片是完美圆形 */
        .disc-container::before {
            content: "";
            display: block;
            padding-top: 100%;
        }
        
        .disc-container > * {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* 世界书界面新增样式 */
        .worldbook-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        /* 世界书界面标题样式调整 */
        #worldbook-interface .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        #worldbook-interface .header h1 {
            flex: 1;
            text-align: center;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding-left: 40px;
            font-size: 22px;
        }

        /* 新的加号按钮样式 - 大的加号，没有圆圈 */
        #worldbook-interface .add-worldbook-btn {
            background: none;
            border: none;
            font-size: 36px; /* 增大加号大小 */
            cursor: pointer;
            padding: 0;
            width: 40px; /* 增大按钮宽度 */
            height: 40px; /* 增大按钮高度 */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            right: 0;
            color: #000; /* 确保加号为黑色 */
            font-weight: normal; /* 正常字体粗细 */
            transition: all 0.2s ease; /* 添加过渡效果 */
        }

        /* 添加悬停效果 */
        #worldbook-interface .add-worldbook-btn:hover {
            transform: scale(1.1); /* 悬停时轻微放大 */
            color: #333; /* 悬停时颜色变深 */
        }

        /* 世界书内容区域的标题样式 */
        #worldbook-interface h2 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 20px;
        }
        
        .worldbook-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .worldbook-item {
            border: 1px solid #000;
            border-radius: 8px;
            padding: 12px;
            background: white;
            position: relative;
        }
        
        .worldbook-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .worldbook-content {
            font-size: 12px;
            color: #333;
            margin-bottom: 10px;
            max-height: 60px;
            overflow: hidden;
            position: relative;
        }
        
        .worldbook-content.expanded {
            max-height: none;
            overflow: visible;
        }
        
        .worldbook-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .worldbook-action {
            background: white;
            border: 1px solid #000;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .worldbook-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1002;
        }
        
        .worldbook-modal-content {
            background: white;
            padding: 20px;
            border: 2px solid #000;
            border-radius: 10px;
            width: 90%;
            max-width: 350px;
        }
        
        .worldbook-form-group {
            margin-bottom: 15px;
        }
        
        .worldbook-form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .worldbook-form-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #000;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .worldbook-form-textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #000;
            border-radius: 5px;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
        }
        
        .worldbook-form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }
        
        .worldbook-form-btn {
            padding: 8px 15px;
            border: 1px solid #000;
            background: white;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .worldbook-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            display: none;
            font-size: 12px;
        }
        
        .worldbook-status-success {
            background: #f0f0f0;
            border: 1px solid #000;
            color: #000;
        }
        
        .worldbook-status-error {
            background: #f0f0f0;
            border: 1px solid #000;
            color: #000;
        }
        
        .worldbook-toggle {
            position: absolute;
            right: 10px;
            top: 10px;
            background: white;
            border: 1px solid #000;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }
        
        .worldbook-active-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .worldbook-active {
            background: #00ff00;
        }
        
        .worldbook-inactive {
            background: #ff0000;
        }

        /* 钱包界面样式 - 修复余额超出问题 */
        .wallet-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 10px;
            overflow-x: hidden; /* 防止水平滚动 */
        }

        /* 顶部余额卡片 - 修复余额超出问题 */
        .balance-card {
            background: #000;
            color: #fff;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            border: 2px solid #000;
            overflow: hidden; /* 防止内容溢出 */
            width: 100%;
            box-sizing: border-box;
        }

        .balance-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .balance-amount {
            font-size: 2.2em; /* 减小字体大小 */
            font-weight: bold;
            letter-spacing: 1px;
            margin: 10px 0;
            word-wrap: break-word; /* 长数字自动换行 */
            overflow-wrap: break-word;
            max-width: 100%;
            padding: 0 10px; /* 添加内边距 */
        }

        .balance-sub-info {
            font-size: 0.9em;
            opacity: 0.8;
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            flex-wrap: wrap; /* 小屏幕时换行 */
        }

        /* 功能操作区 */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .action-btn {
            background: #000;
            color: #fff;
            border: 2px solid #000;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .action-btn:hover {
            background: #333;
            transform: translateY(-2px);
        }

        .action-btn .icon { 
            font-size: 1.2em; 
            margin-bottom: 5px; 
            display: block; 
        }

        /* 交易记录列表 */
        .transaction-section {
            margin-top: 20px;
            border-radius: 10px;
            background: #f9f9f9;
            overflow: hidden;
        }

        .transaction-section h3 {
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #000;
            text-align: center;
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }

        .transaction-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-title {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 3px;
        }

        .transaction-date {
            font-size: 0.8em;
            color: #666;
        }

        .transaction-amount {
            font-weight: bold;
            font-size: 1em;
        }

        .transaction-expense {
            color: #ff4444;
        }

        .transaction-income {
            color: #00aa00;
        }

        .empty-state {
            padding: 30px 0;
            color: #666;
            text-align: center;
        }

        /* 充值弹窗样式 */
        .wallet-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .wallet-modal-content {
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .wallet-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .wallet-modal-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #000;
        }

        .wallet-close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #000;
        }

        .wallet-input-group {
            margin-bottom: 20px;
        }

        .wallet-input-label {
            display: block;
            margin-bottom: 8px;
            color: #000;
            font-weight: 500;
        }

        .amount-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #000;
            border-radius: 8px;
            font-size: 1.1em;
            text-align: center;
            transition: all 0.3s ease;
        }

        /* 修改输入框焦点颜色为蓝色，移除阴影 */
        .amount-input:focus {
            outline: none;
            border-color: #007AFF;
        }

        .wallet-confirm-btn {
            width: 100%;
            background: #000;
            color: #fff;
            border: 2px solid #000;
            border-radius: 8px;
            padding: 12px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .wallet-confirm-btn:hover {
            background: #333;
        }

        /* 水电费缴纳弹窗样式 - 新增房型选择区域 */
        .utility-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .utility-modal-content {
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .utility-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .utility-modal-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #000;
        }

        .utility-close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #000;
        }

        /* 新增房型选择区域 */
        .house-type-selector {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .house-type-selector label {
            display: block;
            margin-bottom: 8px;
            color: #000;
            font-weight: 500;
        }

        .house-type-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #000;
            border-radius: 8px;
            font-size: 1em;
            background-color: white;
        }

        .utility-info {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .utility-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .utility-total {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            font-weight: bold;
            font-size: 1.1em;
        }

        .utility-confirm-btn {
            width: 100%;
            background: #000;
            color: #fff;
            border: 2px solid #000;
            border-radius: 8px;
            padding: 12px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .utility-confirm-btn:hover {
            background: #333;
        }

        /* 删除修改房型弹窗，因为功能已整合到水电费弹窗中 */

        /* 响应式调整 */
        @media (max-width: 480px) {
            .balance-amount { 
                font-size: 1.8em; /* 进一步减小字体大小 */
            }
            
            .action-buttons { 
                grid-template-columns: 1fr; 
                gap: 10px; 
            }
            
            .balance-sub-info {
                flex-direction: column;
                gap: 5px;
            }
        }

        /* 微博界面样式 */
        .weibo-container {
            max-width: 100%;
            margin: 0 auto;
            border-left: 1px solid #f0f0f0;
            border-right: 1px solid #f0f0f0;
            min-height: 100vh;
            background: white;
            overflow-y: auto;
            padding: 0;
        }
        
        .weibo-header {
            position: sticky;
            top: 0;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        
        .weibo-logo {
            font-weight: 700;
            font-size: 20px;
        }
        
        .weibo-nav a {
            color: #000;
            text-decoration: none;
            margin-left: 20px;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .weibo-nav a.active {
            background-color: #000;
            color: #fff;
        }
        
        .weibo-nav a:hover {
            background-color: #f0f0f0;
        }
        
        .weibo-page-content {
            display: none;
        }
        
        .weibo-page-content.active {
            display: block;
        }
        
        .weibo-category-section {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            background-color: #fafafa;
        }
        
        .weibo-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .weibo-category-title {
            font-weight: 600;
            font-size: 16px;
        }
        
        .weibo-manage-categories-btn {
            background: none;
            border: 1px solid #000;
            border-radius: 4px;
            padding: 4px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .weibo-manage-categories-btn:hover {
            background-color: #000;
            color: #fff;
        }
        
        .weibo-category-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .weibo-category-tag {
            background-color: #fff;
            border: 1px solid #000;
            border-radius: 16px;
            padding: 4px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #000;
        }
        
        .weibo-category-tag.active {
            background-color: #000;
            color: #fff;
        }
        
        .weibo-category-tag:hover {
            background-color: #f0f0f0;
            transform: translateY(-1px);
        }
        
        .weibo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .weibo-modal-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .weibo-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .weibo-close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        
        .weibo-category-input-group {
            display: flex;
            margin-bottom: 16px;
        }
        
        .weibo-category-input {
            flex: 1;
            border: 1px solid #e0e0e0;
            border-radius: 4px 0 0 4px;
            padding: 8px;
            outline: none;
        }
        
        .weibo-add-category-btn {
            background-color: #000;
            color: #fff;
            border: none;
            border-radius: 0 4px 4px 0;
            padding: 0 16px;
            cursor: pointer;
        }
        
        .weibo-category-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .weibo-category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .weibo-delete-category {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
        }
        
        .weibo-profile-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .weibo-form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .weibo-form-group label {
            font-size: 14px;
            font-weight: 600;
        }
        
        .weibo-form-group input, .weibo-form-group textarea {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 8px;
            font-family: inherit;
            font-size: 14px;
            outline: none;
        }
        
        .weibo-form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .weibo-save-profile-btn {
            background-color: #000;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .weibo-compose-section {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .weibo-compose-box {
            display: flex;
            gap: 12px;
        }
        
        /* 修改微博头像样式 - 确保黑色背景上显示白色文字 */
        .weibo-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff; /* 确保文字为白色 */
            font-weight: bold;
            font-size: 16px;
        }
        
        .weibo-compose-input {
            flex: 1;
        }
        
        .weibo-compose-input textarea {
            width: 100%;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            font-family: inherit;
            font-size: 14px;
            resize: none;
            outline: none;
            height: 60px;
        }
        
        .weibo-compose-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
        }
        
        .weibo-category-select {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            background: none;
        }
        
        .weibo-action-buttons {
            display: flex;
            gap: 16px;
        }
        
        .weibo-action-buttons button {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 13px;
        }
        
        .weibo-publish-btn {
            background-color: #000;
            color: #fff;
            border: none;
            border-radius: 20px;
            padding: 6px 20px;
            font-size: 13px;
            cursor: pointer;
        }
        
        .weibo-list {
            padding: 0;
        }
        
        .weibo-item {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            gap: 12px;
        }
        
        .weibo-content {
            flex: 1;
        }
        
        .weibo-item-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .weibo-username {
            font-weight: 600;
            margin-right: 8px;
        }
        
        .weibo-item-category {
            background-color: #f0f0f0;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 10px;
            color: #666;
        }
        
        .weibo-timestamp {
            color: #666;
            font-size: 12px;
        }
        
        .weibo-item-text {
            margin-bottom: 12px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .weibo-item-actions {
            display: flex;
            gap: 20px;
        }
        
        .weibo-item-actions button {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .weibo-item-actions button:hover {
            background-color: #f0f0f0;
        }

        /* 新增：点赞按钮激活样式 */
        .weibo-item-actions button.liked {
            color: #ff4d4f;
            border-color: #ff4d4f;
        }

        .weibo-item-actions button.liked:hover {
            background-color: #fff1f0;
        }
        
        /* 修改：删除按钮样式 - 改为黑色 */
        .weibo-item-actions button.delete-btn {
            color: #000; /* 改为黑色 */
        }
        
        .weibo-item-actions button.delete-btn:hover {
            background-color: #f0f0f0;
        }
        
        .weibo-discover-section {
            padding: 16px;
        }
        
        .weibo-discover-title {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 16px;
        }
        
        .weibo-trending-topics {
            margin-bottom: 24px;
        }
        
        .weibo-trending-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .weibo-trending-title {
            font-weight: 600;
            font-size: 16px;
        }
        
        .weibo-refresh-btn {
            background: none;
            border: 1px solid #000;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .weibo-topic-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .weibo-topic-item {
            padding: 12px;
            border: 1px solid #f0f0f0;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .weibo-topic-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .weibo-topic-stats {
            font-size: 12px;
            color: #666;
        }
        
        .weibo-recommended-users {
            margin-bottom: 24px;
        }
        
        .weibo-user-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .weibo-user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        /* 修改推荐用户的头像样式 - 确保黑色背景上显示白色文字 */
        .weibo-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff; /* 确保文字为白色 */
            font-weight: bold;
            font-size: 16px;
        }
        
        .weibo-user-info {
            flex: 1;
        }
        
        .weibo-user-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .weibo-user-bio {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        
        .weibo-follow-btn {
            background: none;
            border: 1px solid #000;
            border-radius: 16px;
            padding: 4px 12px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .weibo-random-quote {
            padding: 16px;
            background-color: #fafafa;
            border-radius: 8px;
            text-align: center;
            font-style: italic;
            margin-top: 16px;
        }
        
        .weibo-comment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .weibo-comment-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .weibo-comment-input {
            width: 100%;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 12px;
            font-family: inherit;
            font-size: 14px;
            resize: none;
            outline: none;
            min-height: 80px;
            margin-bottom: 12px;
        }
        
        .weibo-comment-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .weibo-cancel-comment {
            background: none;
            border: 1px solid #000;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
        }
        
        .weibo-submit-comment {
            background-color: #000;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
        }
        
        .weibo-comments-list {
            margin-top: 16px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .weibo-comment-item {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .weibo-comment-user {
            font-weight: 600;
            margin-right: 8px;
        }
        
        .weibo-comment-text {
            margin-top: 4px;
        }
        
        /* 新增聊天角色主页样式 */
        .chat-character-profile {
            margin-top: 20px;
            padding: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }
        
        .chat-character-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .chat-character-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            font-size: 24px;
        }
        
        .chat-character-info {
            flex: 1;
        }
        
        .chat-character-name {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 4px;
        }
        
        .chat-character-bio {
            font-size: 14px;
            color: #666;
        }
        
        .chat-character-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .chat-character-stat {
            text-align: center;
        }
        
        .chat-character-stat-number {
            font-weight: 600;
            font-size: 16px;
        }
        
        .chat-character-stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .chat-character-edit-btn {
            background-color: #000;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
        }
        
        @media (max-width: 600px) {
            .weibo-container {
                border: none;
            }
        }
    </style>
</head>
<body>
    <!-- 所有现有的对话框和模态框保持不变 -->
    <div class="confirm-dialog" id="confirm-dialog">
        <div class="confirm-content">
            <h3>确认删除</h3>
            <p>您确定要删除这条消息吗？此操作不可撤销。</p>
            <div class="confirm-buttons">
                <button id="confirm-delete-btn">确认删除</button>
                <button id="cancel-delete-btn">取消</button>
            </div>     
        </div>
    </div>

    <!-- 导入确认对话框 -->
    <div class="confirm-dialog" id="import-confirm-dialog">
        <div class="confirm-content">
            <h3>导入聊天记录</h3>
            <p>导入聊天记录将覆盖当前的所有消息，此操作不可撤销。确定要继续吗？</p>
            <div class="confirm-buttons">
                <button id="confirm-import-btn">确认导入</button>
                <button id="cancel-import-btn">取消</button>
            </div>     
        </div>
    </div>

    <!-- 恢复确认对话框 -->
    <div class="confirm-dialog" id="restore-confirm-dialog">
        <div class="confirm-content">
            <h3>恢复聊天记录</h3>
            <p id="restore-confirm-text">恢复聊天记录将覆盖当前的所有消息，此操作不可撤销。确定要恢复吗？</p>
            <div class="confirm-buttons">
                <button id="confirm-restore-btn">确认恢复</button>
                <button id="cancel-restore-btn">取消</button>
            </div>     
        </div>
    </div>

    <!-- 删除世界书记录确认对话框 -->
    <div class="confirm-dialog" id="delete-worldbook-dialog">
        <div class="confirm-content">
            <h3>删除世界书记录</h3>
            <p>您确定要删除这个记录吗？此操作不可撤销。</p>
            <div class="confirm-buttons">
                <button id="confirm-delete-worldbook-btn">确认删除</button>
                <button id="cancel-delete-worldbook-btn">取消</button>
            </div>     
        </div>
    </div>

    <!-- 微博删除确认对话框 -->
    <div class="confirm-dialog" id="weibo-delete-dialog">
        <div class="confirm-content">
            <h3>删除微博</h3>
            <p>您确定要删除这条微博吗？此操作不可撤销。</p>
            <div class="confirm-buttons">
                <button id="confirm-weibo-delete-btn">确认删除</button>
                <button id="cancel-weibo-delete-btn">取消</button>
            </div>     
        </div>
    </div>

    <!-- 充值确认对话框 -->
    <div class="wallet-modal" id="rechargeModal">
        <div class="wallet-modal-content">
            <div class="wallet-modal-header">
                <h2 class="wallet-modal-title">手机充值</h2>
                <button class="wallet-close-btn" id="closeModal">&times;</button>
            </div>
            <div class="wallet-input-group">
                <label class="wallet-input-label">充值金额 (元)</label>
                <input type="number" class="amount-input" id="rechargeAmount" placeholder="请输入充值金额" min="1" step="0.01">
            </div>
            <button class="wallet-confirm-btn" id="confirmRecharge">确认充值</button>
        </div>
    </div>

    <!-- 水电费缴纳弹窗 - 已整合房型选择功能 -->
    <div class="utility-modal" id="utilityModal">
        <div class="utility-modal-content">
            <div class="utility-modal-header">
                <h2 class="utility-modal-title">本月水电费</h2>
                <button class="utility-close-btn" id="closeUtilityModal">&times;</button>
            </div>
            
            <!-- 新增房型选择区域 -->
            <div class="house-type-selector">
                <label for="houseTypeSelect">选择房型</label>
                <select class="house-type-select" id="houseTypeSelect">
                    <option value="豪宅、庄园、城堡">豪宅、庄园、城堡</option>
                    <option value="别墅、独栋">别墅、独栋</option>
                    <option value="高档公寓、大平层">高档公寓、大平层</option>
                    <option value="普通公寓、居民楼、小区">普通公寓、居民楼、小区</option>
                    <option value="经济适用房、小户型">经济适用房、小户型</option>
                    <option value="宿舍、合租房">宿舍、合租房</option>
                    <option value="老破小、旧房" selected>老破小、旧房</option>
                    <option value="农村自建房、乡村">农村自建房、乡村</option>
                </select>
            </div>
            
            <div class="utility-info">
                <div class="utility-item">
                    <span>当前房型:</span>
                    <span id="utility-house-type">老破小</span>
                </div>
                <div class="utility-item">
                    <span>水费:</span>
                    <span id="utility-water">0.00 元</span>
                </div>
                <div class="utility-item">
                    <span>电费:</span>
                    <span id="utility-electricity">0.00 元</span>
                </div>
                <div class="utility-total">
                    <span>总计:</span>
                    <span id="utility-total">0.00 元</span>
                </div>
            </div>
            <button class="utility-confirm-btn" id="confirmUtility">确认缴纳</button>
        </div>
    </div>

    <!-- 删除单独的修改房型弹窗，因为功能已整合到水电费弹窗中 -->

    <div class="persona-modal" id="persona-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>人设管理</h3>
                <button class="close-modal" onclick="closePersonaModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="persona-tabs">
                    <button class="persona-tab active" onclick="switchPersonaTab('ai')">角色人设</button>
                    <button class="persona-tab" onclick="switchPersonaTab('user')">我的人设</button>
                </div>    
                
                <div class="persona-form-section active" id="ai-persona-section">
                    <div class="form-section">
                        <h4>角色人设</h4>
                        <div class="form-group">
                            <label for="ai-persona-name">姓名</label>
                            <input type="text" class="form-input" id="ai-persona-name" placeholder="输入姓名...">
                        </div>
                        <div class="form-group">
                            <label for="ai-persona-desc">人设描述</label>
                            <textarea class="form-input" id="ai-persona-desc" rows="3" placeholder="输入人设描述..."></textarea>
                        </div>    
                        <div class="persona-actions">
                            <button onclick="saveAIPersona()">保存角色人设</button>
                            <button onclick="loadAIPersona()">加载角色人设</button>
                        </div>
                    </div>
                    
                    <div class="persona-preview" id="ai-persona-preview">
                        <h5>人设预览：</h5>
                        <div id="ai-preview-content">暂无人设</div>
                    </div>
                </div>
                
                <div class="persona-form-section" id="user-persona-section">
                    <div class="form-section">
                        <h4>我的人设</h4>
                        <div class="form-group">
                            <label for="user-persona-name">我的姓名</label>
                            <input type="text" class="form-input" id="user-persona-name" placeholder="输入您的姓名...">
                        </div>   
                        <div class="form-group">
                            <label for="user-persona-desc">我的人设描述</label>
                            <textarea class="form-input" id="user-persona-desc" rows="3" placeholder="输入您的人设描述..."></textarea>
                        </div>
                        <div class="persona-actions">
                            <button onclick="saveUserPersona()">保存我的人设</button>
                            <button onclick="loadUserPersona()">加载我的人设</button>
                        </div>
                    </div>
                    
                    <div class="persona-preview" id="user-persona-preview">
                        <h5>我的人设预览：</h5>
                        <div id="user-preview-content">暂无我的人设</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 世界书记录编辑模态框 -->
    <div class="worldbook-modal" id="worldbook-modal">
        <div class="worldbook-modal-content">
            <h3 id="worldbook-modal-title">添加世界书记录</h3>
            <div class="worldbook-form-group">
                <label for="worldbook-title">记录标题</label>
                <input type="text" class="worldbook-form-input" id="worldbook-title" placeholder="输入记录标题...">
            </div>
            <div class="worldbook-form-group">
                <label for="worldbook-content">记录内容</label>
                <textarea class="worldbook-form-textarea" id="worldbook-content" placeholder="输入记录内容..."></textarea>
            </div>
            <div class="worldbook-form-actions">
                <button class="worldbook-form-btn" id="save-worldbook-btn">保存</button>
                <button class="worldbook-form-btn" id="cancel-worldbook-btn">取消</button>
            </div>
            <div class="worldbook-status" id="worldbook-status"></div>
        </div>
    </div>

    <!-- 聊天角色主页编辑模态框 -->
    <div class="weibo-modal" id="chatCharacterModal">
        <div class="weibo-modal-content">
            <div class="weibo-modal-header">
                <h3>编辑聊天角色主页</h3>
                <button class="weibo-close-modal" id="closeChatCharacterModal">×</button>
            </div>
            <div class="weibo-profile-form">
                <div class="weibo-form-group">
                    <label for="chatCharacterName">角色姓名</label>
                    <input type="text" id="chatCharacterName" placeholder="请输入角色姓名">
                </div>
                <div class="weibo-form-group">
                    <label for="chatCharacterBio">角色简介</label>
                    <textarea id="chatCharacterBio" placeholder="介绍一下角色..."></textarea>
                </div>
                <div class="weibo-form-group">
                    <label for="chatCharacterFollowers">粉丝数量</label>
                    <input type="number" id="chatCharacterFollowers" placeholder="请输入粉丝数量">
                </div>
                <button class="weibo-save-profile-btn" id="saveChatCharacterBtn">保存角色设置</button>
            </div>
        </div>
    </div>

    <div class="phone-container">
        <div class="screen">
            <!-- 桌面界面 - 移除了购物和论坛图标 -->
            <div class="desktop-interface active" id="desktop-interface">
                <div class="desktop-time" id="desktop-time">--:--</div>
                <!-- 可编辑个性签名 -->
                <div class="desktop-signature" id="desktop-signature" contenteditable="true">点击编辑个性签名...</div>
                <div class="app-grid">
                    <!-- 第一行应用 -->
                    <div class="app-item" onclick="openApp('chat')">
                        <div class="app-icon">⊕</div>
                        <div class="app-label">聊天</div>
                    </div>
                    <div class="app-item" onclick="openApp('api')">
                        <div class="app-icon">ꕥ</div>
                        <div class="app-label">API</div>
                    </div>
                    <div class="app-item" onclick="openApp('style')">
                        <div class="app-icon">Θ</div>
                        <div class="app-label">美化</div>
                    </div>
                    
                    <!-- 第二行应用 -->
                    <div class="app-item" onclick="openApp('worldbook')">
                        <div class="app-icon">✧</div>
                        <div class="app-label">世界书</div>
                    </div>
                    <div class="app-item" onclick="openApp('wallet')">
                        <div class="app-icon">〒</div>
                        <div class="app-label">钱包</div>
                    </div>
                    <div class="app-item" onclick="openApp('music')">
                        <div class="app-icon">ʊ</div>
                        <div class="app-label">音乐</div>
                    </div>
                    
                    <!-- 第三行应用 - 只保留微博图标 -->
                    <div class="app-item" onclick="openApp('weibo')">
                        <div class="app-icon">㉿</div>
                        <div class="app-label">微博</div>
                    </div>
                    <!-- 购物和论坛图标已删除 -->
                </div>
            </div>

            <!-- 所有现有界面保持不变 -->
            <!-- 聊天界面 -->
            <div class="interface chat-interface" id="chat-interface">
                <div class="header">
                    <button class="back-button" onclick="goBackToDesktop()">●</button>
                    <h1>✤世纪 <span class="status-indicator" id="chat-status"></span></h1>
                    <button class="toggle-persona" onclick="openPersonaModal()">编辑人设</button>
                </div>
                
                <div class="scrollable-content">
                    <div class="chat-container">
                        <div class="chat-messages" id="chat-messages">
                            <!-- 消息将通过JavaScript动态加载 -->
                        </div>
                    </div>      
                    <div class="persona-section">
                        <h3>基础人设设置</h3>
                        <input type="text" class="persona-input" id="persona-input" placeholder="输入角色人设描述...">
                        <div class="persona-buttons">
                            <button onclick="savePersona()">保存人设</button>
                            <button onclick="editPersona()">编辑人设</button>
                            <button onclick="applyPersona()">应用人设</button>
                        </div>
                    </div>
                    
                    <!-- 新增聊天记录备份区域 -->
                    <div class="backup-section">
                        <h3>聊天记录备份</h3>
                        <div class="backup-buttons">
                            <button onclick="exportChatHistory()">导出聊天记录</button>
                            <button onclick="importChatHistory()">导入聊天记录</button>
                            <button onclick="backupToLocal()">备份到本地</button>
                            <button onclick="restoreFromLocal()">从本地恢复</button>
                        </div>
                        <div class="backup-status" id="backup-status"></div>
                        <div class="backup-info">
                            使用导出/导入功能可以在不同浏览器之间迁移聊天记录
                        </div>
                        <input type="file" class="backup-file-input" id="backup-file-input" accept=".json">
                    </div>
                    
                    <div class="scroll-hint" id="chat-scroll-hint">↑ 继续向上滑动查看更多内容</div>
                </div>
                
                <!-- 消息发送条固定在底部 -->
                <div class="chat-input-container">
                    <div class="chat-input">
                        <input type="text" id="message-input" placeholder="输入您的消息..." onkeypress="handleMessageKeypress(event)">
                        <button onclick="sendMessage()" id="send-button">发送</button>
                    </div>
                </div>
                
                <!-- 聊天界面底部导航栏（已隐藏） -->
                <div class="app-navigation" style="display: none;"></div>
            </div>

            <!-- API配置界面 -->
            <div class="interface" id="api-interface">
                <div class="header">
                    <button class="back-button" onclick="goBackToDesktop()">●</button>
                    <h1>API配置 <span class="status-indicator" id="api-status-indicator"></span></h1>
                </div>       
                <div class="scrollable-content">
                    <div class="api-section">
                        <h3>API提供商</h3>
                        <select class="api-input" id="api-provider" onchange="updateApiEndpoints()">
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="google">Google (Gemini)</option>
                            <option value="custom">自定义</option>
                        </select>
                    </div>     
                    <div class="api-section">
                        <h3>API端点配置</h3>
                        <input type="text" class="api-input" id="api-url" placeholder="输入API端点URL..." value="https://api.openai.com/v1">
                        <input type="password" class="api-input" id="api-key" placeholder="输入API密钥...">
                        <div class="api-buttons">
                            <button onclick="testApiConnection()">测试API连接</button>
                            <button onclick="refreshModels()">刷新模型列表</button>
                            <button onclick="saveApiConfig()">保存配置</button>
                            <button onclick="clearApiConfig()">清除配置</button>   
                        </div>
                        <div class="api-status" id="api-status"></div>
                    </div>
                    <div class="api-section">
                        <h3>模型选择</h3>
                        <div class="model-info">
                            <span class="current-model" id="current-model-display">当前模型: 未选择</span>
                            <span class="model-badge" id="model-provider-badge">OpenAI</span>
                        </div>    
                        <select class="api-input" id="model-select" onchange="updateSelectedModel()">
                            <option value="">请选择模型</option>
                        </select>
                        <div class="refresh-status">
                            <button class="refresh-button" onclick="refreshModels()">刷新模型</button>
                            <span class="last-updated" id="last-updated">上次更新: 从未</span>
                        </div>
                        <div class="model-list" id="model-list" style="display: none;">
                            <div class="api-status" id="models-status"></div>
                        </div>
                    </div>    
                    <div class="api-section">
                        <h3>高级设置</h3>
                        <div class="form-group">
                            <label for="temperature">温度 (0-2)</label>
                            <input type="range" class="api-input" id="temperature" min="0" max="2" step="0.1" value="0.7" oninput="updateTemperatureValue()">
                            <span id="temperature-value">0.7</span>
                        </div>  
                        <div class="form-group">
                            <label for="max-tokens">最大令牌数</label>
                            <input type="number" class="api-input" id="max-tokens" value="1000" min="1" max="4000">
                        </div>
                    </div>
                    <div class="scroll-hint" id="api-scroll-hint">↑ 继续向上滑动查看更多内容</div>
                </div>
            </div>

            <!-- 美化界面 -->
            <div class="interface" id="style-interface">
                <div class="header">
                    <button class="back-button" onclick="goBackToDesktop()">●</button>
                    <h1>CSS美化 <span class="status-indicator" id="style-status"></span></h1>
                </div>
                <div class="scrollable-content">
                    <div class="style-container">
                        <div class="ai-circle">AI</div>
                        <textarea class="css-editor" id="css-editor" placeholder="输入全局CSS代码...">/* 在这里输入您的自定义CSS */
.message {     
    border: 1px solid #000;
    background: white;
    margin: 8px 0;
    max-width: 85%;
}

.user-message {
    margin-left: auto;
    background: #f8f8f8;
}    

.ai-message {
    margin-right: auto;
    background: #f0f0f0;
}

.ai-circle {
    border: 3px solid #000;
    background: white;
    transition: all 0.3s ease;
}

.ai-circle:hover {    
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}</textarea> 
                        <div class="style-buttons">
                            <button class="apply-css" onclick="applyGlobalCSS()">应用CSS</button>
                            <button class="apply-css" onclick="resetCSS()">重置CSS</button>
                            <button class="apply-css" onclick="exportCSS()">导出CSS</button>
                            <button class="apply-css" onclick="importCSS()">导入CSS</button>
                        </div>
                    </div>
                    <div class="scroll-hint" id="style-scroll-hint">↑ 继续向上滑动查看更多内容</div>
                </div>
            </div>

            <!-- 音乐界面 - 修复后的版本 -->
            <div class="interface" id="music-interface">
                <div class="header">
                    <button class="back-button" onclick="goBackToDesktop()">●</button>
                    <h1>黑胶唱片 <span class="status-indicator" id="music-status"></span></h1>
                </div>
                <div class="scrollable-content">
                    <div class="music-player">
                        <!-- 固定区域 - 唱片、歌曲信息、进度条、控制按钮 -->
                        <div class="music-fixed-area">
                            <!-- 唱片区域 -->
                            <div class="disc-container">
                                <div class="disc" id="disc">
                                    <div class="disc-center"></div>
                                </div>
                            </div>
                            
                            <!-- 歌曲信息 -->
                            <div class="song-info">
                                <div class="song-title" id="song-title">选择音频开始播放</div>
                                <div class="song-artist" id="song-artist">-</div>
                            </div>
                            
                            <!-- 进度条 -->
                            <div class="progress-container">
                                <div class="progress-info">
                                    <span class="current-time" id="current-time">0:00</span>
                                    <span class="duration" id="duration">0:00</span>
                                </div>
                                <div class="progress-bar" id="progress-bar">
                                    <div class="progress" id="progress"></div>
                                </div>
                            </div>
                            
                            <!-- 控制按钮 - 修复：添加单曲循环按钮 -->
                            <div class="control-buttons">
                                <button class="btn btn-loop active" id="list-loop-btn" title="顺序播放">✦</button>
                                <button class="btn btn-prev" id="prev-btn">⏮</button>
                                <button class="btn btn-play" id="play-pause-btn">▶</button>
                                <button class="btn btn-next" id="next-btn">⏭</button>
                                <button class="btn btn-loop" id="single-loop-btn" title="单曲循环">✦</button>
                            </div>
                        </div>
                        
                        <!-- 可滚动区域 - 文件上传和播放列表 -->
                        <div class="music-scrollable-area">
                            <!-- 文件上传区域 -->
                            <div class="import-section">
                                <div class="import-btn" id="import-btn">
                                    选择音频文件
                                </div>
                                <input type="file" class="file-input" id="file-input" accept="audio/*" multiple>
                                
                                <div class="playlist" id="playlist">
                                    <div class="playlist-item empty">
                                        播放列表为空
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 世界书界面（原预设界面） -->
            <div class="interface" id="worldbook-interface">
                <div class="header">
                    <button class="back-button" onclick="goBackToDesktop()">●</button>
                    <h1>世界书 <span class="status-indicator" id="worldbook-status-indicator"></span></h1>
                    <button class="add-worldbook-btn" onclick="openWorldbookModal()">+</button>
                </div>
                <div class="scrollable-content">
                    <div style="padding: 20px;">
                        <h2>世界书管理 <span class="status-indicator" id="worldbook-status-indicator-title"></span></h2>
                        <p>世界书是告诉AI除了角色之外还需要遵守的行为准则和世界观设定。</p>
                        <div class="worldbook-list" id="worldbook-list">
                            <!-- 世界书记录列表将通过JavaScript动态加载 -->
                        </div>
                        <div class="worldbook-status" id="worldbook-status"></div>
                    </div>
                    <div class="scroll-hint" id="worldbook-scroll-hint">↑ 继续向上滑动查看更多内容</div>
                </div>
            </div>

            <!-- 钱包界面 - 已更新 -->
            <div class="interface" id="wallet-interface">
                <div class="header">
                    <button class="back-button" onclick="goBackToDesktop()">●</button>
                    <h1>我的钱包 <span class="status-indicator" id="wallet-status"></span></h1>
                </div>
                <div class="scrollable-content">
                    <div class="wallet-container">
                        <!-- 顶部余额卡片 -->
                        <section class="balance-card">
                            <div class="balance-label">总余额 (元)</div>
                            <div class="balance-amount" id="totalBalance">0.00</div>
                            <div class="balance-sub-info">
                                <span>今日支出: ¥<span id="todayExpense">0.00</span></span>
                                <span>本月收入: ¥<span id="monthIncome">0.00</span></span>
                            </div>
                        </section>

                        <!-- 功能操作区 - 移除修改房型按钮 -->
                        <section class="action-buttons">
                            <button class="action-btn" id="rechargeBtn">
                                <span class="icon">✚</span> 手机充值
                            </button>
                            <button class="action-btn" id="utilityBtn">
                                <span class="icon">⚡</span> 水电费
                            </button>
                        </section>

                        <!-- 交易记录区域 - 已更新为显示交易记录 -->
                        <section class="transaction-section">
                            <h3>收入支出</h3>
                            <div class="transaction-list" id="transaction-list">
                                <!-- 交易记录将通过JavaScript动态加载 -->
                            </div>
                        </section>
                    </div>
                </div>
            </div>

            <!-- 微博界面 - 完整功能版 -->
            <div class="interface" id="weibo-interface">
                <div class="header">
                    <button class="back-button" onclick="goBackToDesktop()">●</button>
                    <h1>微博 <span class="status-indicator" id="weibo-status"></span></h1>
                </div>
                <div class="scrollable-content">
                    <div class="weibo-container">
                        <header class="weibo-header">
                            <div class="weibo-logo">Weibo</div>
                            <nav class="weibo-nav">
                                <a href="#" id="weiboHomeLink" class="active">首页</a>
                                <a href="#" id="weiboDiscoverLink">发现</a>
                                <a href="#" id="weiboProfileLink">我的</a>
                            </nav>
                        </header>
                        
                        <section id="weiboHomePage" class="weibo-page-content active">
                            <section class="weibo-category-section">
                                <div class="weibo-category-header">
                                    <div class="weibo-category-title">内容分类</div>
                                    <button class="weibo-manage-categories-btn" id="weiboManageCategories">管理分类</button>
                                    <!-- 修复：将刷新按钮直接放在HTML中，避免重复创建 -->
                                    <button class="weibo-refresh-btn" id="weiboRefreshDynamicBtn">刷新动态</button>
                                </div>
                                <div class="weibo-category-tags" id="weiboCategoryTags"></div>
                            </section>
                            
                            <section class="weibo-compose-section">
                                <div class="weibo-compose-box">
                                    <div class="weibo-avatar" id="weiboUserAvatar"></div>
                                    <div class="weibo-compose-input">
                                        <textarea placeholder="分享新鲜事..." id="weiboText"></textarea>
                                        <div class="weibo-compose-actions">
                                            <select class="weibo-category-select" id="weiboCategorySelect">
                                                <option value="">选择分类</option>
                                            </select>
                                            <div class="weibo-action-buttons">
                                                <button>图片</button>
                                                <button>表情</button>
                                                <button>话题</button>
                                            </div>
                                            <button class="weibo-publish-btn" id="weiboPublishBtn">发布</button>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            
                            <section class="weibo-list" id="weiboList"></section>
                        </section>
                        
                        <section id="weiboDiscoverPage" class="weibo-page-content">
                            <div class="weibo-discover-section">
                                <div class="weibo-discover-title">发现精彩内容</div>
                                
                                <div class="weibo-trending-topics">
                                    <div class="weibo-trending-header">
                                        <div class="weibo-trending-title">热门话题</div>
                                        <button class="weibo-refresh-btn" id="weiboRefreshTopics">换一批</button>
                                    </div>
                                    <div class="weibo-topic-list" id="weiboTopicList"></div>
                                </div>
                                
                                <div class="weibo-recommended-users">
                                    <div class="weibo-trending-header">
                                        <div class="weibo-trending-title">推荐用户</div>
                                        <button class="weibo-refresh-btn" id="weiboRefreshUsers">换一批</button>
                                    </div>
                                    <div class="weibo-user-list" id="weiboUserList"></div>
                                </div>
                                
                                <div class="weibo-random-quote" id="weiboRandomQuote"></div>
                            </div>
                        </section>
                        
                        <section id="weiboProfilePage" class="weibo-page-content">
                            <div class="weibo-discover-section">
                                <div class="weibo-discover-title">个人主页</div>
                                
                                <!-- 我的主页 -->
                                <div class="chat-character-profile">
                                    <div class="chat-character-header">
                                        <div class="chat-character-avatar" id="myProfileAvatar"></div>
                                        <div class="chat-character-info">
                                            <div class="chat-character-name" id="myProfileName">微博用户</div>
                                            <div class="chat-character-bio" id="myProfileBio">这个人很懒，什么都没有写...</div>
                                        </div>
                                    </div>
                                    <div class="chat-character-stats">
                                        <div class="chat-character-stat">
                                            <div class="chat-character-stat-number" id="myProfileFollowers">0</div>
                                            <div class="chat-character-stat-label">粉丝</div>
                                        </div>
                                        <div class="chat-character-stat">
                                            <div class="chat-character-stat-number" id="myProfileFollowing">0</div>
                                            <div class="chat-character-stat-label">关注</div>
                                        </div>
                                        <div class="chat-character-stat">
                                            <div class="chat-character-stat-number" id="myProfileWeibos">0</div>
                                            <div class="chat-character-stat-label">微博</div>
                                        </div>
                                    </div>
                                    <button class="chat-character-edit-btn" id="editMyProfileBtn">编辑我的主页</button>
                                </div>
                                
                                <!-- 聊天角色主页已删除，只保留用户自己的主页 -->
                            </div>
                        </section>
                    </div>
                </div>
            </div>

            <!-- 论坛和购物界面已删除 -->
        </div>
    </div>

    <!-- 微博相关模态框 -->
    <div class="weibo-modal" id="weiboCategoryModal">
        <div class="weibo-modal-content">
            <div class="weibo-modal-header">
                <h3>管理分类</h3>
                <button class="weibo-close-modal" id="weiboCloseCategoryModal">×</button>
            </div>
            <div class="weibo-category-input-group">
                <input type="text" class="weibo-category-input" id="weiboNewCategoryInput" placeholder="输入新分类名称">
                <button class="weibo-add-category-btn" id="weiboAddCategoryBtn">添加</button>
            </div>
            <div class="weibo-category-list" id="weiboCategoryList"></div>
        </div>
    </div>
    
    <div class="weibo-modal" id="weiboProfileModal">
        <div class="weibo-modal-content">
            <div class="weibo-modal-header">
                <h3>编辑个人资料</h3>
                <button class="weibo-close-modal" id="weiboCloseProfileModal">×</button>
            </div>
            <div class="weibo-profile-form">
                <div class="weibo-form-group">
                    <label for="weiboProfileName">姓名</label>
                    <input type="text" id="weiboProfileName" placeholder="请输入您的姓名">
                </div>
                <div class="weibo-form-group">
                    <label for="weiboProfileBio">个人简介</label>
                    <textarea id="weiboProfileBio" placeholder="介绍一下自己..."></textarea>
                </div>
                <div class="weibo-form-group">
                    <label for="weiboProfilePersona">人设/标签</label>
                    <input type="text" id="weiboProfilePersona" placeholder="例如：摄影爱好者、程序员、美食家等">
                </div>
                <div class="weibo-form-group">
                    <label for="weiboProfileLocation">所在地</label>
                    <input type="text" id="weiboProfileLocation" placeholder="请输入您所在的城市">
                </div>
                <div class="weibo-form-group">
                    <label for="weiboProfileFollowers">粉丝数量</label>
                    <input type="number" id="weiboProfileFollowers" placeholder="请输入粉丝数量">
                </div>
                <div class="weibo-form-group">
                    <label for="weiboProfileFollowing">关注数量</label>
                    <input type="number" id="weiboProfileFollowing" placeholder="请输入关注数量">
                </div>
                <button class="weibo-save-profile-btn" id="weiboSaveProfileBtn">保存资料</button>
            </div>
        </div>
    </div>
    
    <div class="weibo-comment-modal" id="weiboCommentModal">
        <div class="weibo-comment-content">
            <div class="weibo-modal-header">
                <h3>评论</h3>
                <button class="weibo-close-modal" id="weiboCloseCommentModal">×</button>
            </div>
            <textarea class="weibo-comment-input" id="weiboCommentInput" placeholder="写下您的评论..."></textarea>
            <div class="weibo-comment-actions">
                <button class="weibo-cancel-comment" id="weiboCancelComment">取消</button>
                <button class="weibo-submit-comment" id="weiboSubmitComment">发布评论</button>
            </div>
            <div class="weibo-comments-list" id="weiboCommentsList"></div>
        </div>
    </div>

    <script>
        // 水电费价格配置
        const utilityPrices = {
            "豪宅、庄园、城堡": { water: 800, electricity: 1200 },
            "别墅、独栋": { water: 500, electricity: 800 },
            "高档公寓、大平层": { water: 300, electricity: 500 },
            "普通公寓、居民楼、小区": { water: 150, electricity: 300 },
            "经济适用房、小户型": { water: 100, electricity: 200 },
            "宿舍、合租房": { water: 80, electricity: 150 },
            "老破小、旧房": { water: 50, electricity: 100 },
            "农村自建房、乡村": { water: 30, electricity: 80 }
        };

        // 世界书管理类
        class WorldbookManager {
            constructor() {
                this.records = JSON.parse(localStorage.getItem('worldbook')) || [];
                this.currentEditingId = null;
            }

            addRecord(title, content) {
                const record = {
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    title: title,
                    content: content,
                    active: true,
                    timestamp: new Date().toISOString()
                };
                this.records.push(record);
                this.saveRecords();
                return record;
            }

            updateRecord(id, title, content) {
                const record = this.records.find(r => r.id === id);
                if (record) {
                    record.title = title;
                    record.content = content;
                    record.timestamp = new Date().toISOString();
                    this.saveRecords();
                    return true;
                }
                return false;
            }

            deleteRecord(id) {
                const index = this.records.findIndex(r => r.id === id);
                if (index !== -1) {
                    this.records.splice(index, 1);
                    this.saveRecords();
                    return true;
                }
                return false;
            }

            toggleRecord(id) {
                const record = this.records.find(r => r.id === id);
                if (record) {
                    record.active = !record.active;
                    this.saveRecords();
                    return record.active;
                }
                return false;
            }

            getActiveRecords() {
                return this.records.filter(r => r.active);
            }

            getAllRecords() {
                return [...this.records];
            }

            getRecordById(id) {
                return this.records.find(r => r.id === id);
            }

            saveRecords() {
                localStorage.setItem('worldbook', JSON.stringify(this.records));
            }
        }

        // 音乐播放器功能 - 修复后的版本
        const musicPlayer = {
            audio: new Audio(),
            playlist: [],
            currentIndex: -1,
            isPlaying: false,
            loopMode: 'list', // 默认顺序播放
          
            init: function() {
                // 绑定事件
                this.bindEvents();
                
                // 音频事件监听
                this.audio.addEventListener('loadedmetadata', () => {
                    this.updateTotalTime();
                });
                
                this.audio.addEventListener('timeupdate', () => {
                    this.updateProgress();
                });
                
                // 修复：移除重复的ended事件监听，合并为一个
                this.audio.addEventListener('ended', () => {
                    if (this.loopMode === 'single') {
                        this.audio.currentTime = 0;
                        this.audio.play();
                    } else {    
                        this.next();
                    }
                });
             
                // 初始化音乐状态指示灯
                this.updateMusicStatusIndicator();
                
                // 初始化循环模式
                this.setLoopMode('list');
            },
            
            bindEvents: function() {
                // 播放/暂停按钮
                document.getElementById('play-pause-btn').addEventListener('click', () => {
                    this.togglePlay();
                });
                
                // 上一首按钮
                document.getElementById('prev-btn').addEventListener('click', () => {
                    this.prev();
                });
                
                // 下一首按钮
                document.getElementById('next-btn').addEventListener('click', () => {
                    this.next();
                });
                
                // 进度条点击
                document.getElementById('progress-bar').addEventListener('click', (e) => {
                    this.seek(e);
                });
                
                // 导入按钮
                document.getElementById('import-btn').addEventListener('click', () => {
                    document.getElementById('file-input').click();
                });
                
                // 单曲循环按钮事件
                document.getElementById('single-loop-btn').addEventListener('click', () => {
                    this.setLoopMode('single');
                });

                // 顺序播放按钮事件  
                document.getElementById('list-loop-btn').addEventListener('click', () => {
                    this.setLoopMode('list');
                });
              
                // 文件选择
                document.getElementById('file-input').addEventListener('change', (e) => {
                    this.handleFileSelect(e);
                });
            },
            
            handleFileSelect: function(e) {
                const files = e.target.files;
                if (files.length === 0) return;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.type.startsWith('audio/')) {
                        const url = URL.createObjectURL(file);
                        this.addToPlaylist(file.name, url, file);
                    }
                }
                
                // 如果当前没有播放音乐，自动播放第一首
                if (this.currentIndex === -1 && this.playlist.length > 0) {
                    this.play(0);
                }
                
                // 清空文件输入，以便再次选择相同文件
                e.target.value = '';
            },
            
            addToPlaylist: function(name, url, file) {
                const playlist = document.getElementById('playlist');
                
                // 移除空列表提示
                if (playlist.querySelector('.empty')) {
                    playlist.innerHTML = '';
                }
                
                // 创建播放列表项
                const item = document.createElement('div');
                item.className = 'playlist-item';
                item.dataset.url = url;
                
                // 获取音频时长
                const tempAudio = new Audio(url);
                tempAudio.addEventListener('loadedmetadata', () => {
                    const duration = this.formatTime(tempAudio.duration);
                    item.innerHTML = `
                        <div class="song-title">${name}</div>
                        <div class="song-duration">${duration}</div>
                    `;
                    
                    // 保存时长信息
                    item.dataset.duration = tempAudio.duration;
                });
                
                // 点击播放
                item.addEventListener('click', () => {
                    const index = Array.from(playlist.children).indexOf(item);
                    this.play(index);
                });
                
                playlist.appendChild(item);
                
                // 添加到内部播放列表
                this.playlist.push({
                    name: name,
                    url: url,
                    file: file
                });
            },
            
            play: function(index) {
                if (index < 0 || index >= this.playlist.length) return;
                
                this.currentIndex = index;
                const song = this.playlist[index];
                
                // 更新音频源
                this.audio.src = song.url;
                
                // 更新UI
                document.getElementById('song-title').textContent = song.name;
                document.getElementById('song-artist').textContent = '本地音乐';
                
                // 高亮当前播放项
                const playlistItems = document.querySelectorAll('.playlist-item');
                playlistItems.forEach(item => item.classList.remove('active'));
                playlistItems[index].classList.add('active');
                
                // 播放
                this.audio.play();
                this.isPlaying = true;
                this.updatePlayState();
            },
            
            togglePlay: function() {
                if (this.currentIndex === -1) {
                    if (this.playlist.length > 0) {
                        this.play(0);
                    }
                    return;
                }
                
                if (this.isPlaying) {
                    this.audio.pause();
                } else {
                    this.audio.play();
                }
                
                this.isPlaying = !this.isPlaying;
                this.updatePlayState();
            },
            
            updatePlayState: function() {
                const disc = document.getElementById('disc');
                const playPauseIcon = document.getElementById('play-pause-btn');
                
                if (this.isPlaying) {
                    disc.classList.add('playing');
                    playPauseIcon.textContent = '❚❚';
                } else {
                    disc.classList.remove('playing');
                    playPauseIcon.textContent = '▶';
                }
                
                // 更新音乐状态指示灯
                this.updateMusicStatusIndicator();
            },
            
            updateMusicStatusIndicator: function() {
                const musicStatus = document.getElementById('music-status');
                if (this.isPlaying) {
                    musicStatus.className = 'status-indicator status-online';
                    musicStatus.title = '正在播放';
                } else {
                    musicStatus.className = 'status-indicator status-offline';
                    musicStatus.title = '未播放';
                }
            },
            
            prev: function() {
                if (this.playlist.length === 0) return;
                
                let newIndex = this.currentIndex - 1;
                if (newIndex < 0) {
                    newIndex = this.playlist.length - 1;
                }
                
                this.play(newIndex);
            },
            
            next: function() {
                if (this.playlist.length === 0) return;
                
                let newIndex = this.currentIndex + 1;
                if (newIndex >= this.playlist.length) {
                    newIndex = 0;
                }
                
                this.play(newIndex);
            },
            
            seek: function(e) {
                if (this.currentIndex === -1) return;
                
                const progressBar = document.getElementById('progress-bar');
                const rect = progressBar.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                
                this.audio.currentTime = percent * this.audio.duration;
            },
            
            updateProgress: function() {
                const progress = document.getElementById('progress');
                const currentTime = document.getElementById('current-time');
                
                if (this.audio.duration) {
                    const percent = (this.audio.currentTime / this.audio.duration) * 100;
                    progress.style.width = `${percent}%`;
                    
                    currentTime.textContent = this.formatTime(this.audio.currentTime);
                }
            },
            
            updateTotalTime: function() {
                const duration = document.getElementById('duration');
                duration.textContent = this.formatTime(this.audio.duration);
            },
            
            formatTime: function(seconds) {
                if (isNaN(seconds)) return '0:00';
                
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            },
            
            setLoopMode: function(mode) {
                const singleBtn = document.getElementById('single-loop-btn');
                const listBtn = document.getElementById('list-loop-btn');
                  
                singleBtn.classList.remove('active');
                listBtn.classList.remove('active');
                  
                this.loopMode = mode;
                 
                if (mode === 'single') {
                    singleBtn.classList.add('active');
                } else {
                    listBtn.classList.add('active');
                }
            }
        };

        // 个性签名管理
        function saveSignature() {
            const signature = document.getElementById('desktop-signature').textContent;
            localStorage.setItem('desktopSignature', signature);
        }

        function loadSignature() {
            const savedSignature = localStorage.getItem('desktopSignature');
            if (savedSignature) {
                document.getElementById('desktop-signature').textContent = savedSignature;
            }
        }

        // 完整的聊天记录管理类，包含监听功能
        class ChatManager {
            constructor() {
                 this.messages = JSON.parse(localStorage.getItem('chatMessages')) || [];
                 this.currentEditingId = null;
                 this.listeners = []; // 监听器数组
        
                 // 代理messages数组以实现监听
                 this.messages = this.createObservableArray(this.messages);
            }           

            // 修复 createObservableArray 方法
            createObservableArray(array) {
                const self = this;
                return new Proxy(array, {
                    set(target, property, value) {
                        const result = Reflect.set(target, property, value);
                        // 触发变化监听
                         self.notifyListeners('messagesChanged', target);
                         self.saveMessages();
                         return result;
                    },
                   // 添加对数组方法的监听
                   get(target, property) {
                       const value = Reflect.get(target, property);
                       if (typeof value === 'function') {
                           return function(...args) {
                               const result = value.apply(target, args);
                               // 当调用 push, splice 等方法时触发监听
                               if (['push', 'pop', 'shift', 'unshift', 'splice'].includes(property)) {
                                  self.notifyListeners('messagesChanged', target);
                                  self.saveMessages();
                               }
                               return result;
                           };
                       }
                       return value;
                   }
               });
            }

            // 添加监听器
            addListener(event, callback) {
                 this.listeners.push({ event, callback });
            }

            // 通知监听器
            notifyListeners(event, data) {
                this.listeners.forEach(listener => {
                    if (listener.event === event) {
                        listener.callback(data);
                    }
                });
            }

            saveMessages() {
                 localStorage.setItem('chatMessages', JSON.stringify(this.messages));
            }
            
            addMessage(sender, content, type = 'text') {
                 const message = {
                      id: Date.now() + Math.random().toString(36).substr(2, 9),
                      sender: sender,
                      content: content,
                      type: type,
                      timestamp: new Date().toISOString()
                 };
                 this.messages.push(message);
                 // saveMessages() 会通过代理自动调用
                 return message;     
            }
            
            updateMessage(id, newContent) {
                 const message = this.messages.find(msg => msg.id === id);
                 if (message) {
                     message.content = newContent;
                     message.timestamp = new Date().toISOString();
                     this.saveMessages();
                     this.notifyListeners('messageUpdated', message); // 手动触发更新事件
                     return true;
                 }
                 return false;
            }
            
            deleteMessage(id) {
                const index = this.messages.findIndex(msg => msg.id === id);
                if (index !== -1) {   
                    const deletedMessage = this.messages[index];
                    this.messages.splice(index, 1);
                    // 保存到 localStorage
                    this.saveMessages();
                    this.notifyListeners('messageDeleted', deletedMessage);
                    return true;
                }
                return false;
            }

            getMessages() {
                 return [...this.messages];
            }
        }
        
        // API服务类
        class ApiService {
            constructor() {    
                this.config = JSON.parse(localStorage.getItem('apiConfig')) || {
                    provider: 'openai',
                    apiKey: '',
                    apiUrl: 'https://api.openai.com/v1',
                    model: 'gpt-3.5-turbo'
                };
            }             

            async getModels() {
                try {
                    const response = await fetch(`${this.config.apiUrl}/models`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${this.config.apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });  
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `API请求失败: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.data.map(model => model.id);
                } catch (error) {
                    console.error('获取模型列表失败:', error);
                    throw error;
                }
            }      

            async chatWithRole(rolePrompt, userMessage, temperature = 0.7) {
                if (!this.config.apiKey) {
                    throw new Error('API密钥未配置');
                }   

                // 获取AI人设和用户人设
                const aiPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}');
                const userPersona = JSON.parse(localStorage.getItem('userPersona') || '{}');
                
                // 获取激活的世界书记录
                const activeRecords = appState.worldbookManager.getActiveRecords();
                
                // 构建完整的系统提示
                let systemPrompt = rolePrompt;
                
                // 添加角色人设信息
                if (aiPersona.name || aiPersona.description) {
                    systemPrompt += `\n\n角色信息：`;
                    if (aiPersona.name) systemPrompt += `\n- 姓名：${aiPersona.name}`;
                    if (aiPersona.description) systemPrompt += `\n- 描述：${aiPersona.description}`;
                }   
                
                // 添加用户人设信息
                if (userPersona.name || userPersona.description) {
                    systemPrompt += `\n\n用户信息：`;
                    if (userPersona.name) systemPrompt += `\n- 姓名：${userPersona.name}`;
                    if (userPersona.description) systemPrompt += `\n- 描述：${userPersona.description}`;
                }
                
                // 添加世界书记录信息
                if (activeRecords.length > 0) {
                    systemPrompt += `\n\n世界书记录：`;
                    activeRecords.forEach((record, index) => {
                        systemPrompt += `\n${index + 1}. ${record.content}`;
                    });
                }

                // 获取最近9条消息作为上下文（排除当前消息）
                const allMessages = appState.chatManager.getMessages();
                // 过滤掉当前正在生成的消息，取最后9条（为当前消息留出位置）
                const recentMessages = allMessages
                    .filter(msg => msg.content !== '正在思考...' && msg.content !== userMessage)
                    .slice(-9);

                // 构建消息数组 - 包含系统提示、历史上下文
                const messages = [
                    { role: 'system', content: systemPrompt }
                ];
                
                // 添加历史消息到上下文
                recentMessages.forEach(msg => {
                    if (msg.sender === 'user') {
                        messages.push({ role: 'user', content: msg.content });
                    } else {
                        messages.push({ role: 'assistant', content: msg.content });
                    }
                });

                // 添加当前用户消息（确保不会重复）
                messages.push({ role: 'user', content: userMessage });

                console.log('发送到API的消息上下文:', messages);

                try {   
                    const response = await fetch(`${this.config.apiUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.config.apiKey}`,
                            'Content-Type': 'application/json'
                        },     
                        body: JSON.stringify({
                            model: this.config.model,
                            messages: messages,
                            temperature: temperature,
                            max_tokens: parseInt(document.getElementById('max-tokens').value) || 1000
                        })
                    });      

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API请求失败: ${errorData.error?.message || response.status}`);
                    }

                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error('API调用失败:', error);
                    throw error;
                }
            }
            
            // 新增：用于生成纯净内容的API调用方法（不带全局人设）
            async generateRawContent(systemPrompt, userPrompt, temperature = 0.8) {
                if (!this.config.apiKey) {
                    throw new Error('API密钥未配置');
                }

                // 这里不读取任何 localStorage 的人设，只使用传入的 systemPrompt (NPC设定)
                const messages = [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: userPrompt }
                ];

                try {
                    const response = await fetch(`${this.config.apiUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.config.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: this.config.model,
                            messages: messages,
                            temperature: temperature,
                            max_tokens: 500 // 微博内容不需要太长
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API请求失败: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error('API generateRawContent 调用失败:', error);
                    throw error;
                }
            }

            async testConnection() {
                try {
                    const models = await this.getModels();
                    return { success: true, models: models };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            updateConfig(newConfig) {
                this.config = { ...this.config, ...newConfig };
                localStorage.setItem('apiConfig', JSON.stringify(this.config));
            }    

            getCurrentConfig() {
                return { ...this.config };
            }
        }

        // 钱包数据管理 - 已更新实现数据持久化，包含交易记录和每月水电费缴纳限制
        const walletManager = {
            // 从localStorage加载钱包数据，如果没有则初始化
            loadWalletData: function() {
                const savedData = localStorage.getItem('walletData');
                if (savedData) {
                    return JSON.parse(savedData);
                } else {
                    // 初始化为空数据
                    return {
                        totalBalance: 0,
                        todayExpense: 0,
                        monthIncome: 0,
                        lastUtilityPayMonth: null, // 记录最后一次缴纳水电费的月份
                        transactions: [] // 交易记录数组
                    };
                }
            },
            
            // 保存钱包数据到localStorage
            saveWalletData: function() {
                localStorage.setItem('walletData', JSON.stringify(this.walletData));
            },
            
            // 钱包数据
            walletData: null,
            
            // 从localStorage加载用户选择的房型
            loadHouseType: function() {
                const savedHouseType = localStorage.getItem('userHouseType');
                return savedHouseType || "老破小、旧房"; // 默认值
            },
            
            // 保存用户选择的房型到localStorage
            saveHouseType: function(houseType) {
                localStorage.setItem('userHouseType', houseType);
            },
            
            initWallet: function() {
                // 加载钱包数据
                this.walletData = this.loadWalletData();
                
                // 更新余额信息
                document.getElementById('totalBalance').textContent = this.walletData.totalBalance.toFixed(2);
                document.getElementById('todayExpense').textContent = this.walletData.todayExpense.toFixed(2);
                document.getElementById('monthIncome').textContent = this.walletData.monthIncome.toFixed(2);
                
                // 渲染交易记录
                this.renderTransactions();
            },
            
            // 渲染交易记录
            renderTransactions: function() {
                const transactionList = document.getElementById('transaction-list');
                
                if (this.walletData.transactions.length === 0) {
                    transactionList.innerHTML = '<div class="empty-state"><p>暂无交易记录</p><p style="font-size: 0.8em; margin-top: 10px; color: #999;">所有消费和收入将在这里显示</p></div>';
                    return;
                }
                
                // 按日期倒序排列交易记录
                const sortedTransactions = [...this.walletData.transactions].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                
                transactionList.innerHTML = '';
                
                sortedTransactions.forEach(transaction => {
                    const transactionElement = document.createElement('div');
                    transactionElement.className = 'transaction-item';
                    
                    const amountClass = transaction.type === 'expense' ? 'transaction-expense' : 'transaction-income';
                    const amountPrefix = transaction.type === 'expense' ? '-' : '+';
                    
                    transactionElement.innerHTML = `
                        <div class="transaction-info">
                            <div class="transaction-title">${transaction.description}</div>
                            <div class="transaction-date">${this.formatDate(transaction.date)}</div>
                        </div>
                        <div class="transaction-amount ${amountClass}">${amountPrefix}¥${transaction.amount.toFixed(2)}</div>
                    `;
                    
                    transactionList.appendChild(transactionElement);
                });
            },
            
            // 格式化日期
            formatDate: function(dateString) {
                const date = new Date(dateString);
                return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            },
            
            // 添加交易记录
            addTransaction: function(type, amount, description) {
                const transaction = {
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    type: type,
                    amount: amount,
                    description: description,
                    date: new Date().toISOString()
                };
                
                this.walletData.transactions.push(transaction);
                this.saveWalletData();
                this.renderTransactions();
            },
            
            setupEventListeners: function() {
                // 充值按钮点击事件
                document.getElementById('rechargeBtn').addEventListener('click', function() {
                    document.getElementById('rechargeModal').style.display = 'flex';
                    document.getElementById('rechargeAmount').focus();
                });

                // 关闭弹窗按钮
                document.getElementById('closeModal').addEventListener('click', function() {
                    document.getElementById('rechargeModal').style.display = 'none';
                    document.getElementById('rechargeAmount').value = '';
                });

                // 确认充值按钮
                document.getElementById('confirmRecharge').addEventListener('click', function() {
                    const amountInput = document.getElementById('rechargeAmount');
                    const amount = parseFloat(amountInput.value);
                    
                    if (isNaN(amount) || amount <= 0) {
                        alert('请输入有效的充值金额！');
                        amountInput.focus();
                        return;
                    }

                    // 执行充值操作
                    walletManager.recharge(amount);
                });

                // 点击弹窗外部关闭
                document.getElementById('rechargeModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                        document.getElementById('rechargeAmount').value = '';
                    }
                });

                // 按Enter键确认充值
                document.getElementById('rechargeAmount').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        document.getElementById('confirmRecharge').click();
                    }
                });

                // 水电费按钮点击事件
                document.getElementById('utilityBtn').addEventListener('click', function() {
                    walletManager.openUtilityModal();
                });

                // 关闭水电费弹窗按钮
                document.getElementById('closeUtilityModal').addEventListener('click', function() {
                    document.getElementById('utilityModal').style.display = 'none';
                });

                // 确认缴纳水电费按钮
                document.getElementById('confirmUtility').addEventListener('click', function() {
                    walletManager.payUtility();
                });

                // 点击水电费弹窗外部关闭
                document.getElementById('utilityModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });

                // 监听房型选择变化
                document.getElementById('houseTypeSelect').addEventListener('change', function() {
                    walletManager.updateUtilityPrices();
                });
            },
            
            // 充值功能 - 充值不被记录
            recharge: function(amount) {
                // 更新总余额
                this.walletData.totalBalance += amount;
                document.getElementById('totalBalance').textContent = this.walletData.totalBalance.toFixed(2);
                
                // 注意：充值不被记录到交易记录中
                // 手机充值只增加余额，不产生交易记录

                // 保存数据到localStorage
                this.saveWalletData();
                
                // 关闭弹窗并清空输入
                document.getElementById('rechargeModal').style.display = 'none';
                document.getElementById('rechargeAmount').value = '';
                
                // 显示成功消息
                alert(`成功充值 ${amount.toFixed(2)} 元！`);
            },
            
            // 打开水电费弹窗
            openUtilityModal: function() {
                // 获取用户房型
                const houseType = this.loadHouseType();
                
                // 设置下拉框的当前值
                document.getElementById('houseTypeSelect').value = houseType;
                
                // 更新水电费价格
                this.updateUtilityPrices();
                
                // 显示弹窗
                document.getElementById('utilityModal').style.display = 'flex';
            },
            
            // 更新水电费价格显示
            updateUtilityPrices: function() {
                const selectedHouseType = document.getElementById('houseTypeSelect').value;
                const prices = utilityPrices[selectedHouseType] || utilityPrices["老破小、旧房"];
                
                // 更新弹窗内容
                document.getElementById('utility-house-type').textContent = selectedHouseType;
                document.getElementById('utility-water').textContent = `${prices.water.toFixed(2)} 元`;
                document.getElementById('utility-electricity').textContent = `${prices.electricity.toFixed(2)} 元`;
                document.getElementById('utility-total').textContent = `${(prices.water + prices.electricity).toFixed(2)} 元`;
            },
            
            // 检查本月是否已缴纳水电费
            hasPaidUtilityThisMonth: function() {
                if (!this.walletData.lastUtilityPayMonth) {
                    return false;
                }
                
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const lastPayMonth = new Date(this.walletData.lastUtilityPayMonth).getMonth();
                const lastPayYear = new Date(this.walletData.lastUtilityPayMonth).getFullYear();
                
                return currentMonth === lastPayMonth && currentYear === lastPayYear;
            },
            
            // 缴纳水电费
            payUtility: function() {
                // 检查本月是否已缴纳水电费
                if (this.hasPaidUtilityThisMonth()) {
                    alert('本月水电费已经缴纳过了，下个月再来吧！');
                    document.getElementById('utilityModal').style.display = 'none';
                    return;
                }
                
                const selectedHouseType = document.getElementById('houseTypeSelect').value;
                const prices = utilityPrices[selectedHouseType] || utilityPrices["老破小、旧房"];
                const totalAmount = prices.water + prices.electricity;
                
                // 检查余额是否足够
                if (this.walletData.totalBalance < totalAmount) {
                    alert('余额不足，无法缴纳水电费！');
                    return;
                }
                
                // 扣除水电费
                this.walletData.totalBalance -= totalAmount;
                document.getElementById('totalBalance').textContent = this.walletData.totalBalance.toFixed(2);
                
                // 更新今日支出
                this.walletData.todayExpense += totalAmount;
                document.getElementById('todayExpense').textContent = this.walletData.todayExpense.toFixed(2);
                
                // 记录最后一次缴纳水电费的月份
                this.walletData.lastUtilityPayMonth = new Date().toISOString();
                
                // 添加水电费交易记录
                this.addTransaction('expense', totalAmount, `${selectedHouseType}水电费`);
                
                // 保存选择的房型
                this.saveHouseType(selectedHouseType);
                
                // 保存数据
                this.saveWalletData();
                
                // 关闭弹窗
                document.getElementById('utilityModal').style.display = 'none';
                
                // 显示成功消息
                alert(`成功缴纳水电费 ${totalAmount.toFixed(2)} 元！`);
            }
        };

        // 微博功能实现 - 修改后的版本（修复吃瓜角色逻辑）
        const weiboManager = {
            categories: JSON.parse(localStorage.getItem('weiboCategories')) || [
                '科技', '生活', '娱乐', '体育', '财经', '美食', '旅行', '数码', '恐怖'
            ],
            
            weibos: JSON.parse(localStorage.getItem('weibos')) || [],
            
            userProfile: JSON.parse(localStorage.getItem('weiboUserProfile')) || {
                name: '微博用户',
                bio: '这个人很懒，什么都没有写...',
                persona: '普通用户',
                location: '',
                followers: 0,
                following: 0
            },
            
            // 增加两组网友：中性角色组和吃瓜角色组
            neutralNPCs: [
                { name: '网友A', description: '中性化角色，根据题材发动态' },
                { name: '网友B', description: '中性化角色，根据题材发动态' },
                { name: '网友C', description: '中性化角色，根据题材发动态' },
                { name: '网友D', description: '中性化角色，根据题材发动态' },
                { name: '网友E', description: '中性化角色，根据题材发动态' },
                { name: '网友F', description: '中性化角色，根据题材发动态' },
                { name: '网友G', description: '中性化角色，根据题材发动态' },
                { name: '网友H', description: '中性化角色，根据题材发动态' },
                { name: '网友I', description: '中性化角色，根据题材发动态' },
                { name: '网友J', description: '中性化角色，根据题材发动态' },
                { name: '网友K', description: '中性化角色，根据题材发动态' },
                { name: '网友L', description: '中性化角色，根据题材发动态' },
                { name: '网友M', description: '中性化角色，根据题材发动态' },
                { name: '网友N', description: '中性化角色，根据题材发动态' },
                { name: '网友O', description: '中性化角色，根据题材发动态' },
                { name: '网友P', description: '中性化角色，根据题材发动态' },
                { name: '网友Q', description: '中性化角色，根据题材发动态' },
                { name: '网友R', description: '中性化角色，根据题材发动态' },
                { name: '网友S', description: '中性化角色，根据题材发动态' },
                { name: '网友T', description: '中性化角色，根据题材发动态' },
                { name: '网友U', description: '中性化角色，根据题材发动态' },
                { name: '网友V', description: '中性化角色，根据题材发动态' },
                { name: '网友W', description: '中性化角色，根据题材发动态' },
                { name: '网友X', description: '中性化角色，根据题材发动态' },
                { name: '网友Y', description: '中性化角色，根据题材发动态' },
                { name: '网友Z', description: '中性化角色，根据题材发动态' }
            ],
            
            // 新增：第二组网友（吃瓜角色组）
            fanNPCs: [
                { name: '网友A', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友B', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友C', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友D', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友E', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友F', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友G', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友H', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友I', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友J', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友K', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友L', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友M', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友N', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友O', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友P', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友Q', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友R', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友S', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友T', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友U', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友V', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友W', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友X', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友Y', description: '吃瓜角色，围绕用户和角色发动态' },
                { name: '网友Z', description: '吃瓜角色，围绕用户和角色发动态' }
            ],
            
            trendingTopics: [
                { name: '#AI技术分享#', posts: '12.3万', trend: '上升' },
                { name: '#日常生活#', posts: '8.7万', trend: '热门' },
                { name: '#数码新品#', posts: '15.6万', trend: '新' },
                { name: '#旅行日记#', posts: '23.1万', trend: '上升' },
                { name: '#美食探索#', posts: '18.9万', trend: '热门' },
                { name: '#财经新闻#', posts: '31.2万', trend: '爆款' },
                { name: '#体育赛事#', posts: '5.4万', trend: '新' },
                { name: '#娱乐八卦#', posts: '7.8万', trend: '上升' },
                { name: '#恐怖故事#', posts: '9.2万', trend: '新' }
            ],
            
            quotes: [
                "生活就像一盒巧克力，你永远不知道下一颗是什么味道。",
                "成功不是将来才有的，而是从决定去做的那一刻起，持续累积而成。",
                "世界上最遥远的距离，是我在你面前，你却不知道我爱你。",
                "人生没有彩排，每一天都是现场直播。",
                "梦想还是要有的，万一实现了呢？",
                "活在当下，珍惜眼前人。",
                "夜晚的黑暗总是隐藏着不为人知的秘密...",
                "有时候，最恐怖的不是鬼怪，而是人心。"
            ],
            
            dynamicConfig: {
                userWeiboFrequency: 0, // 用户不自动发
                maxUserWeibosPerRefresh: 0, 
            },
            
            // 身份关键词映射
            identityKeywords: {
                // 娱乐身份关键词
                entertainment: ['明星', '演员', '歌手', '偶像', '艺人', '巨星', '歌星', '影星', '娱乐圈', '演艺圈', '娱乐'],
                // 刑侦身份关键词
                detective: ['法医', '警察', '侦探', '刑侦', '案件', '尸体', '刑警', '警探', '犯罪', '侦查'],
                // 科技身份关键词
                tech: ['程序员', '工程师', '科学家', '研究员', '技术', '开发', '编程', '码农', 'IT'],
                // 医疗身份关键词
                medical: ['医生', '护士', '医疗', '医学', '医院', '诊所', '医师', '治疗'],
                // 教育身份关键词
                education: ['老师', '教师', '教授', '教育', '学校', '学生', '教学'],
                // 其他身份可以继续添加
            },
            
            // 分类与身份映射关系
            categoryIdentityMap: {
                '娱乐': 'entertainment',
                '科技': 'tech',
                '数码': 'tech',
                '恐怖': 'detective',
                '刑侦': 'detective',
                '案件': 'detective',
                '医疗': 'medical',
                '教育': 'education'
                // 其他分类可以继续添加
            },
            
            dynamicContent: {
                topics: {
                    tech: ['人工智能', '编程技巧', '科技新闻', '数码产品', '软件开发', '手机评测', '未来科技', '黑客技术', '显卡性能', '芯片制程'],
                    life: ['日常生活', '心情分享', '美食体验', '旅行见闻', '读书感悟', '健康养生', '宠物日常', '周末时光', '装修心得', '穿搭分享'],
                    entertainment: ['电影推荐', '音乐分享', '游戏体验', '明星八卦', '综艺节目', '电视剧', '动漫番剧', '演唱会现场', '新剧定档', '红毯造型'],
                    sports: ['体育赛事', '健身心得', '运动技巧', '球队动态', '运动员风采', '比赛结果', '极限运动', '马拉松', '瑜伽打卡'],
                    finance: ['投资心得', '经济新闻', '理财技巧', '市场分析', '商业洞察', '股票基金', '加密货币', '楼市动态', '黄金走势'],
                    horror: ['恐怖故事', '灵异事件', '悬疑推理', '惊悚体验', '鬼怪传说', '恐怖电影', '都市怪谈', '午夜惊魂', '细思极恐', '规则怪谈']
                },
                
                categoryToTopicMap: {
                    '科技': 'tech', '数码': 'tech', '互联网': 'tech', '软件': 'tech',
                    '生活': 'life', '美食': 'life', '旅行': 'life', '情感': 'life', '时尚': 'life', '日常': 'life', '摄影': 'life',
                    '娱乐': 'entertainment', '娱乐圈': 'entertainment', '明星': 'entertainment', '影视': 'entertainment', '游戏': 'entertainment', '动漫': 'entertainment',
                    '体育': 'sports', '运动': 'sports', '健身': 'sports',
                    '财经': 'finance', '金融': 'finance', '基金': 'finance', '股票': 'finance',
                    '恐怖': 'horror', '灵异': 'horror', '悬疑': 'horror', '怪谈': 'horror'
                },
                
                topicStyles: {
                    'horror': '语气必须令人感到绝望、恐惧、阴森、不安、毛骨悚然。侧重于心理恐怖或未知的恐惧。绝对不要搞笑。',
                    'life': '语气必须温馨、治愈、积极向上、充满生活气息、轻松愉快。',
                    'tech': '语气必须专业、理性、对未来科技充满向往、强调先进性、硬核。',
                    'entertainment': '语气八卦、兴奋、或者犀利点评，充满娱乐精神，可以使用饭圈用语。',
                    'sports': '语气热血、充满激情、强调拼搏精神和竞技状态。',
                    'finance': '语气严谨、客观、分析透彻、关注利益和风险。',
                    'default': '语气符合该话题的常规社交媒体风格。'
                },
                
                emojis: ['😊', '😂', '❤️', '👍', '🔥', '⭐', '🙏', '🎉', '💡', '👏', '🎮', '📚', '✈️', '🍕', '☕', '😭', '🥰'],
                
                horrorEmojis: ['😨', '👻', '💀', '🕯️', '🌑', '🕷️', '🦇', '⚰️', '🩸', '👁️', '🧟', '🧛'],
                
                // 修改：优化吃瓜角色生成逻辑
                generateNPCWeibo: async function(category = null) {
                    // 获取角色信息（原AI角色人设）
                    const aiPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}');
                    // 获取用户人设信息
                    const userPersona = JSON.parse(localStorage.getItem('userPersona') || '{}');
                    
                    // 使用角色姓名和用户姓名，如果没有则使用默认值
                    const roleName = aiPersona.name || '某人';
                    const userName = userPersona.name || '某人';
                    
                    // 检查人设描述中的身份信息
                    const aiIdentity = this.extractIdentity(aiPersona.description || '');
                    const userIdentity = this.extractIdentity(userPersona.description || '');
                    
                    // 检查当前分类是否与身份匹配
                    const categoryIdentity = weiboManager.categoryIdentityMap[category] || null;
                    
                    // 检查是否可以提及角色或用户
                    const canMentionRole = aiIdentity && categoryIdentity && this.isIdentityMatch(aiIdentity, categoryIdentity);
                    const canMentionUser = userIdentity && categoryIdentity && this.isIdentityMatch(userIdentity, categoryIdentity);
                    
                    // 随机选择角色类型：中性角色、吃瓜角色、角色人设
                    const roleType = Math.random();
                    let username, userBio, isChatCharacter = false, isFanRole = false;
                    
                    // 10%的概率使用角色人设发帖（如果角色人设已设置且身份匹配当前分类）
                    if (aiPersona.name && aiPersona.description && roleType < 0.1 && canMentionRole) {
                        username = aiPersona.name;
                        userBio = aiPersona.description;
                        isChatCharacter = true;
                    } 
                    // 30%的概率使用吃瓜角色（只有身份匹配当前分类时才使用吃瓜角色）
                    else if (roleType < 0.4 && (canMentionRole || canMentionUser)) {
                        isFanRole = true;
                        // 从吃瓜角色组中随机选择
                        const fanNPC = weiboManager.fanNPCs[Math.floor(Math.random() * weiboManager.fanNPCs.length)];
                        username = fanNPC.name;
                        userBio = fanNPC.description;
                    }
                    // 60%的概率使用中性角色
                    else {
                        // 从中性角色组中随机选择
                        const neutralNPC = weiboManager.neutralNPCs[Math.floor(Math.random() * weiboManager.neutralNPCs.length)];
                        username = neutralNPC.name;
                        userBio = neutralNPC.description;
                    }
                    
                    let topic = null;
                    
                    // 1. 尝试精确映射
                    if (category && this.categoryToTopicMap[category]) {
                        topic = this.categoryToTopicMap[category];
                    }
                    
                    // 2. 尝试模糊匹配 (如果精确映射失败且category存在)
                    if (!topic && category) {
                        if (category.includes('娱乐') || category.includes('影') || category.includes('星') || category.includes('剧')) topic = 'entertainment';
                        else if (category.includes('科') || category.includes('数') || category.includes('网')) topic = 'tech';
                        else if (category.includes('恐') || category.includes('鬼') || category.includes('灵') || category.includes('怪')) topic = 'horror';
                        else if (category.includes('财') || category.includes('金') || category.includes('股')) topic = 'finance';
                        else if (category.includes('体') || category.includes('动') || category.includes('球')) topic = 'sports';
                        else topic = 'life'; // 安全回退：无法识别的分类默认视为生活类
                    }
                    
                    const topicCategories = Object.keys(this.topics);
                    let selectedTopic;
                    
                    if (topic) {
                        selectedTopic = topic;
                    } else {
                        // 如果没有指定分类（即"全部"），则随机选择
                        selectedTopic = topicCategories[Math.floor(Math.random() * topicCategories.length)];
                    }

                    const topicItems = this.topics[selectedTopic];
                    const randomTopicItem = topicItems[Math.floor(Math.random() * topicItems.length)];
                    
                    const styleInstruction = this.topicStyles[selectedTopic] || this.topicStyles['default'];
                    
                    // 构建不同的提示词
                    let contextPrompt = "";
                    let specialInstructions = "";
                    
                    if (isChatCharacter) {
                        // 角色人设：使用自己的角色设定
                        contextPrompt = `角色设定：${userBio}\n`;
                        specialInstructions = `以${username}的身份发布关于"${randomTopicItem}"的微博。`;
                    } else if (isFanRole) {
                        // 吃瓜角色：只有在身份匹配时才提及角色或用户
                        const fanTypes = [];
                        
                        if (canMentionRole) {
                            fanTypes.push(`单独讨论${roleName}的人设`);
                            fanTypes.push(`作为${roleName}的崇拜者/粉丝`);
                            fanTypes.push(`评论${roleName}的最新动态`);
                        }
                        
                        if (canMentionUser) {
                            fanTypes.push(`单独讨论${userName}的人设`);
                            fanTypes.push(`作为${userName}的崇拜者/粉丝`);
                            fanTypes.push(`评论${userName}的最新动态`);
                        }
                        
                        if (canMentionRole && canMentionUser) {
                            fanTypes.push(`吃${roleName}和${userName}的瓜`);
                            fanTypes.push(`评论${roleName}和${userName}的关系`);
                        }
                        
                        // 如果没有合适的提及方式，则使用中性话题
                        if (fanTypes.length === 0) {
                            specialInstructions = `以${username}的身份，发布关于"${randomTopicItem}"的微博。`;
                        } else {
                            const fanType = fanTypes[Math.floor(Math.random() * fanTypes.length)];
                            contextPrompt = `角色设定：${userBio}\n`;
                            specialInstructions = `以${username}的身份，${fanType}，发布关于"${randomTopicItem}"的微博。`;
                        }
                    } else {
                        // 中性角色：根据题材发动态
                        contextPrompt = `角色设定：${userBio}\n`;
                        specialInstructions = `以${username}的身份，发布关于"${randomTopicItem}"的微博。`;
                    }

                    const prompt = `
                    任务：${specialInstructions}
                    ${contextPrompt}
                    情感基调/风格要求：${styleInstruction}
                    其他要求：
                    1. 字数控制在140字以内。
                    2. 直接输出内容，不要包含解释。
                    `;
                    
                    const neutralPersona = isChatCharacter ? userBio : `你是一个名为"${username}"的社交媒体用户，${userBio}`;

                    try {
                        const content = await appState.apiService.generateRawContent(
                            neutralPersona, 
                            prompt,         
                            0.8
                        );
                        
                        return {
                            content: this.cleanContent(content),
                            username: username,
                            userBio: userBio,
                            isChatCharacter: isChatCharacter,
                            isFanRole: isFanRole
                        };
                    } catch (error) {
                        console.error('生成NPC微博内容失败:', error);
                        return {
                            content: this.generateFallbackContent(randomTopicItem, selectedTopic),
                            username: username,
                            userBio: userBio,
                            isChatCharacter: isChatCharacter,
                            isFanRole: isFanRole
                        };
                    }
                },
                
                // 从人设描述中提取身份信息
                extractIdentity: function(description) {
                    const desc = description.toLowerCase();
                    
                    for (const [identity, keywords] of Object.entries(weiboManager.identityKeywords)) {
                        for (const keyword of keywords) {
                            if (desc.includes(keyword.toLowerCase())) {
                                return identity;
                            }
                        }
                    }
                    
                    return null;
                },
                
                // 检查身份是否匹配分类
                isIdentityMatch: function(identity, categoryIdentity) {
                    // 如果身份和分类身份完全匹配
                    if (identity === categoryIdentity) {
                        return true;
                    }
                    
                    // 特殊匹配规则
                    const specialMatches = {
                        'detective': ['horror'], // 刑侦身份可以在恐怖分类中提及
                        'entertainment': ['life'], // 娱乐身份可以在生活分类中提及
                        'tech': ['finance'] // 科技身份可以在财经分类中提及
                    };
                    
                    if (specialMatches[identity] && specialMatches[identity].includes(categoryIdentity)) {
                        return true;
                    }
                    
                    return false;
                },
                
                generateFallbackContent: function(topic, topicType = 'default') {
                    if (topicType === 'horror') {
                        const horrorTemplates = [
                            `昨晚遇到了关于${topic}的怪事，现在想想还后背发凉... ${this.getRandomHorrorEmojis()}`,
                            `分享一个${topic}的真实经历，大家晚上不要独自看！${this.getRandomHorrorEmojis()}`,
                            `刚刚经历了${topic}，吓得我到现在还不敢关灯睡觉 ${this.getRandomHorrorEmojis()}`,
                            `关于${topic}，我有一个毛骨悚然的故事要讲... ${this.getRandomHorrorEmojis()}`,
                            `被${topic}吓到了！现在听到任何声音都心惊胆战 ${this.getRandomHorrorEmojis()}`
                        ];
                        return horrorTemplates[Math.floor(Math.random() * horrorTemplates.length)];
                    } else if (topicType === 'life') {
                         const lifeTemplates = [
                            `今天${topic}真的太治愈了，感觉生活充满了阳光 ${this.getRandomEmojis()}`,
                            `简单的快乐：${topic}，希望能一直这样温馨下去。`,
                            `分享今日份的小确幸：${topic}。`,
                            `生活不仅有眼前的苟且，还有${topic}。`
                        ];
                        return lifeTemplates[Math.floor(Math.random() * lifeTemplates.length)];
                    } else {
                        const templates = [
                            `今天遇到了关于${topic}的有趣事情，感觉挺有意思的 🎉`,
                            `分享一下我对${topic}的看法，大家觉得呢？${this.getRandomEmojis()}`,
                            `刚刚体验了${topic}，感觉还不错！推荐给大家 👍`,
                            `关于${topic}，我有一个小技巧要分享 💡`,
                            `被${topic}惊艳到了！强烈安利 ${this.getRandomEmojis()}`
                        ];
                        return templates[Math.floor(Math.random() * templates.length)];
                    }
                },
                
                getRandomHorrorEmojis: function() {
                    const count = Math.floor(Math.random() * 2) + 1;
                    let result = '';
                    for (let i = 0; i < count; i++) {
                        result += this.horrorEmojis[Math.floor(Math.random() * this.horrorEmojis.length)];
                    }
                    return result;
                },
                
                cleanContent: function(content) {
                    return content.replace(/^["']|["']$/g, '')
                                 .replace(/^(这是一条|我生成|我写|我创作|我发布|这是一张|这是一段|这是一个)/g, '')
                                 .replace(/^(关于|今天|刚刚|最近)/g, '')
                                 .trim();
                },
                
                getRandomEmojis: function() {
                    const count = Math.floor(Math.random() * 2) + 1;
                    let result = '';
                    for (let i = 0; i < count; i++) {
                        result += this.emojis[Math.floor(Math.random() * this.emojis.length)];
                    }
                    return result;
                },
                
                generateTimestamp: function(daysAgo = 0) {
                    if (daysAgo > 0) {
                        return `${daysAgo}天前`;
                    }
                    const now = new Date();
                    const hoursAgo = Math.floor(Math.random() * 24);
                    const minutesAgo = Math.floor(Math.random() * 60);
                    
                    if (hoursAgo > 0) {
                        return `${hoursAgo}小时前`;
                    } else if (minutesAgo > 0) {
                        return `${minutesAgo}分钟前`;
                    } else {
                        return '刚刚';
                    }
                }
            },
            
            getRandomNPCPersona: function() {
                // 随机选择中性角色或吃瓜角色
                const isFanRole = Math.random() < 0.5;
                const npcList = isFanRole ? this.fanNPCs : this.neutralNPCs;
                const index = Math.floor(Math.random() * npcList.length);
                return npcList[index];
            },
            
            // 修复：使用 generateRawContent
            generateComment: async function(weiboContent) {
                // 评论者也是随机网友
                const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
                const randomLetter = letters[Math.floor(Math.random() * letters.length)];
                const username = `网友${randomLetter}`;
                
                const prompt = `针对以下微博内容写一条评论，直接输出评论内容，不要提及生成过程，不要使用引号，不要解释，像真人评论一样。微博内容：${weiboContent}`;
                
                try {
                    const content = await appState.apiService.generateRawContent(
                        "你是一个普通的社交媒体用户。",
                        prompt,
                        0.7
                    );
                    return this.dynamicContent.cleanContent(content);
                } catch (error) {
                    console.error('生成评论失败:', error);
                    const fallbackComments = [
                        '说得好！', '很有意思！', '点赞！', '收藏了！', '转发啦！', '期待更多分享！', '太吓人了！', '这个经历跟我好像！'
                    ];
                    return fallbackComments[Math.floor(Math.random() * fallbackComments.length)];
                }
            },
            
            currentCategory: '',
            currentWeiboId: null,
            currentDeletingWeiboId: null,
            
            init: function() {
                this.renderCategoryTags();
                this.renderCategoryList();
                this.renderCategorySelect();
                this.loadUserProfile();
                this.switchPage('home');
                this.bindEvents();
                this.renderWeiboList();
                this.renderDiscoverPage();
                this.updateUserAvatar();
                
                // 绑定微博删除确认对话框
                this.bindDeleteDialogEvents();
            },
            
            // 绑定微博删除确认对话框事件
            bindDeleteDialogEvents: function() {
                document.getElementById('confirm-weibo-delete-btn').addEventListener('click', () => {
                    this.confirmDeleteWeibo();
                });
                
                document.getElementById('cancel-weibo-delete-btn').addEventListener('click', () => {
                    this.cancelDeleteWeibo();
                });
            },
            
            // 删除微博
            deleteWeibo: function(weiboId) {
                const index = this.weibos.findIndex(w => w.id === weiboId);
                if (index !== -1) {
                    this.weibos.splice(index, 1);
                    localStorage.setItem('weibos', JSON.stringify(this.weibos));
                    this.renderWeiboList();
                    this.loadUserProfile(); // 更新微博数量
                    return true;
                }
                return false;
            },
            
            // 显示删除确认对话框
            showDeleteWeiboConfirm: function(weiboId) {
                this.currentDeletingWeiboId = weiboId;
                document.getElementById('weibo-delete-dialog').style.display = 'flex';
            },
            
            // 确认删除微博
            confirmDeleteWeibo: function() {
                if (this.currentDeletingWeiboId) {
                    this.deleteWeibo(this.currentDeletingWeiboId);
                    document.getElementById('weibo-delete-dialog').style.display = 'none';
                    this.currentDeletingWeiboId = null;
                }
            },
            
            // 取消删除微博
            cancelDeleteWeibo: function() {
                document.getElementById('weibo-delete-dialog').style.display = 'none';
                this.currentDeletingWeiboId = null;
            },
            
            updateUserAvatar: function() {
                const userAvatar = document.getElementById('weiboUserAvatar');
                if (userAvatar) {
                    userAvatar.textContent = this.userProfile.name.charAt(0);
                }
            },
            
            // 移除 loadChatCharacterProfile 和 saveChatCharacterProfile 方法
            
            loadDynamicWeibos: async function() {
                const weiboList = document.getElementById('weiboList');
                weiboList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">正在加载动态内容...</div>';
                
                const newWeibos = [];
                const totalPostsToGenerate = 3; // 每次只生成3条，严格限制
                
                for (let i = 0; i < totalPostsToGenerate; i++) {
                    try {
                        const npcWeibo = await this.dynamicContent.generateNPCWeibo(this.currentCategory);
                        const newWeibo = {
                            id: Date.now() + i,
                            username: npcWeibo.username,
                            content: npcWeibo.content,
                            timestamp: this.dynamicContent.generateTimestamp(Math.floor(Math.random() * 3)), // 随机0-2天前
                            category: this.currentCategory || this.getRandomCategory(),
                            likes: Math.floor(Math.random() * 50),
                            comments: Math.floor(Math.random() * 20),
                            reposts: Math.floor(Math.random() * 15),
                            commentsList: this.generateRandomComments(),
                            userBio: npcWeibo.userBio,
                            isLiked: false,
                            isChatCharacter: npcWeibo.isChatCharacter || false,
                            isFanRole: npcWeibo.isFanRole || false
                        };
                        
                        if (newWeibo) {
                            newWeibos.push(newWeibo);
                        }
                    } catch (error) {
                        console.error('生成微博失败:', error);
                    }
                }
                
                // 将新微博按时间排序（模拟）并添加到列表顶部
                this.weibos = [...newWeibos, ...this.weibos];
                localStorage.setItem('weibos', JSON.stringify(this.weibos));
                this.renderWeiboList();
            },
            
            getRandomCategory: function() {
                const categories = this.categories.length > 0 ? this.categories : ['科技', '生活', '娱乐', '恐怖'];
                return categories[Math.floor(Math.random() * categories.length)];
            },
            
            generateRandomComments: function() {
                const comments = [];
                const count = Math.floor(Math.random() * 3);
                const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
                
                for(let i=0; i<count; i++) {
                    const randomLetter = letters[Math.floor(Math.random() * letters.length)];
                    comments.push({
                        user: `网友${randomLetter}`,
                        content: '很有意思！', // 简化评论内容，实际可扩展
                        time: '1小时前'
                    });
                }
                return comments;
            },
            
            // 修复：使用动态创建元素，解决"全部"按钮点击无效问题
            renderCategoryTags: function() {
                const categoryTags = document.getElementById('weiboCategoryTags');
                categoryTags.innerHTML = '';
                
                const allTag = document.createElement('div');
                allTag.className = `weibo-category-tag ${this.currentCategory === '' ? 'active' : ''}`;
                allTag.textContent = '全部';
                allTag.setAttribute('data-category', '');
                allTag.addEventListener('click', () => this.filterByCategory(''));
                categoryTags.appendChild(allTag);
                
                this.categories.forEach(category => {
                    const tag = document.createElement('div');
                    tag.className = `weibo-category-tag ${this.currentCategory === category ? 'active' : ''}`;
                    tag.textContent = category;
                    tag.setAttribute('data-category', category);
                    tag.addEventListener('click', () => this.filterByCategory(category));
                    categoryTags.appendChild(tag);
                });
            },
            
            renderCategoryList: function() {
                const categoryList = document.getElementById('weiboCategoryList');
                categoryList.innerHTML = '';
                
                this.categories.forEach(category => {
                    const item = document.createElement('div');
                    item.className = 'weibo-category-item';
                    item.innerHTML = `
                        <span>${category}</span>
                        <button class="weibo-delete-category" data-category="${category}">删除</button>
                    `;
                    categoryList.appendChild(item);
                });
                
                document.querySelectorAll('.weibo-delete-category').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const categoryToDelete = e.target.getAttribute('data-category');
                        this.deleteCategory(categoryToDelete);
                    });
                });
            },
            
            renderCategorySelect: function() {
                const categorySelect = document.getElementById('weiboCategorySelect');
                categorySelect.innerHTML = '<option value="">选择分类</option>';
                
                this.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            },
            
            // 修复：点赞状态逻辑
            renderWeiboList: function() {
                const weiboList = document.getElementById('weiboList');
                weiboList.innerHTML = '';
                
                const filteredWeibos = this.currentCategory 
                    ? this.weibos.filter(weibo => weibo.category === this.currentCategory)
                    : this.weibos;
                
                if (filteredWeibos.length === 0) {
                    weiboList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">暂无微博内容，点击"刷新动态"按钮加载内容</div>';
                    return;
                }
                
                filteredWeibos.forEach(weibo => {
                    if (typeof weibo.isLiked === 'undefined') {
                        weibo.isLiked = false;
                    }

                    const weiboItem = document.createElement('div');
                    weiboItem.className = 'weibo-item';
                    const likeClass = weibo.isLiked ? 'like-btn liked' : 'like-btn';

                    // 修改头像显示逻辑：如果是角色人设，显示角色名字首字母
                    let avatarLetter = weibo.username.charAt(0);
                    if (weibo.username.startsWith('网友')) {
                        avatarLetter = weibo.username.replace('网友', '');
                    }

                    // 检查是否是用户自己的微博
                    const isUserWeibo = weibo.username === this.userProfile.name;
                    
                    weiboItem.innerHTML = `
                        <div class="weibo-avatar">${avatarLetter}</div>
                        <div class="weibo-content">
                            <div class="weibo-item-header">
                                <span class="weibo-username">${weibo.username}</span>
                                ${weibo.category ? `<span class="weibo-item-category">${weibo.category}</span>` : ''}
                                <span class="weibo-timestamp">${weibo.timestamp}</span>
                            </div>
                            <div class="weibo-item-text">${weibo.content}</div>
                            <div class="weibo-item-actions">
                                <button class="repost-btn">转发 ${weibo.reposts}</button>
                                <button class="comment-btn" data-weibo-id="${weibo.id}">评论 ${weibo.comments}</button>
                                <button class="${likeClass}" data-weibo-id="${weibo.id}">点赞 ${weibo.likes}</button>
                                <button class="delete-btn" data-weibo-id="${weibo.id}">删除</button>
                            </div>
                        </div>
                    `;
                    weiboList.appendChild(weiboItem);
                });
                
                // 绑定点赞按钮事件
                document.querySelectorAll('.like-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const weiboId = parseInt(this.getAttribute('data-weibo-id'));
                        const weibo = weiboManager.weibos.find(w => w.id === weiboId);
                        
                        if (weibo) {
                            if (weibo.isLiked) {
                                weibo.likes = Math.max(0, weibo.likes - 1);
                                weibo.isLiked = false;
                                this.classList.remove('liked');
                            } else {
                                weibo.likes += 1;
                                weibo.isLiked = true;
                                this.classList.add('liked');
                            }
                            this.textContent = `点赞 ${weibo.likes}`;
                            localStorage.setItem('weibos', JSON.stringify(weiboManager.weibos));
                        }
                    });
                });
                
                // 绑定评论按钮事件
                document.querySelectorAll('.comment-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const weiboId = parseInt(this.getAttribute('data-weibo-id'));
                        weiboManager.openCommentModal(weiboId);
                    });
                });
                
                // 绑定转发按钮事件
                document.querySelectorAll('.repost-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const weiboId = parseInt(this.closest('.weibo-item').querySelector('.comment-btn').getAttribute('data-weibo-id'));
                        const weibo = weiboManager.weibos.find(w => w.id === weiboId);
                        if (weibo) {
                            weibo.reposts += 1;
                            localStorage.setItem('weibos', JSON.stringify(weiboManager.weibos));
                            this.textContent = `转发 ${weibo.reposts}`;
                            alert('转发成功！');
                        }
                    });
                });
                
                // 绑定删除按钮事件
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const weiboId = parseInt(this.getAttribute('data-weibo-id'));
                        weiboManager.showDeleteWeiboConfirm(weiboId);
                    });
                });
            },
            
            openCommentModal: function(weiboId) {
                this.currentWeiboId = weiboId;
                const weibo = this.weibos.find(w => w.id === weiboId);
                const commentsList = document.getElementById('weiboCommentsList');
                commentsList.innerHTML = '';
                
                if (weibo.commentsList && weibo.commentsList.length > 0) {
                    weibo.commentsList.forEach(comment => {
                        const commentItem = document.createElement('div');
                        commentItem.className = 'weibo-comment-item';
                        commentItem.innerHTML = `
                            <div>
                                <span class="weibo-comment-user">${comment.user}</span>
                                <span style="font-size: 12px; color: #666;">${comment.time}</span>
                            </div>
                            <div class="weibo-comment-text">${comment.content}</div>
                        `;
                        commentsList.appendChild(commentItem);
                    });
                } else {
                    commentsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">暂无评论</div>';
                }
                
                document.getElementById('weiboCommentModal').style.display = 'flex';
                document.getElementById('weiboCommentInput').focus();
            },
            
            submitNewComment: async function() {
                let content = document.getElementById('weiboCommentInput').value.trim();
                
                if (!content && this.currentWeiboId) {
                    const weibo = this.weibos.find(w => w.id === this.currentWeiboId);
                    if (weibo) {
                        const commentInput = document.getElementById('weiboCommentInput');
                        commentInput.value = '正在生成评论...';
                        commentInput.disabled = true;

                        try {
                            content = await this.generateComment(weibo.content);
                            commentInput.value = content;
                        } catch (error) {
                            console.error('生成评论失败:', error);
                            commentInput.value = '评论一下！';
                        } finally {
                            commentInput.disabled = false;
                        }
                    }
                }

                if (content && this.currentWeiboId) {
                    this.addComment(this.currentWeiboId, content);
                }
            },
            
            addComment: function(weiboId, content) {
                const weibo = this.weibos.find(w => w.id === weiboId);
                if (weibo) {
                    if (!weibo.commentsList) {
                        weibo.commentsList = [];
                    }
                    
                    weibo.commentsList.unshift({
                        user: this.userProfile.name,
                        content: content,
                        time: '刚刚'
                    });
                    
                    weibo.comments += 1;
                    localStorage.setItem('weibos', JSON.stringify(this.weibos));
                    
                    document.getElementById('weiboCommentInput').value = '';
                    document.getElementById('weiboCommentModal').style.display = 'none';
                    this.renderWeiboList();
                }
            },
            
            renderDiscoverPage: function() {
                this.renderTrendingTopics();
                this.renderRecommendedUsers();
                this.renderRandomQuote();
                this.generateTrendingTopics();
            },
            
            renderTrendingTopics: function() {
                const topicList = document.getElementById('weiboTopicList');
                topicList.innerHTML = '';
                
                const shuffledTopics = [...this.trendingTopics].sort(() => 0.5 - Math.random());
                const selectedTopics = shuffledTopics.slice(0, 3);
                
                selectedTopics.forEach(topic => {
                    const topicItem = document.createElement('div');
                    topicItem.className = 'weibo-topic-item';
                    topicItem.innerHTML = `
                        <div class="weibo-topic-name">${topic.name}</div>
                        <div class="weibo-topic-stats">${topic.posts} 帖子 · ${topic.trend}</div>
                    `;
                    topicList.appendChild(topicItem);
                });
            },
            
            generateTrendingTopics: function() {
                const topics = [
                    { name: '#AI技术分享#', posts: (Math.floor(Math.random() * 50) + 10) + '万', trend: '热' },
                    { name: '#日常生活#', posts: (Math.floor(Math.random() * 100) + 20) + '万', trend: '新' },
                    { name: '#美食探店#', posts: (Math.floor(Math.random() * 80) + 15) + '万', trend: '沸' },
                    { name: '#恐怖故事#', posts: (Math.floor(Math.random() * 60) + 5) + '万', trend: '新' }
                ];
                
                this.trendingTopics = topics;
                this.renderTrendingTopics();
            },
            
            renderRecommendedUsers: function() {
                const userList = document.getElementById('weiboUserList');
                userList.innerHTML = '';
                
                // 获取角色信息（原AI角色人设）
                const aiPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}');
                
                // 如果角色人设已设置，添加到推荐用户列表中
                if (aiPersona.name && aiPersona.description) {
                    const aiUserItem = document.createElement('div');
                    aiUserItem.className = 'weibo-user-item';
                    
                    // 角色的头像显示
                    const avatarLetter = aiPersona.name.charAt(0);

                    aiUserItem.innerHTML = `
                        <div class="weibo-user-avatar">${avatarLetter}</div>
                        <div class="weibo-user-info">
                            <div class="weibo-user-name">${aiPersona.name}</div>
                            <div class="weibo-user-bio">${aiPersona.description}</div>
                        </div>
                        <button class="weibo-follow-btn">关注</button>
                    `;
                    userList.appendChild(aiUserItem);
                }
                
                // 随机选择几个中性角色和吃瓜角色
                const shuffledNeutralNPCs = [...this.neutralNPCs].sort(() => 0.5 - Math.random());
                const shuffledFanNPCs = [...this.fanNPCs].sort(() => 0.5 - Math.random());
                
                // 选择1-2个中性角色
                const selectedNeutralNPCs = shuffledNeutralNPCs.slice(0, Math.floor(Math.random() * 2) + 1);
                // 选择1-2个吃瓜角色
                const selectedFanNPCs = shuffledFanNPCs.slice(0, Math.floor(Math.random() * 2) + 1);
                
                // 合并并显示
                const allNPCs = [...selectedNeutralNPCs, ...selectedFanNPCs];
                
                allNPCs.forEach(npc => {
                    const userItem = document.createElement('div');
                    userItem.className = 'weibo-user-item';

                    // 修改头像显示逻辑：如果是"网友A"，显示"A"
                    let avatarLetter = npc.name.charAt(0);
                    if (npc.name.startsWith('网友')) {
                        avatarLetter = npc.name.replace('网友', '');
                    }

                    userItem.innerHTML = `
                        <div class="weibo-user-avatar">${avatarLetter}</div>
                        <div class="weibo-user-info">
                            <div class="weibo-user-name">${npc.name}</div>
                            <div class="weibo-user-bio">${npc.description}</div>
                        </div>
                        <button class="weibo-follow-btn">关注</button>
                    `;
                    userList.appendChild(userItem);
                });
                
                document.querySelectorAll('.weibo-follow-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        if (this.textContent === '关注') {
                            this.textContent = '已关注';
                            this.style.backgroundColor = '#000';
                            this.style.color = '#fff';
                        } else {
                            this.textContent = '关注';
                            this.style.backgroundColor = '';
                            this.style.color = '';
                        }
                    });
                });
            },
            
            renderRandomQuote: function() {
                const randomIndex = Math.floor(Math.random() * this.quotes.length);
                document.getElementById('weiboRandomQuote').textContent = this.quotes[randomIndex];
            },
            
            loadUserProfile: function() {
                document.getElementById('weiboProfileName').value = this.userProfile.name;
                document.getElementById('weiboProfileBio').value = this.userProfile.bio;
                document.getElementById('weiboProfilePersona').value = this.userProfile.persona;
                document.getElementById('weiboProfileLocation').value = this.userProfile.location;
                document.getElementById('weiboProfileFollowers').value = this.userProfile.followers;
                document.getElementById('weiboProfileFollowing').value = this.userProfile.following;
                
                document.getElementById('myProfileName').textContent = this.userProfile.name;
                document.getElementById('myProfileBio').textContent = this.userProfile.bio;
                document.getElementById('myProfileFollowers').textContent = this.userProfile.followers;
                document.getElementById('myProfileFollowing').textContent = this.userProfile.following;
                document.getElementById('myProfileWeibos').textContent = this.weibos.filter(w => w.username === this.userProfile.name).length;
                
                const myProfileAvatar = document.getElementById('myProfileAvatar');
                if (myProfileAvatar) {
                    myProfileAvatar.textContent = this.userProfile.name.charAt(0);
                }
            },
            
            saveUserProfile: function() {
                this.userProfile = {
                    name: document.getElementById('weiboProfileName').value.trim() || '微博用户',
                    bio: document.getElementById('weiboProfileBio').value.trim() || '这个人很懒，什么都没有写...',
                    persona: document.getElementById('weiboProfilePersona').value.trim() || '普通用户',
                    location: document.getElementById('weiboProfileLocation').value.trim(),
                    followers: parseInt(document.getElementById('weiboProfileFollowers').value) || 0,
                    following: parseInt(document.getElementById('weiboProfileFollowing').value) || 0
                };
                
                localStorage.setItem('weiboUserProfile', JSON.stringify(this.userProfile));
                document.getElementById('weiboProfileModal').style.display = 'none';
                this.updateUserWeibos();
                this.updateUserAvatar();
                this.loadUserProfile();
            },
            
            updateUserWeibos: function() {
                this.weibos.forEach(weibo => {
                    if (weibo.username === '当前用户') {
                        weibo.username = this.userProfile.name;
                    }
                });
                localStorage.setItem('weibos', JSON.stringify(this.weibos));
                this.renderWeiboList();
            },
            
            filterByCategory: function(category) {
                this.currentCategory = category;
                this.renderCategoryTags();
                this.renderWeiboList();
            },
            
            addCategory: function() {
                const newCategory = document.getElementById('weiboNewCategoryInput').value.trim();
                if (newCategory && !this.categories.includes(newCategory)) {
                    this.categories.push(newCategory);
                    localStorage.setItem('weiboCategories', JSON.stringify(this.categories));
                    this.renderCategoryTags();
                    this.renderCategoryList();
                    this.renderCategorySelect();
                    document.getElementById('weiboNewCategoryInput').value = '';
                }
            },
            
            deleteCategory: function(category) {
                this.categories = this.categories.filter(c => c !== category);
                localStorage.setItem('weiboCategories', JSON.stringify(this.categories));
                this.renderCategoryTags();
                this.renderCategoryList();
                this.renderCategorySelect();
                
                if (this.currentCategory === category) {
                    this.filterByCategory('');
                }
            },
            
            publishWeibo: async function() {
                const content = document.getElementById('weiboText').value.trim();
                const category = document.getElementById('weiboCategorySelect').value;
                
                if (!content) {
                    alert('请输入微博内容！');
                    return;
                }
                
                if (content) {
                    const newWeibo = {
                        id: Date.now(),
                        username: this.userProfile.name,
                        content: content,
                        timestamp: '刚刚',
                        category: category,
                        likes: 0,
                        comments: 0,
                        reposts: 0,
                        commentsList: [],
                        isLiked: false,
                        isChatCharacter: false,
                        isFanRole: false
                    };
                    
                    this.weibos.unshift(newWeibo);
                    localStorage.setItem('weibos', JSON.stringify(this.weibos));
                    
                    document.getElementById('weiboText').value = '';
                    document.getElementById('weiboCategorySelect').value = '';
                    this.renderWeiboList();
                    this.loadUserProfile();
                    
                    alert('微博发布成功！');
                }
            },
            
            refreshDynamicContent: async function() {
                await this.loadDynamicWeibos();
                this.renderDiscoverPage();
                alert('已添加新动态！');
            },
            
            switchPage: function(pageName) {
                document.getElementById('weiboHomePage').classList.remove('active');
                document.getElementById('weiboDiscoverPage').classList.remove('active');
                document.getElementById('weiboProfilePage').classList.remove('active');
                
                document.getElementById('weiboHomeLink').classList.remove('active');
                document.getElementById('weiboDiscoverLink').classList.remove('active');
                document.getElementById('weiboProfileLink').classList.remove('active');
                
                if (pageName === 'home') {
                    document.getElementById('weiboHomePage').classList.add('active');
                    document.getElementById('weiboHomeLink').classList.add('active');
                } else if (pageName === 'discover') {
                    document.getElementById('weiboDiscoverPage').classList.add('active');
                    document.getElementById('weiboDiscoverLink').classList.add('active');
                    this.renderDiscoverPage();
                } else if (pageName === 'profile') {
                    document.getElementById('weiboProfilePage').classList.add('active');
                    document.getElementById('weiboProfileLink').classList.add('active');
                    this.loadUserProfile();
                }
            },
            
            bindEvents: function() {
                document.getElementById('weiboManageCategories').addEventListener('click', () => {
                    document.getElementById('weiboCategoryModal').style.display = 'flex';
                });
                
                document.getElementById('weiboCloseCategoryModal').addEventListener('click', () => {
                    document.getElementById('weiboCategoryModal').style.display = 'none';
                });
                
                document.getElementById('weiboProfileLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.switchPage('profile');
                });
                
                document.getElementById('weiboCloseProfileModal').addEventListener('click', () => {
                    document.getElementById('weiboProfileModal').style.display = 'none';
                });
                
                document.getElementById('weiboUserAvatar').addEventListener('click', () => {
                    this.loadUserProfile();
                    document.getElementById('weiboProfileModal').style.display = 'flex';
                });
                
                document.getElementById('weiboHomeLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.switchPage('home');
                });
                
                document.getElementById('weiboDiscoverLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.switchPage('discover');
                });
                
                document.getElementById('weiboAddCategoryBtn').addEventListener('click', () => {
                    this.addCategory();
                });
                
                document.getElementById('weiboNewCategoryInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.addCategory();
                    }
                });
                
                document.getElementById('weiboSaveProfileBtn').addEventListener('click', () => {
                    this.saveUserProfile();
                });
                
                document.getElementById('weiboPublishBtn').addEventListener('click', () => {
                    this.publishWeibo();
                });
                
                document.getElementById('weiboText').addEventListener('keypress', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        this.publishWeibo();
                    }
                });
                
                document.getElementById('weiboRefreshTopics').addEventListener('click', () => {
                    this.renderTrendingTopics();
                });
                
                document.getElementById('weiboRefreshUsers').addEventListener('click', () => {
                    this.renderRecommendedUsers();
                });
                
                document.getElementById('weiboCloseCommentModal').addEventListener('click', () => {
                    document.getElementById('weiboCommentModal').style.display = 'none';
                });
                
                document.getElementById('weiboCancelComment').addEventListener('click', () => {
                    document.getElementById('weiboCommentModal').style.display = 'none';
                });
                
                document.getElementById('weiboSubmitComment').addEventListener('click', () => {
                    this.submitNewComment();
                });
                
                document.getElementById('weiboCommentInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        this.submitNewComment();
                    }
                });
                
                document.getElementById('weiboRefreshDynamicBtn').addEventListener('click', () => {
                    this.refreshDynamicContent();
                });
                
                document.getElementById('editMyProfileBtn').addEventListener('click', () => {
                    this.loadUserProfile();
                    document.getElementById('weiboProfileModal').style.display = 'flex';
                });
                
                // 移除聊天角色主页相关的事件监听
            }
        };

        // 全局状态
        const appState = {
            currentPersona: null,
            apiConfig: {},
            customCSS: '',
            isGenerating: false,
            models: [],
            lastUpdated: null,
            apiService: new ApiService(),
            chatManager: new ChatManager(),
            worldbookManager: new WorldbookManager(),
            currentPersonaTab: 'ai',
            currentEditingMessageId: null
        };  

        const API_ENDPOINTS = {
            openai: 'https://api.openai.com/v1',
            anthropic: 'https://api.anthropic.com/v1',
            google: 'https://generativelanguage.googleapis.com/v1'
        };

        const MODEL_LISTS = {
            openai: ['gpt-4', 'gpt-4-turbo', 'gpt-3.5-turbo', 'gpt-3.5-turbo-16k'],
            anthropic: ['claude-3-opus', 'claude-3-sonnet', 'claude-3-haiku'],
            google: ['gemini-pro', 'gemini-pro-vision']
        };

        let currentInterface = 'desktop'; // 初始化为桌面
        let deleteMessageId = null;
        let deleteWorldbookId = null;
        
        // 修复监听器 - 确保消息更新时重新渲染
        appState.chatManager.addListener('messagesChanged', (messages) => {
            console.log('消息列表发生变化:', messages);
            renderChatMessages();
        });

        appState.chatManager.addListener('messageUpdated', (message) => {
            console.log('消息被更新:', message);
            renderChatMessages(); // 确保界面更新
        });

        appState.chatManager.addListener('messageDeleted', (message) => {
            console.log('消息被删除:', message);
            renderChatMessages(); // 确保界面更新
        });

        // 新增功能函数
        function updateDesktopTime() {
            const now = new Date();
            const timeElement = document.getElementById('desktop-time');
            
            // 格式化时间
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            timeElement.textContent = `${hours}:${minutes}`;
        }

        function openApp(appName) {
            // 隐藏桌面
            document.getElementById('desktop-interface').classList.remove('active');
            
            // 显示对应的应用界面
            const interface = document.getElementById(`${appName}-interface`);
            interface.classList.add('active');
            
            // 更新当前界面状态
            currentInterface = appName;
            
            // 更新状态指示器
            updateStatusIndicators();
            
            // 如果是世界书界面，渲染世界书记录列表
            if (appName === 'worldbook') {
                renderWorldbookList();
                updateWorldbookStatusIndicator(); // 新增：更新世界书状态指示灯
            }
            
            // 如果是钱包界面，初始化钱包
            if (appName === 'wallet') {
                walletManager.initWallet();
                walletManager.setupEventListeners();
            }
            
            // 如果是微博界面，初始化微博
            if (appName === 'weibo') {
                weiboManager.init();
            }
        }

        function goBackToDesktop() {
            // 隐藏所有应用界面
            document.querySelectorAll('.interface').forEach(interface => {
                interface.classList.remove('active');
            });
            
            // 显示桌面
            document.getElementById('desktop-interface').classList.add('active');
            
            // 重置当前界面状态
            currentInterface = 'desktop';
        }

        // 删除相关函数
        function showDeleteConfirm(messageId) {
            deleteMessageId = messageId;
            document.getElementById('confirm-dialog').style.display = 'flex';
        }

        function confirmDelete() {
            if (!deleteMessageId) {
                document.getElementById('confirm-dialog').style.display = 'none';
                return;
            }

            console.log('确认删除消息ID:', deleteMessageId);

            // 执行删除操作
            const success = appState.chatManager.deleteMessage(deleteMessageId);
            console.log('删除结果:', success);

            // 重新渲染界面
            renderChatMessages();

            // 隐藏对话框
            document.getElementById('confirm-dialog').style.display = 'none';
            deleteMessageId = null;
        }

        function cancelDelete() {
            document.getElementById('confirm-dialog').style.display = 'none';
            deleteMessageId = null;
        }

        function openPersonaModal() {
            document.getElementById('persona-modal').style.display = 'flex';
            loadPersonaPreviews();
        }

        function closePersonaModal() {
            document.getElementById('persona-modal').style.display = 'none';
        }

        function switchPersonaTab(tabName) {
            document.querySelectorAll('.persona-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.persona-form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelector(`.persona-tab[onclick="switchPersonaTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-persona-section`).classList.add('active');
            
            appState.currentPersonaTab = tabName;
            loadPersonaPreviews();
        }     

        function loadPersonaPreviews() {
            const aiPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}');
            const userPersona = JSON.parse(localStorage.getItem('userPersona') || '{}');
            
            if (aiPersona.name || aiPersona.description) {
                document.getElementById('ai-preview-content').innerHTML = `
                    <strong>姓名:</strong> ${aiPersona.name || '未设置'}<br>
                    <strong>描述:</strong> ${aiPersona.description || '未设置'}
                `;
            } else {   
                document.getElementById('ai-preview-content').textContent = '暂无角色人设';
            }
            
            if (userPersona.name || userPersona.description) {
                document.getElementById('user-preview-content').innerHTML = `
                    <strong>姓名:</strong> ${userPersona.name || '未设置'}<br>
                    <strong>描述:</strong> ${userPersona.description || '未设置'}
                `;
            } else {
                document.getElementById('user-preview-content').textContent = '暂无我的人设';
            }
        }   

        function saveAIPersona() {
            const name = document.getElementById('ai-persona-name').value.trim();
            const desc = document.getElementById('ai-persona-desc').value.trim();
            
            const persona = {
                name: name,
                description: desc,
                timestamp: new Date().toISOString()
            };     
            
            localStorage.setItem('aiPersona', JSON.stringify(persona));
            loadPersonaPreviews();
            
            // 新增：保存后重新渲染聊天消息，以更新AI名称显示
            renderChatMessages();
            
            alert('角色人设保存成功！');
        }

        function loadAIPersona() {
            const savedPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}');
            document.getElementById('ai-persona-name').value = savedPersona.name || '';
            document.getElementById('ai-persona-desc').value = savedPersona.description || '';
            loadPersonaPreviews();
            
            // 新增：加载后重新渲染聊天消息
            renderChatMessages();
            
            alert('角色人设加载成功！');
        }

        function saveUserPersona() {
            const name = document.getElementById('user-persona-name').value.trim();
            const desc = document.getElementById('user-persona-desc').value.trim();
            
            const persona = {    
                name: name,
                description: desc,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('userPersona', JSON.stringify(persona));
            loadPersonaPreviews();
            
            // 新增：保存后重新渲染聊天消息
            renderChatMessages();
            
            alert('我的人设保存成功！');
        }

        function loadUserPersona() {
            const savedPersona = JSON.parse(localStorage.getItem('userPersona') || '{}');
            document.getElementById('user-persona-name').value = savedPersona.name || '';
            document.getElementById('user-persona-desc').value = savedPersona.description || '';
            loadPersonaPreviews();
            
            // 新增：加载后重新渲染聊天消息
            renderChatMessages();
            
            alert('我的人设加载成功！');
        }   

        function editMessage(button, messageId) {
            const messageElement = button.closest('.message');
            const contentElement = messageElement.querySelector('.message-content');
            const currentContent = contentElement.textContent;
            
            // 进入编辑模式
            messageElement.classList.add('editing');
            contentElement.innerHTML = `
                <textarea class="edit-input">${currentContent}</textarea>
                <div class="edit-actions">
                    <button onclick="saveEdit('${messageId}')">保存</button>
                    <button onclick="cancelEdit('${messageId}')">取消</button>
                </div>
            `;
            
            appState.currentEditingMessageId = messageId;
        }

        function saveEdit(messageId) {    
            const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
            const textarea = messageElement.querySelector('.edit-input');
            const newContent = textarea.value.trim();
            
            if (newContent) {
                // 更新消息内容
                if (appState.chatManager.updateMessage(messageId, newContent)) {
                    messageElement.classList.remove('editing');
                    messageElement.querySelector('.message-content').innerHTML = newContent;
                }
            }
            
            appState.currentEditingMessageId = null;
        }    

        function cancelEdit(messageId) {
            const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
            messageElement.classList.remove('editing');
            
            // 恢复原始内容
            const message = appState.chatManager.messages.find(msg => msg.id === messageId);
            if (message) {
                messageElement.querySelector('.message-content').innerHTML = message.content;
            }
            
            appState.currentEditingMessageId = null;
        }

        function updateStatusIndicators() {
            const chatStatus = document.getElementById('chat-status');
            const apiStatus = document.getElementById('api-status-indicator');
            const styleStatus = document.getElementById('style-status');
            const musicStatus = document.getElementById('music-status');
            const walletStatus = document.getElementById('wallet-status');
            const weiboStatus = document.getElementById('weibo-status');
            
            // 聊天状态指示灯 - 根据生成状态变化
            if (appState.isGenerating) {
                chatStatus.className = 'status-indicator status-generating';
                chatStatus.title = '正在生成回复...';
            } else {
                if (appState.currentPersona) {
                    chatStatus.className = 'status-indicator status-online';
                    chatStatus.title = '人设已应用';
                } else {
                    chatStatus.className = 'status-indicator status-offline';
                    chatStatus.title = '使用默认人设';
                }
            }
            
            const currentConfig = appState.apiService.getCurrentConfig();
            if (currentConfig.apiKey && currentConfig.model) {
                apiStatus.className = 'status-indicator status-online';
                apiStatus.title = 'API配置完成';
            } else {
                apiStatus.className = 'status-indicator status-offline';
                apiStatus.title = 'API未配置';
            }    
            
            if (appState.customCSS) {
                styleStatus.className = 'status-indicator status-online';
                styleStatus.title = '自定义样式已应用';
            } else {
                styleStatus.className = 'status-indicator status-offline';
                styleStatus.title = '使用默认样式';
            }
            
            // 音乐状态指示灯
            if (musicPlayer.isPlaying) {
                musicStatus.className = 'status-indicator status-online';
                musicStatus.title = '正在播放';
            } else {
                musicStatus.className = 'status-indicator status-offline';
                musicStatus.title = '未播放';
            }
            
            // 钱包状态指示灯
            if (walletManager.walletData && walletManager.walletData.totalBalance > 0) {
                walletStatus.className = 'status-indicator status-online';
                walletStatus.title = '钱包余额充足';
            } else {
                walletStatus.className = 'status-indicator status-offline';
                walletStatus.title = '钱包余额为空';
            }
            
            // 微博状态指示灯
            if (weiboManager.weibos && weiboManager.weibos.length > 0) {
                weiboStatus.className = 'status-indicator status-online';
                weiboStatus.title = `有 ${weiboManager.weibos.length} 条动态微博`;
            } else {
                weiboStatus.className = 'status-indicator status-offline';
                weiboStatus.title = '微博内容加载中';
            }
        }

        // 更新世界书状态指示灯
        function updateWorldbookStatusIndicator() {
            const headerIndicator = document.getElementById('worldbook-status-indicator');
            const titleIndicator = document.getElementById('worldbook-status-indicator-title');
            
            const activeRecords = appState.worldbookManager.getActiveRecords();
            
            if (activeRecords.length > 0) {
                headerIndicator.className = 'status-indicator status-online';
                headerIndicator.title = `有 ${activeRecords.length} 条激活的世界书记录`;
                titleIndicator.className = 'status-indicator status-online';
                titleIndicator.title = `有 ${activeRecords.length} 条激活的世界书记录`;
            } else {
                headerIndicator.className = 'status-indicator status-offline';
                headerIndicator.title = '没有激活的世界书记录';
                titleIndicator.className = 'status-indicator status-offline';
                titleIndicator.title = '没有激活的世界书记录';
            }
        }

        function handleMessageKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function renderChatMessages() {
            const chatMessages = document.getElementById('chat-messages');
            const messages = appState.chatManager.getMessages();
            
            console.log('渲染消息列表，消息数量:', messages.length);
             console.log('消息内容:', messages);
            
            chatMessages.innerHTML = '';      
            
            messages.forEach(message => {
                const messageElement = document.createElement('div');
                const isUser = message.sender === 'user';
                const aiName = getCurrentAiName();
                const userName = getCurrentUserName(); // 获取用户人设名称
                
                messageElement.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
                messageElement.setAttribute('data-message-id', message.id);
                
                messageElement.innerHTML = `
                    <div class="message-sender">${isUser ? userName : aiName}</div>
                    <div class="message-content">${message.content}</div>
                    <div class="message-actions">
                        <button class="message-action" title="编辑" onclick="editMessage(this, '${message.id}')">✤</button>
                        <button class="message-action" title="删除" onclick="showDeleteConfirm('${message.id}')">✖</button>
                    </div>    
                `;
                
                chatMessages.appendChild(messageElement);
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function getCurrentAiName() {
            // 从保存的AI人设中获取名称
            const savedPersona = localStorage.getItem('aiPersona');
             if (savedPersona) {
                 try {
                     const persona = JSON.parse(savedPersona);
                     // 如果设置了角色名称，则返回名称，否则返回默认名称
                      return persona.name || '助手';
                 } catch (e) {
                     console.error('解析角色人设失败:', e);
                     return '助手';
                 }
             }
            // 如果没有保存的人设，返回默认名称
            return '助手';
        }

        function getCurrentUserName() {
            // 从保存的用户人设中获取名称
            const savedPersona = localStorage.getItem('userPersona');
            if (savedPersona) {
                try {
                    const persona = JSON.parse(savedPersona);
                    // 如果设置了用户名称，则返回名称，否则返回默认名称
                    return persona.name || '您';
                } catch (e) {
                    console.error('解析用户人设失败:', e);
                    return '您';
                }
            }
            // 如果没有保存的人设，返回默认名称
            return '您';
        }

        async function sendMessage() {
            if (appState.isGenerating) return;
            
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (!message) return;
            
            const sendButton = document.getElementById('send-button');
            
            // 先清空输入框，防止重复发送
            input.value = '';
            appState.isGenerating = true;
            sendButton.disabled = true;  
            sendButton.textContent = '生成中...';
            
            // 更新状态指示灯为绿色
            updateStatusIndicators();
            
            // 添加用户消息
            appState.chatManager.addMessage('user', message);
            renderChatMessages();
            
            // 添加思考消息
            const thinkingMessage = appState.chatManager.addMessage('ai', '正在思考...');
            renderChatMessages();
            
            try {
                const rolePrompt = getCurrentRolePrompt();
                const temperature = parseFloat(document.getElementById('temperature').value) || 0.7;
                const response = await appState.apiService.chatWithRole(rolePrompt, message, temperature);
                
                // 更新角色回复    
                appState.chatManager.updateMessage(thinkingMessage.id, response);
                renderChatMessages();
                
            } catch (error) {
                // 更新错误消息       
                appState.chatManager.updateMessage(thinkingMessage.id, `抱歉，生成回复时出现错误：${error.message}`);
                renderChatMessages();
                
                console.error('API调用错误:', error);
            } finally {
                appState.isGenerating = false;
                sendButton.disabled = false;
                sendButton.textContent = '发送';
                
                // 恢复状态指示灯
                updateStatusIndicators();
            }
        }

        function getCurrentRolePrompt() {
            const savedPersona = localStorage.getItem('aiPersona');
            if (savedPersona) {    
                const persona = JSON.parse(savedPersona);
                return persona.description || '你是一个有用的助手';
            }
            
            const basicPersona = document.getElementById('persona-input').value;
            return basicPersona || '你是一个有用的助手';
        }

        function updateApiEndpoints() {  
            const provider = document.getElementById('api-provider').value;
            const endpointInput = document.getElementById('api-url');
            const modelSelect = document.getElementById('model-select');
            const providerBadge = document.getElementById('model-provider-badge');
            
            if (provider !== 'custom') {
                endpointInput.value = API_ENDPOINTS[provider] || '';
                providerBadge.textContent = provider.charAt(0).toUpperCase() + provider.slice(1);
                
                modelSelect.innerHTML = '<option value="">请选择模型</option>';
                const models = MODEL_LISTS[provider] || [];
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    option.selected = model === appState.apiService.config.model;
                    modelSelect.appendChild(option);
                });
            }
        }

        function updateSelectedModel() {
            const modelSelect = document.getElementById('model-select');
            const currentModelDisplay = document.getElementById('current-model-display');
            const selectedModel = modelSelect.value;
            
            if (selectedModel) {
                currentModelDisplay.textContent = `当前模型: ${selectedModel}`;
                appState.apiService.updateConfig({ model: selectedModel });
            } else {
                currentModelDisplay.textContent = '当前模型: 未选择';
                appState.apiService.updateConfig({ model: '' });
            }
        }

        async function testApiConnection() {  
            const apiKey = document.getElementById('api-key').value;
            const apiUrl = document.getElementById('api-url').value;
            const provider = document.getElementById('api-provider').value;
            const statusDiv = document.getElementById('api-status');
            
            if (!apiKey) {    
                statusDiv.style.display = 'block';
                statusDiv.className = 'api-status status-error';
                statusDiv.textContent = '✖ 请输入API密钥';
                return;
            }
            
            statusDiv.style.display = 'block';
            statusDiv.className = 'api-status';
            statusDiv.textContent = '测试连接中...';
            
            try {     
                appState.apiService.updateConfig({
                    provider: provider,
                    apiKey: apiKey,
                    apiUrl: apiUrl
                });
                
                const result = await appState.apiService.testConnection();
                
                if (result.success) {
                    statusDiv.className = 'api-status status-success';
                    statusDiv.textContent = '✔ API连接成功！';
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                statusDiv.className = 'api-status status-error';
                statusDiv.textContent = `✖ API连接失败: ${error.message}`;
            }   
            
            updateStatusIndicators();
        }

        async function refreshModels() {  
            const apiKey = document.getElementById('api-key').value;
            const apiUrl = document.getElementById('api-url').value;
            const provider = document.getElementById('api-provider').value;
            const statusDiv = document.getElementById('api-status');
            const lastUpdated = document.getElementById('last-updated');
            const providerBadge = document.getElementById('model-provider-badge');
            
            if (!apiKey) { 
                statusDiv.style.display = 'block';
                statusDiv.className = 'api-status status-error';
                statusDiv.textContent = '✖ 请先输入API密钥';
                return;
            }
            
            statusDiv.style.display = 'block';
            statusDiv.className = 'api-status';
            statusDiv.textContent = '获取模型中...';
            
            try {
                appState.apiService.updateConfig({
                    provider: provider,
                    apiKey: apiKey,
                    apiUrl: apiUrl
                });    
                
                const models = await appState.apiService.getModels();
                updateModelSelect(models);
                statusDiv.className = 'api-status status-success';
                statusDiv.textContent = `✔ 成功获取 ${models.length} 个模型`;
                appState.models = models;
                appState.lastUpdated = new Date();
                lastUpdated.textContent = `上次更新: ${appState.lastUpdated.toLocaleTimeString()}`;
                updateSelectedModel();
                providerBadge.textContent = provider.charAt(0).toUpperCase() + provider.slice(1);
                
            } catch (error) {
                statusDiv.className = 'api-status status-error';
                statusDiv.textContent = `✖ 获取模型失败: ${error.message}`;
                
                const models = MODEL_LISTS[provider] || ['default-model'];
                updateModelSelect(models);
                appState.models = models;
                appState.lastUpdated = new Date();
                lastUpdated.textContent = `上次更新: ${appState.lastUpdated.toLocaleTimeString()}`;
                updateSelectedModel();   
                providerBadge.textContent = provider.charAt(0).toUpperCase() + provider.slice(1);
            }
        }

        function updateModelSelect(models) {
            const modelSelect = document.getElementById('model-select');
            
            modelSelect.innerHTML = '<option value="">请选择模型</option>';
            
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                if (model === appState.apiService.config.model) {
                    option.selected = true;
                }
                modelSelect.appendChild(option);
            });
        }   

        function saveApiConfig() {  
            const apiKey = document.getElementById('api-key').value;
            const apiUrl = document.getElementById('api-url').value;
            const model = document.getElementById('model-select').value;
            const provider = document.getElementById('api-provider').value;
            const temperature = document.getElementById('temperature').value;
            const maxTokens = document.getElementById('max-tokens').value;
            
            if (apiKey && model) {
                appState.apiService.updateConfig({
                    provider: provider,
                    apiKey: apiKey,
                    apiUrl: apiUrl,
                    model: model
                });      
                
                updateStatusIndicators();
                alert('API配置保存成功！');
            } else {
                alert('请填写完整的API配置信息。');
            }
        }

        function clearApiConfig() {
            document.getElementById('api-key').value = '';
            document.getElementById('api-url').value = 'https://api.openai.com/v1';
            document.getElementById('model-select').innerHTML = '<option value="">请选择模型</option>';
            document.getElementById('api-provider').value = 'openai';
            document.getElementById('temperature').value = '0.7';
            document.getElementById('max-tokens').value = '1000';
            document.getElementById('current-model-display').textContent = '当前模型: 未选择';
            
            appState.apiService.updateConfig({
                provider: 'openai',      
                apiKey: '',
                apiUrl: 'https://api.openai.com/v1',
                model: ''
            });
            
            updateStatusIndicators();  
            alert('API配置已清除！');
        }

        function applyGlobalCSS() {
            const cssCode = document.getElementById('css-editor').value;
            let styleElement = document.getElementById('global-css');
            
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = 'global-css';
                document.head.appendChild(styleElement);
            }    
            
            styleElement.textContent = cssCode;
            appState.customCSS = cssCode;
            localStorage.setItem('customCSS', cssCode);
            updateStatusIndicators();
            alert('全局CSS应用成功！');
        }

        function resetCSS() {
            document.getElementById('css-editor').value = `/* 在这里输入您的自定义CSS */
.message {
    border: 1px solid #000;
    background: white;
    margin: 8px 0;
    max-width: 85%;
}

.user-message {   
    margin-left: auto;
    background: #f8f8f8;
}

.ai-message {  
    margin-right: auto;
    background: #f0f0f0;
}

.ai-circle {
    border: 3px solid #000;
    background: white;
    transition: all 0.3s ease;
}

.ai-circle:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}`;     
            appState.customCSS = '';
            localStorage.removeItem('customCSS');
            
            const styleElement = document.getElementById('global-css');
            if (styleElement) {
                styleElement.remove();
            }
            
            updateStatusIndicators();
            alert('CSS已重置为默认值！');
        }     

        function exportCSS() {
            const cssCode = document.getElementById('css-editor').value;
            const blob = new Blob([cssCode], { type: 'text/css' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;    
            a.download = 'ai_app_styles.css';
            a.click();
            URL.revokeObjectURL(url);
            alert('CSS代码已导出！');
        }

        function importCSS() {    
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.css';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('css-editor').value = e.target.result;
                    alert('CSS代码已导入！');
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function updateTemperatureValue() {
            const temperature = document.getElementById('temperature');
            const valueSpan = document.getElementById('temperature-value');
            valueSpan.textContent = temperature.value;
        }

        function savePersona() {
            const personaInput = document.getElementById('persona-input');
            const persona = personaInput.value.trim();
            if (persona) {
                // 修改：保存时要包含名称信息
                const savedPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}');
                const updatedPersona = {
                    ...savedPersona,
                    description: persona
                    // 如果没有设置名称，可以给一个默认名称
                    // name: savedPersona.name || '助手'
                };
                localStorage.setItem('aiPersona', JSON.stringify(updatedPersona));
                
                // 新增：重新渲染聊天消息
                renderChatMessages();
                
                alert('人设保存成功！');
            }
        }       

        function editPersona() {  
            const savedPersona = localStorage.getItem('aiPersona');
            if (savedPersona) {
                const persona = JSON.parse(savedPersona);
                document.getElementById('persona-input').value = persona.description || '';   
            }
        }

        function applyPersona() {
            const persona = localStorage.getItem('aiPersona');
            if (persona) {
                // 新增：应用人设时重新渲染
                renderChatMessages();
                alert('人设应用成功！当前对话将使用新的人设。');
            } else {
                alert('请先保存人设再应用。');
            }
        }

        // ==================== 世界书相关函数 ====================
        function openWorldbookModal(recordId = null) {
            const modal = document.getElementById('worldbook-modal');
            const titleInput = document.getElementById('worldbook-title');
            const contentInput = document.getElementById('worldbook-content');
            const modalTitle = document.getElementById('worldbook-modal-title');
            const statusDiv = document.getElementById('worldbook-status');
            
            // 重置表单
            titleInput.value = '';
            contentInput.value = '';
            statusDiv.style.display = 'none';
            
            // 设置模态框标题
            if (recordId) {
                modalTitle.textContent = '编辑世界书记录';
                const record = appState.worldbookManager.getRecordById(recordId);
                if (record) {
                    titleInput.value = record.title;
                    contentInput.value = record.content;
                    appState.worldbookManager.currentEditingId = recordId;
                }
            } else {
                modalTitle.textContent = '添加世界书记录';
                appState.worldbookManager.currentEditingId = null;
            }
            
            modal.style.display = 'flex';
        }

        function closeWorldbookModal() {
            document.getElementById('worldbook-modal').style.display = 'none';
            appState.worldbookManager.currentEditingId = null;
        }

        function saveWorldbookRecord() {
            const titleInput = document.getElementById('worldbook-title');
            const contentInput = document.getElementById('worldbook-content');
            const statusDiv = document.getElementById('worldbook-status');
            
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();
            
            if (!title || !content) {
                statusDiv.textContent = '请填写记录标题和内容';
                statusDiv.className = 'worldbook-status worldbook-status-error';
                statusDiv.style.display = 'block';
                return;
            }
            
            let success = false;
            
            if (appState.worldbookManager.currentEditingId) {
                // 编辑现有记录
                success = appState.worldbookManager.updateRecord(
                    appState.worldbookManager.currentEditingId, 
                    title, 
                    content
                );
            } else {
                // 添加新记录
                appState.worldbookManager.addRecord(title, content);
                success = true;
            }
            
            if (success) {
                statusDiv.textContent = '世界书记录保存成功';
                statusDiv.className = 'worldbook-status worldbook-status-success';
                statusDiv.style.display = 'block';
                
                // 重新渲染世界书记录列表
                renderWorldbookList();
                
                // 1秒后关闭模态框
                setTimeout(() => {
                    closeWorldbookModal();
                }, 1000);
            } else {
                statusDiv.textContent = '保存世界书记录失败';
                statusDiv.className = 'worldbook-status worldbook-status-error';
                statusDiv.style.display = 'block';
            }
            
            // 更新世界书状态指示灯
            updateWorldbookStatusIndicator();
        }

        function deleteWorldbookRecord(recordId) {
            const record = appState.worldbookManager.getRecordById(recordId);
            if (!record) return;
            
            deleteWorldbookId = recordId;
            
            // 显示确认对话框
            document.getElementById('delete-worldbook-dialog').style.display = 'flex';
        }

        function confirmDeleteWorldbookRecord() {
            if (!deleteWorldbookId) {
                document.getElementById('delete-worldbook-dialog').style.display = 'none';
                return;
            }

            appState.worldbookManager.deleteRecord(deleteWorldbookId);
            renderWorldbookList();
            document.getElementById('delete-worldbook-dialog').style.display = 'none';
            deleteWorldbookId = null;
            
            // 更新世界书状态指示灯
            updateWorldbookStatusIndicator();
        }

        function cancelDeleteWorldbookRecord() {
            document.getElementById('delete-worldbook-dialog').style.display = 'none';
            deleteWorldbookId = null;
        }

        function toggleWorldbookRecord(recordId) {
            appState.worldbookManager.toggleRecord(recordId);
            renderWorldbookList();
            
            // 更新世界书状态指示灯
            updateWorldbookStatusIndicator();
        }

        function toggleWorldbookContent(recordId) {
            const contentElement = document.querySelector(`.worldbook-content[data-record-id="${recordId}"]`);
            if (contentElement) {
                contentElement.classList.toggle('expanded');
                
                const toggleButton = document.querySelector(`.worldbook-toggle[data-record-id="${recordId}"]`);
                if (toggleButton) {
                    if (contentElement.classList.contains('expanded')) {
                        toggleButton.textContent = '收起';
                    } else {
                        toggleButton.textContent = '展开';
                    }
                }
            }
        }

        function renderWorldbookList() {
            const worldbookList = document.getElementById('worldbook-list');
            const records = appState.worldbookManager.getAllRecords();
            
            if (records.length === 0) {
                worldbookList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">暂无世界书记录，点击右上角"+"添加</div>';
                return;
            }
            
            worldbookList.innerHTML = '';
            
            records.forEach(record => {
                const recordElement = document.createElement('div');
                recordElement.className = 'worldbook-item';
                
                recordElement.innerHTML = `
                    <div class="worldbook-title">
                        <span class="worldbook-active-indicator ${record.active ? 'worldbook-active' : 'worldbook-inactive'}"></span>
                        ${record.title}
                    </div>
                    <div class="worldbook-content" data-record-id="${record.id}">
                        ${record.content}
                    </div>
                    <button class="worldbook-toggle" data-record-id="${record.id}" onclick="toggleWorldbookContent('${record.id}')">展开</button>
                    <div class="worldbook-actions">
                        <button class="worldbook-action" onclick="toggleWorldbookRecord('${record.id}')">
                            ${record.active ? '停用' : '启用'}
                        </button>
                        <button class="worldbook-action" onclick="openWorldbookModal('${record.id}')">编辑</button>
                        <button class="worldbook-action" onclick="deleteWorldbookRecord('${record.id}')">删除</button>
                    </div>
                `;
                
                worldbookList.appendChild(recordElement);
            });
        }

        // ==================== 聊天记录备份功能 ====================
        
        // 导出聊天记录为JSON文件
        function exportChatHistory() {
            const messages = appState.chatManager.getMessages();
            
            if (messages.length === 0) {
                showBackupStatus('没有聊天记录可以导出', 'error');
                return;
            }
            
            // 添加导出时间戳
            const exportData = {
                version: '1.0',
                exportTime: new Date().toISOString(),
                messageCount: messages.length,
                messages: messages
            };
            
            // 创建JSON文件并下载
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `chat_history_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showBackupStatus(`成功导出 ${messages.length} 条聊天记录`, 'success');
        }
        
        // 导入聊天记录
        function importChatHistory() {
            document.getElementById('backup-file-input').click();
        }
        
        // 处理文件选择
        document.getElementById('backup-file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // 验证文件格式
                    if (!importData.messages || !Array.isArray(importData.messages)) {
                        showBackupStatus('文件格式不正确', 'error');
                        return;
                    }
                    
                    // 显示确认对话框
                    showImportConfirm(importData);
                } catch (error) {
                    console.error('解析文件失败:', error);
                    showBackupStatus('文件解析失败，请检查文件格式', 'error');
                }
            };
            reader.readAsText(file);
            
            // 清空文件输入，以便再次选择相同文件
            e.target.value = '';
        });
        
        // 显示导入确认对话框
        function showImportConfirm(importData) {
            document.getElementById('import-confirm-dialog').style.display = 'flex';
            
            // 绑定确认按钮事件
            document.getElementById('confirm-import-btn').onclick = function() {
                performImport(importData);
                document.getElementById('import-confirm-dialog').style.display = 'none';
            };
            
            // 绑定取消按钮事件
            document.getElementById('cancel-import-btn').onclick = function() {
                document.getElementById('import-confirm-dialog').style.display = 'none';
            };
        }
        
        // 执行导入操作
        function performImport(importData) {
            try {
                // 清空当前聊天记录
                appState.chatManager.messages.length = 0;
                
                // 导入消息
                importData.messages.forEach(msg => {
                    appState.chatManager.messages.push(msg);
                });
                
                // 保存到本地存储
                appState.chatManager.saveMessages();
                
                // 重新渲染聊天界面
                renderChatMessages();
                
                showBackupStatus(`成功导入 ${importData.messages.length} 条聊天记录`, 'success');
            } catch (error) {
                console.error('导入聊天记录失败:', error);
                showBackupStatus('导入聊天记录失败', 'error');
            }
        }
        
        // 备份到本地存储
        function backupToLocal() {
            const messages = appState.chatManager.getMessages();
            
            if (messages.length === 0) {
                showBackupStatus('没有聊天记录可以备份', 'error');
                return;
            }
            
            // 创建备份数据
            const backupData = {
                version: '1.0',
                backupTime: new Date().toISOString(),
                messageCount: messages.length,
                messages: messages
            };
            
            // 保存到本地存储
            localStorage.setItem('chatBackup', JSON.stringify(backupData));
            
            showBackupStatus(`成功备份 ${messages.length} 条聊天记录到本地`, 'success');
        }
        
        // 从本地存储恢复备份
        function restoreFromLocal() {
            const backupDataStr = localStorage.getItem('chatBackup');
            
            if (!backupDataStr) {
                showBackupStatus('没有找到本地备份', 'error');
                return;
            }
            
            try {
                const backupData = JSON.parse(backupDataStr);
                
                // 验证备份数据
                if (!backupData.messages || !Array.isArray(backupData.messages)) {
                    showBackupStatus('备份数据格式不正确', 'error');
                    return;
                }
                
                // 显示确认对话框
                showRestoreConfirm(backupData);
            } catch (error) {
                console.error('解析备份数据失败:', error);
                showBackupStatus('备份数据解析失败', 'error');
            }
        }
        
        // 显示恢复确认对话框
        function showRestoreConfirm(backupData) {
            document.getElementById('restore-confirm-dialog').style.display = 'flex';
            
            // 更新对话框内容
            const dialog = document.getElementById('restore-confirm-dialog');
            dialog.querySelector('h3').textContent = '恢复聊天记录';
            document.getElementById('restore-confirm-text').textContent = `恢复聊天记录将覆盖当前的所有消息，此操作不可撤销。确定要恢复 ${backupData.messageCount} 条消息吗？`;
            
            // 绑定确认按钮事件
            document.getElementById('confirm-restore-btn').onclick = function() {
                performRestore(backupData);
                document.getElementById('restore-confirm-dialog').style.display = 'none';
            };
            
            // 绑定取消按钮事件
            document.getElementById('cancel-restore-btn').onclick = function() {
                document.getElementById('restore-confirm-dialog').style.display = 'none';
            };
        }
        
        // 执行恢复操作
        function performRestore(backupData) {
            try {
                // 清空当前聊天记录
                appState.chatManager.messages.length = 0;
                
                // 恢复消息
                backupData.messages.forEach(msg => {
                    appState.chatManager.messages.push(msg);
                });
                
                // 保存到本地存储
                appState.chatManager.saveMessages();
                
                // 重新渲染聊天界面
                renderChatMessages();
                
                showBackupStatus(`成功恢复 ${backupData.messageCount} 条聊天记录`, 'success');
            } catch (error) {
                console.error('恢复聊天记录失败:', error);
                showBackupStatus('恢复聊天记录失败', 'error');
            }
        }
        
        // 显示备份操作状态
        function showBackupStatus(message, type) {
            const statusDiv = document.getElementById('backup-status');
            statusDiv.textContent = message;
            statusDiv.className = `backup-status backup-${type}`;
            statusDiv.style.display = 'block';
            
            // 3秒后自动隐藏
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化个性签名
            loadSignature();
            
            // 监听个性签名编辑事件
            const signatureElement = document.getElementById('desktop-signature');
            signatureElement.addEventListener('blur', saveSignature);
            signatureElement.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.blur(); // 保存并退出编辑模式
                }
            });
            
            // 绑定确认删除按钮
            document.getElementById('confirm-delete-btn').addEventListener('click', confirmDelete);
            document.getElementById('cancel-delete-btn').addEventListener('click', cancelDelete);
            
            // 绑定导入确认按钮
            document.getElementById('confirm-import-btn').addEventListener('click', function() {
                const importData = window.currentImportData;
                if (importData) {
                    performImport(importData);
                    document.getElementById('import-confirm-dialog').style.display = 'none';
                }
            });
            
            document.getElementById('cancel-import-btn').addEventListener('click', function() {
                document.getElementById('import-confirm-dialog').style.display = 'none';
            });
            
            // 绑定恢复确认按钮
            document.getElementById('confirm-restore-btn').addEventListener('click', function() {
                const backupData = window.currentBackupData;
                if (backupData) {
                    performRestore(backupData);
                    document.getElementById('restore-confirm-dialog').style.display = 'none';
                }
            });
            
            document.getElementById('cancel-restore-btn').addEventListener('click', function() {
                document.getElementById('restore-confirm-dialog').style.display = 'none';
            });
            
            // 绑定世界书相关事件
            document.getElementById('save-worldbook-btn').addEventListener('click', saveWorldbookRecord);
            document.getElementById('cancel-worldbook-btn').addEventListener('click', closeWorldbookModal);
            
            // 绑定删除世界书记录确认按钮
            document.getElementById('confirm-delete-worldbook-btn').addEventListener('click', confirmDeleteWorldbookRecord);
            document.getElementById('cancel-delete-worldbook-btn').addEventListener('click', cancelDeleteWorldbookRecord);
            
            // 绑定微博删除确认按钮
            document.getElementById('confirm-weibo-delete-btn').addEventListener('click', function() {
                weiboManager.confirmDeleteWeibo();
            });
            
            document.getElementById('cancel-weibo-delete-btn').addEventListener('click', function() {
                weiboManager.cancelDeleteWeibo();
            });
            
            // 初始化桌面时间
            updateDesktopTime();
            setInterval(updateDesktopTime, 1000);
            
            // 初始化时显示桌面
            document.querySelectorAll('.interface').forEach(interface => {
                interface.classList.remove('active');
            });
            document.getElementById('desktop-interface').classList.add('active');
            currentInterface = 'desktop';
            
            const savedPersona = localStorage.getItem('aiPersona');
            if (savedPersona) {
                const persona = JSON.parse(savedPersona);
                document.getElementById('persona-input').value = persona.description || '';   
            }
            
            const currentConfig = appState.apiService.getCurrentConfig();
            if (currentConfig.apiKey) {
                document.getElementById('api-key').value = currentConfig.apiKey || '';
                document.getElementById('api-url').value = currentConfig.apiUrl || 'https://api.openai.com/v1';
                document.getElementById('api-provider').value = currentConfig.provider || 'openai';
                document.getElementById('temperature').value = 0.7;
                document.getElementById('max-tokens').value = 1000;
                
                if (currentConfig.model) {
                    const modelSelect = document.getElementById('model-select');
                    setTimeout(() => {  
                        const options = Array.from(modelSelect.options);
                        const option = options.find(opt => opt.value === currentConfig.model);
                        if (option) {
                            option.selected = true;
                            updateSelectedModel();
                        }
                    }, 100);
                }
            }   
            
            const savedCSS = localStorage.getItem('customCSS');    
            if (savedCSS) {
                document.getElementById('css-editor').value = savedCSS;
                appState.customCSS = savedCSS;
                
                let styleElement = document.getElementById('global-css');
                if (!styleElement) {
                    styleElement = document.createElement('style');
                    styleElement.id = 'global-css';
                    document.head.appendChild(styleElement);
                }
                styleElement.textContent = savedCSS;
            }
            
            updateTemperatureValue();
            document.getElementById('temperature').addEventListener('input', updateTemperatureValue);
            
            updateApiEndpoints();
            
            updateStatusIndicators();
            
            // 渲染聊天记录
            renderChatMessages();
            
            // 初始化音乐播放器
            musicPlayer.init();
            
            // 初始化世界书状态指示灯
            updateWorldbookStatusIndicator();
        });
    </script>
</body>
</html>