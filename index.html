<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI手机应用</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #ffffff; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .phone-container { width: 380px; height: 666px; background: white; border: 16px solid #000; border-radius: 36px; overflow: hidden; position: relative; box-shadow: 0 30px 60px rgba(0,0,0,0.8); }
        .screen { width: 100%; height: 100%; position: relative; overflow: hidden; border-radius: 20px; }
        .interface { position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 20px; opacity: 0; pointer-events: none; transition: all 0.3s ease; background: white; display: flex; flex-direction: column; border-radius: 20px; }
        .interface.active { opacity: 1; pointer-events: all; }
        .header { text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 5px solid #000; position: relative; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .back-button { position: absolute; left: 0; background: white; border: 1px solid #000; padding: 6px 10px; border-radius: 20px; cursor: pointer; font-size: 12px; z-index: 1; }
        .header h1 { font-size: 21px; font-weight: 600; margin: 0; display: flex; gap: 8px; }
        .toggle-persona { position: absolute; right: 0; top: 0; background: white; border: 1px solid #000; padding: 6px 10px; border-radius: 20px; cursor: pointer; font-size: 12px; }
        .desktop-interface { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; display: none; flex-direction: column; align-items: center; justify-content: flex-start; color: #000; padding-top: 20px; }
        .desktop-interface.active { display: flex; }
        .app-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-top: 30px; padding: 0 20px; }
        .app-icon { width: 80px; height: 80px; background: #ffffff; border-radius: 27px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; font-size: 30px; }
        .app-icon:hover { transform: scale(1.1); background: #000000; }
        .app-label { margin-top: 10px; font-size: 15px; text-align: center; color: #000; }
        .app-item { display: flex; flex-direction: column; align-items: center; }
        .desktop-time { font-size: 110px; font-weight: 1000; margin-bottom: 10px; color: #000; }
        .desktop-signature { font-size: 18px; color: #000; margin-bottom: 20px; text-align: center; min-height: 24px; padding: 0 20px; width: 100%; cursor: text; transition: all 0.3s ease; outline: none; border: none; background: transparent; font-family: inherit; }
        .desktop-signature:focus { background: rgba(0,0,0,0.05); border-radius: 8px; }
        .chat-interface { padding-bottom: 0; }
        .scrollable-content { flex: 1; overflow-y: auto; margin-bottom: 0; -webkit-overflow-scrolling: touch; overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none; }
        .scrollable-content::-webkit-scrollbar { display: none; width: 0; background: transparent; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 10px; border: 1px solid #000; background: #fafafa; margin-bottom: 10px; scrollbar-width: none; -ms-overflow-style: none; }
        .chat-messages::-webkit-scrollbar { display: none; width: 0; background: transparent; }
        .chat-container { display: flex; flex-direction: column; height: 100%; }
        .chat-input-container { flex-shrink: 0; margin-top: auto; padding: 5px 0; background: white; }
        .chat-input { display: flex; gap: 10px; }
        .chat-input input { flex: 1; padding: 10px; border: 1px solid #000; border-radius: 5px; }
        .chat-input button { padding: 10px 20px; border: 1px solid #000; background: white; border-radius: 5px; cursor: pointer; }
        .chat-management-section { margin-top: 10px; padding: 15px; border: 1px solid #000; background: #fafafa; border-radius: 8px; }
        .chat-management-section h3 { margin-bottom: 10px; font-size: 16px; display: flex; align-items: center; gap: 8px; }
        .chat-management-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .chat-management-buttons button { flex: 1; padding: 8px 12px; border: 1px solid #000; background: white; border-radius: 5px; cursor: pointer; font-size: 12px; min-width: 120px; transition: all 0.2s ease; }
        .chat-management-buttons button:hover { background: #f0f0f0; transform: translateY(-1px); }
        .chat-management-buttons button.danger { background: #f8f8f8; border-color: #888; color: #333; }
        .chat-management-buttons button.danger:hover { background: #e0e0e0; }
        .selection-mode-info { padding: 8px; background: #f0f0f0; border-radius: 5px; margin-bottom: 10px; display: none; font-size: 12px; }
        .selection-mode-info.active { display: block; }
        .selection-count { font-weight: bold; color: #666; }
        .selection-actions { display: flex; gap: 8px; margin-top: 8px; display: none; }
        .selection-actions.active { display: flex; }
        .selection-actions button { flex: 1; padding: 6px 10px; border: 1px solid #000; background: white; border-radius: 5px; cursor: pointer; font-size: 11px; }
        .selection-actions button.danger { background: #f8f8f8; border-color: #888; color: #333; }
        .selection-actions button.danger:hover { background: #e0e0e0; }
        .message-checkbox { display: none; margin-left: 10px; cursor: pointer; }
        .selection-mode .message-checkbox { display: inline-block; }
        .message.selected { background: #f0f0f0 !important; border-color: #aaa !important; }
        .selection-mode .message-actions { display: none !important; }
        .backup-section { margin-top: 15px; padding: 15px; border: 1px solid #000; border-radius: 8px; background: #fafafa; }
        .backup-section h3 { margin-bottom: 10px; font-size: 16px; }
        .backup-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .backup-buttons button { flex: 1; padding: 8px 12px; border: 1px solid #000; background: white; border-radius: 5px; cursor: pointer; font-size: 12px; min-width: 120px; }
        .backup-buttons button:hover { background: #f0f0f0; }
        .backup-file-input { display: none; }
        .backup-status { margin-top: 10px; padding: 8px; border-radius: 5px; text-align: center; display: none; font-size: 12px; }
        .backup-success { background: #f0f0f0; border: 1px solid #000; color: #000; }
        .backup-error { background: #f0f0f0; border: 1px solid #000; color: #000; }
        .backup-info { font-size: 11px; color: #666; margin-top: 8px; text-align: center; }
        .message { max-width: 100%; padding: 10px; margin: 5px 0; border-radius: 20px; word-wrap: break-word; position: relative; transition: all 0.3s ease; opacity: 1; transform: scale(1); }
        .message:hover { background-color: transparent; }
        .message.selected:hover { background-color: #e8e8e8 !important; }
        .user-message { background: white; border: 1px solid #000; margin-left: auto; }
        .ai-message { background: white; border: 1px solid #000; margin-right: auto; }
        .message-sender { font-size: 16px; color: #000; margin-bottom: 3px; font-weight: 800; }
        .message-content { font-size: 13px; }
        .message-actions { position: absolute; top: 5px; display: none; right: 10px; gap: 5px; }
        .message:hover .message-actions { display: flex; }
        .message-action { background: rgba(255,255,255,0.9); border: 1px solid #000; border-radius: 3px; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 10px; }
        .message.editing { background: #FFFFFF; border-color: #FFFFFF; }
        .message.deleting { opacity: 0; transform: scale(0.5); max-height: 0; margin: 0; padding: 0; overflow: hidden; transition: all 0.3s ease; }
        .chat-input input:focus { border: 3px solid #4a6ee0 !important; outline: none !important; box-shadow: none !important; }
        .input:focus, textarea:focus, select:focus { border: 3px solid #4a6ee0 !important; outline: none !important; }
        .edit-input { width: 100%; padding: 8px; border: 1px solid #000; border-radius: 9px; font-size: 13px; resize: vertical; min-height: 80px; }
        .edit-actions { display: flex; gap: 10px; margin-top: 10px; justify-content: flex-end; }
        .edit-actions button { padding: 5px 10px; border: 1px solid #000; background: white; border-radius: 3px; cursor: pointer; font-size: 12px; }
        .persona-editor { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; margin-bottom: 10px; }
        .persona-editor.expanded { max-height: 100px; }
        .persona-form { padding: 15px; border: 2px solid #000; border-radius: 5px; background: #fafafa; }
        .form-group { margin-bottom: 5px; }
        .form-group label { display: block; margin-bottom: 4px; font-size: 14px; }
        .form-input { width: 100%; padding: 8px; border: 1px solid #000; border-radius: 9px; background: white; }
        .persona-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .persona-actions button { flex: 1; padding: 5px; border: 1px solid #000; background: white; border-radius: 20px; cursor: pointer; min-width: 50px; }
        input, textarea { border: 2px solid #ddd; border-radius: 8px; padding: 12px 15px; width: 100%; background: white; }
        input:focus, textarea:focus { border: 3px solid #4a6ee0 !important; outline: none; box-shadow: none; }
        input:-webkit-autofill { -webkit-box-shadow: 0 0 0px 1000px white inset; border: 3px solid #4a6ee0 !important; }
        #api-interface .header h1 { margin-left: 20px; }
        .api-section { margin-bottom: 15px; padding: 15px; border: 1px solid #000; }
        .api-section h3 { margin-bottom: 10px; }
        .api-input { width: 100%; padding: 8px; border: 1px solid #000; margin-bottom: 10px; border-radius: 5px; }
        .api-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .api-buttons button { padding: 8px 15px; border: 1px solid #000; background: white; border-radius: 5px; cursor: pointer; flex: 1; }
        .api-status { margin-top: 10px; padding: 8px; border-radius: 5px; text-align: center; display: none; }
        .status-success { background: #f0f0f0; border: 1px solid #000; }
        .status-error { background: #f0f0f0; border: 1px solid #000; }
        .style-container { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 400px; }
        .ai-circle { width: 120px; height: 120px; border: 3px solid #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 50px; font-weight: bold; margin: 20px 0; }
        .css-editor { width: 100%; height: 200px; padding: 10px; border: 1px solid #000; border-radius: 8px; font-family: monospace; resize: vertical; }
        .apply-css { width: 100%; padding: 10px; border: 1px solid #000; background: white; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        .app-navigation { position: relative; width: 100%; height: 2px; background: #000; flex-shrink: 0; display: none; }
        .desktop-interface .app-navigation { display: none; }
        #api-interface .app-navigation, #style-interface .app-navigation, #chat-interface .app-navigation { display: none; }
        .interface.exiting { transform: translateX(-100%); opacity: 0; }
        .interface.entering { transform: translateX(100%); }
        .interface.entering.active { transform: translateX(0); }
        .scroll-hint { text-align: center; font-size: 10px; color: #666; margin-top: 10px; display: none; }
        .confirm-dialog { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .confirm-content { background: white; padding: 20px; border: 2px solid #000; border-radius: 10px; text-align: center; max-width: 300px; margin: 0 20px; }
        .confirm-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .confirm-buttons button { flex: 1; padding: 8px; border: 1px solid #000; background: white; border-radius: 5px; cursor: pointer; }
        .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; transition: all 0.3s ease; }
        .status-online { background: #00ff00; }
        .status-offline { background: #ff0000; }
        .status-generating { background: #00ff00; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .loading { opacity: 0.7; pointer-events: none; }
        .typing-indicator { display: inline-block; margin-left: 5px; }
        .typing-dot { display: inline-block; width: 4px; height: 4px; background: #000; border-radius: 50%; margin: 0 1px; animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-5px); } }
        .model-list { max-height: 200px; overflow-y: auto; border: 1px solid #000; margin-top: 10px; padding: 10px; background: #fafafa; scrollbar-width: none; -ms-overflow-style: none; }
        .model-list::-webkit-scrollbar { display: none; width: 0; background: transparent; }
        .model-item { padding: 5px; border-bottom: 1px solid #eee; cursor: pointer; }
        .model-item:hover { background: #f0f0f0; }
        .model-item:last-child { border-bottom: none; }
        .refresh-status { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .refresh-button { background: white; border: 1px solid #000; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
        .last-updated { font-size: 12px; color: #666; }
        .model-info { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding: 5px; background: #ffffff; border-radius: 3px; }
        .current-model { font-size: 14px; font-weight: 600; }
        .model-badge { background: #000; color: white; padding: 3px 6px; border-radius: 10px; font-size: 12px; }
        .persona-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1001; }
        .modal-content { background: white; width: 90%; max-width: 350px; max-height: 80vh; border: 2px solid #000; border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; border-bottom: 1px solid #000; background: #fafafa; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 16px; }
        .close-modal { background: none; border: none; font-size: 20px; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
        .modal-body { flex: 1; overflow-y: auto; padding: 15px; scrollbar-width: none; -ms-overflow-style: none; }
        .modal-body::-webkit-scrollbar { display: none; width: 0; background: transparent; }
        .persona-tabs { display: flex; border-bottom: 1px solid #000; margin-bottom: 15px; }
        .persona-tab { flex: 1; padding: 10px; text-align: center; border: none; background: white; cursor: pointer; border-bottom: 2px solid transparent; }
        .persona-tab.active { border-bottom: 2px solid #000; font-weight: 600; }
        .persona-form-section { display: none; }
        .persona-form-section.active { display: block; }
        .form-section { margin-bottom: 20px; padding: 15px; border: 1px solid #000; border-radius: 5px; }
        .form-section h4 { margin-bottom: 10px; font-size: 14px; }
        .persona-preview { margin-top: 15px; padding: 10px; border: 1px solid #000; border-radius: 5px; background: #fafafa; font-size: 12px; }
        .persona-preview h5 { margin-bottom: 5px; font-size: 12px; color: #000; }
        #multi-preview-content { color: #000; }
        #multi-preview-content div { color: #000; border-color: #000; }
        .style-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; width: 100%; }
        .style-buttons button { flex: 1; padding: 10px; border: 1px solid #000; background: white; border-radius: 5px; cursor: pointer; min-width: 120px; }
        .music-player { display: flex; flex-direction: column; height: 100%; background: white; }
        .music-fixed-area { flex-shrink: 0; display: flex; flex-direction: column; align-items: center; padding: 10px 15px 5px; }
        .music-scrollable-area { flex: 1; overflow-y: auto; padding: 5px 15px 15px; scrollbar-width: none; -ms-overflow-style: none; }
        .music-scrollable-area::-webkit-scrollbar { display: none; width: 0; background: transparent; }
        .disc-container { width: 220px; height: 220px; margin: 15px 0 20px; display: flex; justify-content: center; align-items: center; position: relative; }
        .disc { width: 100%; height: 100%; background: radial-gradient(circle, #333 0%, #000 100%); border-radius: 50%; display: flex; justify-content: center; align-items: center; position: relative; animation: rotate 20s linear infinite; animation-play-state: paused; }
        .disc-center { width: 40px; height: 40px; background-color: #fff; border-radius: 50%; z-index: 2; }
        .disc.playing { animation-play-state: running; }
        .song-info { margin-bottom: 15px; width: 100%; text-align: center; }
        .song-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #000; }
        .song-artist { font-size: 14px; color: #555; }
        .progress-container { width: 100%; margin-bottom: 15px; }
        .progress-info { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12px; color: #555; }
        .progress-bar { width: 100%; height: 4px; background-color: #ddd; border-radius: 2px; cursor: pointer; position: relative; overflow: hidden; }
        .progress { height: 100%; background-color: #000; border-radius: 2px; width: 0%; transition: width 0.1s; }
        .control-buttons { display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 15px; }
        .btn { background: none; border: none; cursor: pointer; font-size: 20px; color: #000; width: 20px; height: 40px; display: flex; justify-content: center; align-items: center; border-radius: 50%; transition: all 0.3s; }
        .btn:hover { background-color: #f0f0f0; }
        .btn-play { width: 50px; height: 50px; background-color: #000; color: #fff; font-size: 18px; display: flex; justify-content: center; align-items: center; padding-bottom: 2px; }
        .btn-play:hover { background-color: #333; transform: scale(1.05); }
        .btn-loop { font-size: 18px; width: 40px; height: 40px; background: none; border: none; cursor: pointer; padding: 0 20px; }
        .import-section { margin-top: 5px; width: 100%; max-width: 100%; }
        .import-btn { width: 100%; padding: 10px; background: white; border: 2px solid #000; border-radius: 8px; text-align: center; cursor: pointer; margin-bottom: 10px; transition: all 0.2s ease; font-size: 14px; }
        .import-btn:hover { background: #f0f0f0; }
        .file-input { display: none; }
        .playlist { width: 100%; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 8px; margin-top: 10px; border: 2px solid #000000; font-size: 12px; scrollbar-width: none; -ms-overflow-style: none; }
        .playlist::-webkit-scrollbar { display: none; width: 0; background: transparent; }
        .playlist-item { padding: 6px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .playlist-item:last-child { border-bottom: none; }
        .playlist-item:hover { background: #f9f9f9; }
        .playlist-item.active { background: #f0f0f0; font-weight: bold; }
        .song-duration { font-size: 10px; color: #666; margin-left: 8px; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #music-interface .header h1 { margin-left: 30px; }
        .music-title { font-size: 16px; font-weight: bold; margin-bottom: 8px; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .music-artist { font-size: 12px; color: #666; margin-bottom: 15px; text-align: center; width: 100%; }
        .disc-container::before { content: ""; display: block; padding-top: 100%; }
        .disc-container > * { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .worldbook-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #worldbook-interface .header { display: flex; justify-content: space-between; align-items: center; position: relative; }
        #worldbook-interface .header h1 { flex: 1; text-align: center; margin: 0; display: flex; align-items: center; justify-content: center; gap: 8px; padding-left: 40px; font-size: 22px; }
        #worldbook-interface .add-worldbook-btn { background: none; border: none; font-size: 36px; cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; position: relative; right: 0; color: #000; font-weight: normal; transition: all 0.2s ease; }
        #worldbook-interface .add-worldbook-btn:hover { transform: scale(1.1); color: #333; }
        #worldbook-interface h2 { display: flex; align-items: center; gap: 8px; font-size: 20px; }
        .worldbook-list { display: flex; flex-direction: column; gap: 10px; }
        .worldbook-item { border: 1px solid #000; border-radius: 8px; padding: 12px; background: white; position: relative; }
        .worldbook-title { font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        .worldbook-content { font-size: 12px; color: #333; margin-bottom: 10px; max-height: 60px; overflow: hidden; position: relative; }
        .worldbook-content.expanded { max-height: none; overflow: visible; }
        .worldbook-actions { display: flex; gap: 8px; justify-content: flex-end; }
        .worldbook-action { background: white; border: 1px solid #000; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .worldbook-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1002; }
        .worldbook-modal-content { background: white; padding: 20px; border: 2px solid #000; border-radius: 10px; width: 90%; max-width: 350px; }
        .worldbook-form-group { margin-bottom: 15px; }
        .worldbook-form-group label { display: block; margin-bottom: 5px; font-size: 14px; }
        .worldbook-form-input { width: 100%; padding: 8px; border: 1px solid #000; border-radius: 5px; font-size: 14px; }
        .worldbook-form-textarea { width: 100%; padding: 8px; border: 1px solid #000; border-radius: 5px; font-size: 14px; resize: vertical; min-height: 100px; }
        .worldbook-form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; }
        .worldbook-form-btn { padding: 8px 15px; border: 1px solid #000; background: white; border-radius: 5px; cursor: pointer; }
        .worldbook-status { margin-top: 10px; padding: 8px; border-radius: 5px; text-align: center; display: none; font-size: 12px; }
        .worldbook-status-success { background: #f0f0f0; border: 1px solid #000; color: #000; }
        .worldbook-status-error { background: #f0f0f0; border: 1px solid #000; color: #000; }
        .worldbook-toggle { position: absolute; right: 10px; top: 10px; background: white; border: 1px solid #000; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px; }
        .worldbook-active-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; }
        .worldbook-active { background: #00ff00; }
        .worldbook-inactive { background: #ff0000; }
        .worldbook-backup-section { margin-top: 20px; padding: 15px; border: 1px solid #000; border-radius: 8px; background: #fafafa; }
        .worldbook-backup-section h3 { margin-bottom: 10px; font-size: 16px; display: flex; align-items: center; gap: 8px; }
        .worldbook-backup-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .worldbook-backup-buttons button { flex: 1; padding: 8px 12px; border: 1px solid #000; background: white; border-radius: 5px; cursor: pointer; font-size: 12px; min-width: 120px; transition: all 0.2s ease; }
        .worldbook-backup-buttons button:hover { background: #f0f0f0; transform: translateY(-1px); }
        .worldbook-backup-status { margin-top: 10px; padding: 8px; border-radius: 5px; text-align: center; display: none; font-size: 12px; }
        .worldbook-backup-success { background: #f0f0f0; border: 1px solid #000; color: #000; }
        .worldbook-backup-error { background: #f0f0f0; border: 1px solid #000; color: #000; }
        .worldbook-backup-info { font-size: 11px; color: #666; margin-top: 8px; text-align: center; }
        .worldbook-backup-file-input { display: none; }
        .wallet-container { max-width: 100%; margin: 0 auto; padding: 0 10px; overflow-x: hidden; }
        .balance-card { background: #000; color: #fff; border-radius: 15px; padding: 25px; text-align: center; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); margin-bottom: 25px; border: 2px solid #000; overflow: hidden; width: 100%; box-sizing: border-box; }
        .balance-label { font-size: 0.9em; opacity: 0.8; margin-bottom: 8px; }
        .balance-amount { font-size: 2.2em; font-weight: bold; letter-spacing: 1px; margin: 10px 0; word-wrap: break-word; overflow-wrap: break-word; max-width: 100%; padding: 0 10px; }
        .balance-sub-info { font-size: 0.9em; opacity: 0.8; display: flex; justify-content: space-around; margin-top: 15px; flex-wrap: wrap; }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .action-btn { background: #000; color: #fff; border: 2px solid #000; border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s ease; font-weight: 500; }
        .action-btn:hover { background: #333; transform: translateY(-2px); }
        .action-btn .icon { font-size: 1.2em; margin-bottom: 5px; display: block; }
        .transaction-section { margin-top: 20px; border-radius: 10px; background: #f9f9f9; overflow: hidden; }
        .transaction-section h3 { margin-bottom: 15px; font-size: 1.1em; color: #000; text-align: center; padding: 15px; border-bottom: 1px solid #ddd; }
        .transaction-list { max-height: 300px; overflow-y: auto; padding: 10px; }
        .transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 10px; border-bottom: 1px solid #eee; }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-info { flex: 1; }
        .transaction-title { font-weight: bold; font-size: 0.9em; margin-bottom: 3px; }
        .transaction-date { font-size: 0.8em; color: #666; }
        .transaction-amount { font-weight: bold; font-size: 1em; }
        .transaction-expense { color: #ff4444; }
        .transaction-income { color: #00aa00; }
        .empty-state { padding: 30px 0; color: #666; text-align: center; }
        #wallet-interface .header h1 { margin-left: 30px; }
        .wallet-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center; }
        .wallet-modal-content { background: #fff; padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); }
        .wallet-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .wallet-modal-title { font-size: 1.3em; font-weight: bold; color: #000; }
        .wallet-close-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #000; }
        .wallet-input-group { margin-bottom: 20px; }
        .wallet-input-label { display: block; margin-bottom: 8px; color: #000; font-weight: 500; }
        .amount-input { width: 100%; padding: 12px 15px; border: 2px solid #000; border-radius: 8px; font-size: 1.1em; text-align: center; transition: all 0.3s ease; }
        .amount-input:focus { outline: none; border-color: #007AFF; }
        .wallet-confirm-btn { width: 100%; background: #000; color: #fff; border: 2px solid #000; border-radius: 8px; padding: 12px; font-size: 1.1em; cursor: pointer; transition: background 0.3s ease; }
        .wallet-confirm-btn:hover { background: #333; }
        .utility-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center; }
        .utility-modal-content { background: #fff; padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); }
        .utility-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .utility-modal-title { font-size: 1.3em; font-weight: bold; color: #000; }
        .utility-close-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #000; }
        .house-type-selector { margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 10px; border: 1px solid #ddd; }
        .house-type-selector label { display: block; margin-bottom: 8px; color: #000; font-weight: 500; }
        .house-type-select { width: 100%; padding: 12px 15px; border: 2px solid #000; border-radius: 8px; font-size: 1em; background-color: white; }
        .utility-info { margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 10px; border: 1px solid #ddd; }
        .utility-item { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1em; }
        .utility-total { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd; font-weight: bold; font-size: 1.1em; }
        .utility-confirm-btn { width: 100%; background: #000; color: #fff; border: 2px solid #000; border-radius: 8px; padding: 12px; font-size: 1.1em; cursor: pointer; transition: background 0.3s ease; }
        .utility-confirm-btn:hover { background: #333; }
        @media (max-width: 480px) { .balance-amount { font-size: 1.8em; } .action-buttons { grid-template-columns: 1fr; gap: 10px; } .balance-sub-info { flex-direction: column; gap: 5px; } }
        #weibo-interface .header h1 { margin-left: 25px; }
        .weibo-container { max-width: 100%; margin: 0 auto; border-left: 1px solid #f0f0f0; border-right: 1px solid #f0f0f0; min-height: 100vh; background: white; overflow-y: auto; padding: 0; }
        .weibo-header { position: sticky; top: 0; background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #e0e0e0; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .weibo-logo { font-weight: 700; font-size: 20px; }
        .weibo-nav a { color: #000; text-decoration: none; margin-left: 20px; font-size: 14px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; }
        .weibo-nav a.active { background-color: #000; color: #fff; }
        .weibo-nav a:hover { background-color: #f0f0f0; }
        .weibo-page-content { display: none; }
        .weibo-page-content.active { display: block; }
        .weibo-category-section { padding: 16px; border-bottom: 1px solid #f0f0f0; background-color: #fafafa; }
        .weibo-category-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .weibo-category-title { font-weight: 600; font-size: 16px; }
        .weibo-manage-categories-btn { background: none; border: 1px solid #000; border-radius: 4px; padding: 4px 12px; font-size: 12px; cursor: pointer; transition: all 0.2s; }
        .weibo-manage-categories-btn:hover { background-color: #000; color: #fff; }
        .weibo-category-tags { display: flex; flex-wrap: wrap; gap: 8px; }
        .weibo-category-tag { background-color: #fff; border: 1px solid #000; border-radius: 16px; padding: 4px 12px; font-size: 12px; cursor: pointer; transition: all 0.3s ease; color: #000; }
        .weibo-category-tag.active { background-color: #000; color: #fff; }
        .weibo-category-tag:hover { background-color: #f0f0f0; transform: translateY(-1px); }
        .weibo-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center; }
        .weibo-modal-content { background-color: #fff; padding: 24px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .weibo-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .weibo-close-modal { background: none; border: none; font-size: 20px; cursor: pointer; }
        .weibo-category-input-group { display: flex; margin-bottom: 16px; }
        .weibo-category-input { flex: 1; border: 1px solid #e0e0e0; border-radius: 4px 0 0 4px; padding: 8px; outline: none; }
        .weibo-add-category-btn { background-color: #000; color: #fff; border: none; border-radius: 0 4px 4px 0; padding: 0 16px; cursor: pointer; }
        .weibo-category-list { max-height: 200px; overflow-y: auto; }
        .weibo-category-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .weibo-delete-category { background: none; border: none; color: #666; cursor: pointer; }
        .weibo-profile-form { display: flex; flex-direction: column; gap: 16px; }
        .weibo-form-group { display: flex; flex-direction: column; gap: 8px; }
        .weibo-form-group label { font-size: 14px; font-weight: 600; }
        .weibo-form-group input, .weibo-form-group textarea { border: 1px solid #e0e0e0; border-radius: 4px; padding: 8px; font-family: inherit; font-size: 14px; outline: none; }
        .weibo-form-group textarea { resize: vertical; min-height: 80px; }
        .weibo-save-profile-btn { background-color: #000; color: #fff; border: none; border-radius: 4px; padding: 10px; font-size: 14px; cursor: pointer; margin-top: 8px; }
        .weibo-compose-section { padding: 16px; border-bottom: 1px solid #f0f0f0; }
        .weibo-compose-box { display: flex; gap: 12px; }
        .weibo-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #000; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 16px; }
        .weibo-compose-input { flex: 1; }
        .weibo-compose-input textarea { width: 100%; border: 1px solid #e0e0f0; border-radius: 8px; padding: 12px; font-family: inherit; font-size: 14px; resize: none; outline: none; height: 60px; }
        .weibo-compose-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
        .weibo-category-select { border: 1px solid #e0e0f0; border-radius: 4px; padding: 6px 12px; font-size: 12px; background: none; }
        .weibo-publish-btn { background-color: #000; color: #fff; border: none; border-radius: 20px; padding: 6px 20px; font-size: 13px; cursor: pointer; }
        .weibo-list { padding: 0; }
        .weibo-item { padding: 16px; border-bottom: 1px solid #f0f0f0; display: flex; gap: 12px; }
        .weibo-content { flex: 1; }
        .weibo-item-header { display: flex; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 8px; }
        .weibo-username { font-weight: 600; margin-right: 8px; }
        .weibo-item-category { background-color: #f0f0f0; border-radius: 12px; padding: 2px 8px; font-size: 10px; color: #666; }
        .weibo-timestamp { color: #666; font-size: 12px; }
        .weibo-item-text { margin-bottom: 12px; font-size: 14px; line-height: 1.5; }
        .weibo-item-actions { display: flex; gap: 20px; }
        .weibo-item-actions button { background: none; border: none; color: #666; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px; transition: all 0.2s; padding: 4px 8px; border-radius: 4px; }
        .weibo-item-actions button:hover { background-color: #f0f0f0; }
        .weibo-item-actions button.liked { color: #ff4d4f; border-color: #ff4d4f; }
        .weibo-item-actions button.liked:hover { background-color: #fff1f0; }
        .weibo-item-actions button.delete-btn { color: #000; }
        .weibo-item-actions button.delete-btn:hover { background-color: #f0f0f0; }
        .weibo-discover-section { padding: 16px; }
        .weibo-discover-title { font-weight: 600; font-size: 18px; margin-bottom: 16px; }
        .weibo-trending-topics { margin-bottom: 24px; }
        .weibo-trending-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .weibo-trending-title { font-weight: 600; font-size: 16px; }
        .weibo-refresh-btn { background: none; border: 1px solid #000; border-radius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer; }
        .weibo-topic-list { display: flex; flex-direction: column; gap: 8px; }
        .weibo-topic-item { padding: 12px; border: 1px solid #f0f0f0; border-radius: 8px; cursor: pointer; }
        .weibo-topic-name { font-weight: 600; margin-bottom: 4px; }
        .weibo-topic-stats { font-size: 12px; color: #666; }
        .weibo-recommended-users { margin-bottom: 24px; }
        .weibo-user-list { display: flex; flex-direction: column; gap: 12px; }
        .weibo-user-item { display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 8px; cursor: pointer; }
        .weibo-user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #000; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 16px; }
        .weibo-user-info { flex: 1; }
        .weibo-user-name { font-weight: 600; font-size: 14px; }
        .weibo-user-bio { font-size: 12px; color: #666; margin-top: 2px; }
        .weibo-follow-btn { background: none; border: 1px solid #000; border-radius: 16px; padding: 4px 12px; font-size: 12px; cursor: pointer; }
        .weibo-random-quote { padding: 16px; background-color: #fafafa; border-radius: 8px; text-align: center; font-style: italic; margin-top: 16px; }
        .weibo-comment-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center; }
        .weibo-comment-content { background-color: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .weibo-comment-input { width: 100%; border: 1px solid #e0e0f0; border-radius: 4px; padding: 12px; font-family: inherit; font-size: 14px; resize: none; outline: none; min-height: 80px; margin-bottom: 12px; }
        .weibo-comment-actions { display: flex; justify-content: flex-end; gap: 12px; }
        .weibo-cancel-comment { background: none; border: 1px solid #000; border-radius: 4px; padding: 6px 12px; cursor: pointer; }
        .weibo-submit-comment { background-color: #000; color: #fff; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; }
        .weibo-comments-list { margin-top: 16px; max-height: 200px; overflow-y: auto; }
        .weibo-comment-item { padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .weibo-comment-user { font-weight: 600; margin-right: 8px; }
        .weibo-comment-text { margin-top: 4px; }
        .chat-character-profile { margin-top: 20px; padding: 16px; border: 1px solid #e0e0f0; border-radius: 8px; background-color: #fafafa; }
        .chat-character-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .chat-character-avatar { width: 60px; height: 60px; border-radius: 50%; background-color: #000; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 24px; }
        .chat-character-info { flex: 1; }
        .chat-character-name { font-weight: 600; font-size: 18px; margin-bottom: 4px; }
        .chat-character-bio { font-size: 14px; color: #666; }
        .chat-character-stats { display: flex; gap: 16px; margin-bottom: 16px; }
        .chat-character-stat { text-align: center; }
        .chat-character-stat-number { font-weight: 600; font-size: 16px; }
        .chat-character-stat-label { font-size: 12px; color: #666; }
        .chat-character-edit-btn { background-color: #000; color: #fff; border: none; border-radius: 4px; padding: 8px 16px; font-size: 14px; cursor: pointer; width: 100%; }
        @media (max-width: 600px) { .weibo-container { border: none; } }
        .chat-mode-switch { margin-top: 10px; padding: 8px; background: #f0f0f0; border: 1px solid #000; border-radius: 5px; display: flex; align-items: center; justify-content: space-between; font-size: 12px; }
        .chat-mode-label { font-weight: bold; }
        .chat-mode-buttons { display: flex; gap: 5px; }
        .chat-mode-btn { padding: 4px 8px; border: 1px solid #000; background: white; border-radius: 3px; cursor: pointer; font-size: 11px; transition: all 0.2s ease; }
        .chat-mode-btn.active { background: #000; color: white; }
        .chat-mode-btn:hover { background: #f0f0f0; }
        .chat-mode-btn.active:hover { background: #333; }
        .chat-mode-indicator { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-left: 5px; vertical-align: middle; }
        .chat-mode-online { background: #00ff00; }
        .chat-mode-offline { background: #ff0000; }
        .chat-mode-description { font-size: 10px; color: #666; margin-top: 4px; text-align: center; }
        .chat-type-switch { margin-top: 10px; padding: 8px; background: #f0f0f0; border: 1px solid #000; border-radius: 5px; display: flex; align-items: center; justify-content: space-between; font-size: 12px; }
        .chat-type-label { font-weight: bold; }
        .chat-type-buttons { display: flex; gap: 5px; }
        .chat-type-btn { padding: 4px 8px; border: 1px solid #000; background: white; border-radius: 3px; cursor: pointer; font-size: 11px; transition: all 0.2s ease; }
        .chat-type-btn.active { background: #000; color: white; }
        .chat-type-btn:hover { background: #f0f0f0; }
        .chat-type-btn.active:hover { background: #333; }
        .multi-persona-selector { margin-top: 10px; padding: 8px; background: #f0f0f0; border: 1px solid #000; border-radius: 5px; display: none; font-size: 12px; }
        .multi-persona-selector.active { display: block; }
        .multi-persona-label { font-weight: bold; margin-bottom: 5px; display: block; }
        .persona-select { width: 100%; padding: 5px; border: 1px solid #000; border-radius: 3px; background: white; font-size: 11px; }
        .multi-persona-management { margin-top: 5px; display: flex; gap: 5px; }
        .multi-persona-management button { flex: 1; padding: 4px 8px; border: 1px solid #000; background: white; border-radius: 3px; cursor: pointer; font-size: 10px; }
        .multi-persona-management button:hover { background: #f0f0f0; }
    </style>
</head>
<body>
    <div class="confirm-dialog" id="confirm-dialog"><div class="confirm-content"><h3>确认删除</h3><p>您确定要删除这条消息吗？此操作不可撤销。</p><div class="confirm-buttons"><button id="confirm-delete-btn">确认删除</button><button id="cancel-delete-btn">取消</button></div></div></div>
    <div class="confirm-dialog" id="import-confirm-dialog"><div class="confirm-content"><h3>导入聊天记录</h3><p>导入聊天记录将覆盖当前的所有消息，此操作不可撤销。确定要继续吗？</p><div class="confirm-buttons"><button id="confirm-import-btn">确认导入</button><button id="cancel-import-btn">取消</button></div></div></div>
    <div class="confirm-dialog" id="restore-confirm-dialog"><div class="confirm-content"><h3>恢复聊天记录</h3><p id="restore-confirm-text">恢复聊天记录将覆盖当前的所有消息，此操作不可撤销。确定要恢复吗？</p><div class="confirm-buttons"><button id="confirm-restore-btn">确认恢复</button><button id="cancel-restore-btn">取消</button></div></div></div>
    <div class="confirm-dialog" id="clear-chat-dialog"><div class="confirm-content"><h3>清空聊天记录</h3><p id="clear-chat-text">您确定要清空所有聊天记录吗？此操作不可撤销。</p><div class="confirm-buttons"><button id="confirm-clear-chat-btn">确认清空</button><button id="cancel-clear-chat-btn">取消</button></div></div></div>
    <div class="confirm-dialog" id="delete-selected-dialog"><div class="confirm-content"><h3>删除选中消息</h3><p id="delete-selected-text">您确定要删除选中的消息吗？此操作不可撤销。</p><div class="confirm-buttons"><button id="confirm-delete-selected-btn">确认删除</button><button id="cancel-delete-selected-btn">取消</button></div></div></div>
    <div class="confirm-dialog" id="delete-worldbook-dialog"><div class="confirm-content"><h3>删除世界书记录</h3><p>您确定要删除这个记录吗？此操作不可撤销。</p><div class="confirm-buttons"><button id="confirm-delete-worldbook-btn">确认删除</button><button id="cancel-delete-worldbook-btn">取消</button></div></div></div>
    <div class="confirm-dialog" id="weibo-delete-dialog"><div class="confirm-content"><h3>删除微博</h3><p>您确定要删除这条微博吗？此操作不可撤销。</p><div class="confirm-buttons"><button id="confirm-weibo-delete-btn">确认删除</button><button id="cancel-weibo-delete-btn">取消</button></div></div></div>
    <div class="wallet-modal" id="rechargeModal"><div class="wallet-modal-content"><div class="wallet-modal-header"><h2 class="wallet-modal-title">手机充值</h2><button class="wallet-close-btn" id="closeModal">&times;</button></div><div class="wallet-input-group"><label class="wallet-input-label">充值金额 (元)</label><input type="number" class="amount-input" id="rechargeAmount" placeholder="请输入充值金额" min="1" step="0.01"></div><button class="wallet-confirm-btn" id="confirmRecharge">确认充值</button></div></div>
    <div class="utility-modal" id="utilityModal"><div class="utility-modal-content"><div class="utility-modal-header"><h2 class="utility-modal-title">本月水电费</h2><button class="utility-close-btn" id="closeUtilityModal">&times;</button></div><div class="house-type-selector"><label for="houseTypeSelect">选择房型</label><select class="house-type-select" id="houseTypeSelect"><option value="豪宅、庄园、城堡">豪宅、庄园、城堡</option><option value="别墅、独栋">别墅、独栋</option><option value="高档公寓、大平层">高档公寓、大平层</option><option value="普通公寓、居民楼、小区">普通公寓、居民楼、小区</option><option value="经济适用房、小户型">经济适用房、小户型</option><option value="宿舍、合租房">宿舍、合租房</option><option value="老破小、旧房" selected>老破小、旧房</option><option value="农村自建房、乡村">农村自建房、乡村</option></select></div><div class="utility-info"><div class="utility-item"><span>当前房型:</span><span id="utility-house-type">老破小</span></div><div class="utility-item"><span>水费:</span><span id="utility-water">0.00 元</span></div><div class="utility-item"><span>电费:</span><span id="utility-electricity">0.00 元</span></div><div class="utility-total"><span>总计:</span><span id="utility-total">0.00 元</span></div></div><button class="utility-confirm-btn" id="confirmUtility">确认缴纳</button></div></div>
    <div class="persona-modal" id="persona-modal"><div class="modal-content"><div class="modal-header"><h3>人设管理</h3><button class="close-modal" onclick="closePersonaModal()">×</button></div><div class="modal-body"><div class="persona-tabs"><button class="persona-tab active" onclick="switchPersonaTab('ai')">角色人设</button><button class="persona-tab" onclick="switchPersonaTab('user')">我的人设</button><button class="persona-tab" onclick="switchPersonaTab('multi')" id="multi-persona-tab">多聊角色</button></div><div class="persona-form-section active" id="ai-persona-section"><div class="form-section"><h4>角色人设</h4><div class="form-group"><label for="ai-persona-name">姓名</label><input type="text" class="form-input" id="ai-persona-name" placeholder="输入姓名..."></div><div class="form-group"><label for="ai-persona-desc">人设描述</label><textarea class="form-input" id="ai-persona-desc" rows="3" placeholder="输入人设描述..."></textarea></div><div class="persona-actions"><button onclick="saveAIPersona()">保存角色</button><button onclick="loadAIPersona()">加载角色</button></div></div><div class="persona-preview" id="ai-persona-preview"><h5>人设预览：</h5><div id="ai-preview-content">暂无人设</div></div></div><div class="persona-form-section" id="user-persona-section"><div class="form-section"><h4>我的人设</h4><div class="form-group"><label for="user-persona-name">姓名</label><input type="text" class="form-input" id="user-persona-name" placeholder="输入姓名..."></div><div class="form-group"><label for="user-persona-desc">人设描述</label><textarea class="form-input" id="user-persona-desc" rows="3" placeholder="输入人设描述..."></textarea></div><div class="persona-actions"><button onclick="saveUserPersona()">保存我的</button><button onclick="loadUserPersona()">加载我的</button></div></div><div class="persona-preview" id="user-persona-preview"><h5>人设预览：</h5><div id="user-preview-content">暂无我的人设</div></div></div><div class="persona-form-section" id="multi-persona-section"><div class="form-section"><h4>多聊角色</h4><div class="form-group"><label for="multi-persona-name">姓名</label><input type="text" class="form-input" id="multi-persona-name" placeholder="输入姓名..."></div><div class="form-group"><label for="multi-persona-desc">人设描述</label><textarea class="form-input" id="multi-persona-desc" rows="3" placeholder="输入人设描述..."></textarea></div><div class="persona-actions"><button onclick="addMultiPersona()">添加角色</button><button onclick="saveMultiPersonas()">保存所有角色</button></div></div><div class="persona-preview" id="multi-persona-preview"><h5>多聊角色预览：</h5><div id="multi-preview-content">暂无多聊角色</div></div></div></div></div></div>
    <div class="worldbook-modal" id="worldbook-modal"><div class="worldbook-modal-content"><h3 id="worldbook-modal-title">添加世界书记录</h3><div class="worldbook-form-group"><label for="worldbook-title">记录标题</label><input type="text" class="worldbook-form-input" id="worldbook-title" placeholder="输入记录标题..."></div><div class="worldbook-form-group"><label for="worldbook-content">记录内容</label><textarea class="worldbook-form-textarea" id="worldbook-content" placeholder="输入记录内容..."></textarea></div><div class="worldbook-form-actions"><button class="worldbook-form-btn" id="save-worldbook-btn">保存</button><button class="worldbook-form-btn" id="cancel-worldbook-btn">取消</button></div><div class="worldbook-status" id="worldbook-status"></div></div></div>
    <div class="weibo-modal" id="chatCharacterModal"><div class="weibo-modal-content"><div class="weibo-modal-header"><h3>编辑聊天角色主页</h3><button class="weibo-close-modal" id="closeChatCharacterModal">×</button></div><div class="weibo-profile-form"><div class="weibo-form-group"><label for="chatCharacterName">角色姓名</label><input type="text" id="chatCharacterName" placeholder="请输入角色姓名"></div><div class="weibo-form-group"><label for="chatCharacterBio">角色简介</label><textarea id="chatCharacterBio" placeholder="介绍一下角色..."></textarea></div><div class="weibo-form-group"><label for="chatCharacterFollowers">粉丝数量</label><input type="number" id="chatCharacterFollowers" placeholder="请输入粉丝数量"></div><button class="weibo-save-profile-btn" id="saveChatCharacterBtn">保存角色设置</button></div></div></div>
    <div class="phone-container">
        <div class="screen">
            <div class="desktop-interface active" id="desktop-interface">
                <div class="desktop-time" id="desktop-time">--:--</div>
                <div class="desktop-signature" id="desktop-signature" contenteditable="true">点击编辑个性签名...</div>
                <div class="app-grid">
                    <div class="app-item" onclick="openApp('chat')"><div class="app-icon">⊕</div><div class="app-label">聊天</div></div>
                    <div class="app-item" onclick="openApp('api')"><div class="app-icon">ꕥ</div><div class="app-label">API</div></div>
                    <div class="app-item" onclick="openApp('style')"><div class="app-icon">Θ</div><div class="app-label">美化</div></div>
                    <div class="app-item" onclick="openApp('worldbook')"><div class="app-icon">✧</div><div class="app-label">世界书</div></div>
                    <div class="app-item" onclick="openApp('wallet')"><div class="app-icon">〒</div><div class="app-label">钱包</div></div>
                    <div class="app-item" onclick="openApp('music')"><div class="app-icon">ʊ</div><div class="app-label">音乐</div></div>
                    <div class="app-item" onclick="openApp('weibo')"><div class="app-icon">㉿</div><div class="app-label">微博</div></div>
                </div>
            </div>
            <div class="interface chat-interface" id="chat-interface">
                <div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>✤世纪 <span class="status-indicator" id="chat-status"></span></h1><button class="toggle-persona" onclick="openPersonaModal()">编辑人设</button></div>
                <div class="scrollable-content">
                    <div class="chat-container"><div class="chat-messages" id="chat-messages"></div></div>      
                    <div class="chat-management-section">
                        <h3>聊天管理</h3>
                        <div class="chat-type-switch"><div class="chat-type-label">聊天类型: </div><div class="chat-type-buttons"><button class="chat-type-btn active" id="single-chat-btn" onclick="switchChatType('single')">单聊</button><button class="chat-type-btn" id="multi-chat-btn" onclick="switchChatType('multi')">多聊</button></div></div>
                        <div class="multi-persona-selector" id="multi-persona-selector"><label class="multi-persona-label">当前角色:</label><select class="persona-select" id="multi-persona-select" onchange="switchMultiPersona()"></select><div class="multi-persona-management"><button onclick="refreshMultiPersonaSelect()">刷新角色</button><button onclick="openPersonaModal(); switchPersonaTab('multi')">管理角色</button></div></div>
                        <div class="chat-mode-switch"><div class="chat-mode-label">聊天模式: <span id="chat-mode-display">线上模式</span><span class="chat-mode-indicator chat-mode-online" id="chat-mode-indicator"></span></div><div class="chat-mode-buttons"><button class="chat-mode-btn active" id="online-mode-btn" onclick="switchChatMode('online')">线上</button><button class="chat-mode-btn" id="offline-mode-btn" onclick="switchChatMode('offline')">线下</button></div></div>
                        <div class="chat-mode-description" id="chat-mode-description">线上模式: 短信模式短文本，日常说话风格 | 线下模式: 剧情模式长文本，唯美小说风格</div>
                        <div class="chat-management-buttons"><button onclick="clearAllChatHistory()">一键清空记录</button><button onclick="toggleSelectionMode()" id="selection-mode-btn">选择消息清空</button></div>
                        <div class="selection-mode-info" id="selection-mode-info"><span>已选择 <span class="selection-count" id="selection-count">0</span> 条消息</span><div class="selection-actions" id="selection-actions"><button onclick="deleteSelectedMessages()" class="danger">删除选中消息</button><button onclick="toggleSelectionMode()">取消选择</button></div></div>
                    </div>
                    <div class="backup-section"><h3>聊天备份</h3><div class="backup-buttons"><button onclick="exportChatHistory()">导出聊天记录</button><button onclick="importChatHistory()">导入聊天记录</button><button onclick="backupToLocal()">备份到本地</button><button onclick="restoreFromLocal()">从本地恢复</button></div><div class="backup-status" id="backup-status"></div><div class="backup-info">使用导出/导入功能可以在不同浏览器之间迁移聊天记录</div><input type="file" class="backup-file-input" id="backup-file-input" accept=".json"></div>
                    <div class="scroll-hint" id="chat-scroll-hint">↑ 继续向上滑动查看更多内容</div>
                </div>
                <div class="chat-input-container"><div class="chat-input"><input type="text" id="message-input" placeholder="输入您的消息..." onkeypress="handleMessageKeypress(event)"><button onclick="handleSendButtonClick()" id="send-button">发送</button></div></div>
                <div class="app-navigation" style="display: none;"></div>
            </div>
            <div class="interface" id="api-interface">
                <div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>API配置 <span class="status-indicator" id="api-status-indicator"></span></h1></div>       
                <div class="scrollable-content">
                    <div class="api-section"><h3>API提供商</h3><select class="api-input" id="api-provider" onchange="updateApiEndpoints()"><option value="openai">OpenAI</option><option value="anthropic">Anthropic (Claude)</option><option value="google">Google (Gemini)</option><option value="custom">自定义</option></select></div>     
                    <div class="api-section"><h3>API端点配置</h3><input type="text" class="api-input" id="api-url" placeholder="输入API端点URL..." value="https://api.openai.com/v1"><input type="password" class="api-input" id="api-key" placeholder="输入API密钥..."><div class="api-buttons"><button onclick="testApiConnection()">测试API连接</button><button onclick="refreshModels()">刷新模型列表</button><button onclick="saveApiConfig()">保存配置</button><button onclick="clearApiConfig()">清除配置</button></div><div class="api-status" id="api-status"></div></div>
                    <div class="api-section"><h3>模型选择</h3><div class="model-info"><span class="current-model" id="current-model-display">当前模型: 未选择</span><span class="model-badge" id="model-provider-badge">OpenAI</span></div><select class="api-input" id="model-select" onchange="updateSelectedModel()"><option value="">请选择模型</option></select><div class="refresh-status"><button class="refresh-button" onclick="refreshModels()">刷新模型</button><span class="last-updated" id="last-updated">上次更新: 从未</span></div><div class="model-list" id="model-list" style="display: none;"><div class="api-status" id="models-status"></div></div></div>    
                    <div class="api-section"><h3>高级设置</h3><div class="form-group"><label for="temperature">温度 (0-2)</label><input type="range" class="api-input" id="temperature" min="0" max="2" step="0.1" value="0.7" oninput="updateTemperatureValue()"><span id="temperature-value">0.7</span></div><div class="form-group"><label for="max-tokens">最大令牌数</label><input type="number" class="api-input" id="max-tokens" value="1000" min="1" max="4000"></div><div class="form-group"><label for="reply-count">角色回复条数 (1-5)</label><input type="number" class="api-input" id="reply-count" value="1" min="1" max="5"></div></div>
                    <div class="scroll-hint" id="api-scroll-hint">↑ 继续向上滑动查看更多内容</div>
                </div>
            </div>
            <div class="interface" id="style-interface">
                <div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>CSS美化 <span class="status-indicator" id="style-status"></span></h1></div>
                <div class="scrollable-content">
                    <div class="style-container">
                        <div class="ai-circle">AI</div>
                        <textarea class="css-editor" id="css-editor" placeholder="输入全局CSS代码...">/* 在这里输入您的自定义CSS */
.message { border: 1px solid #000; background: white; margin: 8px 0; max-width: 85%; }
.user-message { margin-left: auto; background: #f8f8f8; }
.ai-message { margin-right: auto; background: #f0f0f0; }
.ai-circle { border: 3px solid #000; background: white; transition: all 0.3s ease; }
.ai-circle:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }</textarea> 
                        <div class="style-buttons"><button class="apply-css" onclick="applyGlobalCSS()">应用CSS</button><button class="apply-css" onclick="resetCSS()">重置CSS</button><button class="apply-css" onclick="exportCSS()">导出CSS</button><button class="apply-css" onclick="importCSS()">导入CSS</button></div>
                    </div>
                    <div class="scroll-hint" id="style-scroll-hint">↑ 继续向上滑动查看更多内容</div>
                </div>
            </div>
            <div class="interface" id="music-interface">
                <div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>黑胶唱片 <span class="status-indicator" id="music-status"></span></h1></div>
                <div class="scrollable-content">
                    <div class="music-player">
                        <div class="music-fixed-area">
                            <div class="disc-container"><div class="disc" id="disc"><div class="disc-center"></div></div></div>
                            <div class="song-info"><div class="song-title" id="song-title">选择音频开始播放</div><div class="song-artist" id="song-artist">-</div></div>
                            <div class="progress-container"><div class="progress-info"><span class="current-time" id="current-time">0:00</span><span class="duration" id="duration">0:00</span></div><div class="progress-bar" id="progress-bar"><div class="progress" id="progress"></div></div></div>
                            <div class="control-buttons"><button class="btn btn-loop active" id="list-loop-btn" title="顺序播放">✦</button><button class="btn btn-prev" id="prev-btn">⏮</button><button class="btn btn-play" id="play-pause-btn">▶</button><button class="btn btn-next" id="next-btn">⏭</button><button class="btn btn-loop" id="single-loop-btn" title="单曲循环">✦</button></div>
                        </div>
                        <div class="music-scrollable-area">
                            <div class="import-section"><div class="import-btn" id="import-btn">选择音频文件</div><input type="file" class="file-input" id="file-input" accept="audio/*" multiple><div class="playlist" id="playlist"><div class="playlist-item empty">播放列表为空</div></div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="interface" id="worldbook-interface">
                <div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>世界书 <span class="status-indicator" id="worldbook-status-indicator"></span></h1><button class="add-worldbook-btn" onclick="openWorldbookModal()">+</button></div>
                <div class="scrollable-content">
                    <div style="padding: 20px;">
                        <h2>世界书管理 <span class="status-indicator" id="worldbook-status-indicator-title"></span></h2><p>世界书是告诉AI除了角色之外还需要遵守的行为准则和世界观设定。</p><div class="worldbook-list" id="worldbook-list"></div>
                        <div class="worldbook-backup-section"><h3>世界书备份管理</h3><p style="font-size: 12px; color: #666; margin-bottom: 10px;">备份您的世界书记录到本地文件，或从文件导入恢复</p><div class="worldbook-backup-buttons"><button onclick="exportWorldbookRecords()">导出世界书记录</button><button onclick="importWorldbookRecords()">导入世界书记录</button><button onclick="backupWorldbookToLocal()">备份到本地存储</button><button onclick="restoreWorldbookFromLocal()">从本地恢复</button></div><div class="worldbook-backup-status" id="worldbook-backup-status"></div><div class="worldbook-backup-info">使用导出/导入功能可以在不同设备之间迁移世界书记录</div><input type="file" class="worldbook-backup-file-input" id="worldbook-backup-file-input" accept=".json"></div>
                        <div class="worldbook-status" id="worldbook-status"></div>
                    </div>
                    <div class="scroll-hint" id="worldbook-scroll-hint">↑ 继续向上滑动查看更多内容</div>
                </div>
            </div>
            <div class="interface" id="wallet-interface">
                <div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>钱包 <span class="status-indicator" id="wallet-status"></span></h1></div>
                <div class="scrollable-content">
                    <div class="wallet-container">
                        <section class="balance-card"><div class="balance-label">总余额 (元)</div><div class="balance-amount" id="totalBalance">0.00</div><div class="balance-sub-info"><span>今日支出: ¥<span id="todayExpense">0.00</span></span><span>本月收入: ¥<span id="monthIncome">0.00</span></span></div></section>
                        <section class="action-buttons"><button class="action-btn" id="rechargeBtn"><span class="icon">✚</span> 手机充值</button><button class="action-btn" id="utilityBtn"><span class="icon">⚡</span> 水电费</button></section>
                        <section class="transaction-section"><h3>收入支出</h3><div class="transaction-list" id="transaction-list"></div></section>
                    </div>
                </div>
            </div>
            <div class="interface" id="weibo-interface">
                <div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>weibo <span class="status-indicator" id="weibo-status"></span></h1></div>
                <div class="scrollable-content">
                    <div class="weibo-container">
                        <header class="weibo-header"><div class="weibo-logo">Weibo</div><nav class="weibo-nav"><a href="#" id="weiboHomeLink" class="active">首页</a><a href="#" id="weiboDiscoverLink">发现</a><a href="#" id="weiboProfileLink">我的</a></nav></header>
                        <section id="weiboHomePage" class="weibo-page-content active">
                            <section class="weibo-category-section"><div class="weibo-category-header"><div class="weibo-category-title">内容分类</div><button class="weibo-manage-categories-btn" id="weiboManageCategories">管理分类</button><button class="weibo-refresh-btn" id="weiboRefreshDynamicBtn">生成动态</button></div><div class="weibo-category-tags" id="weiboCategoryTags"></div></section>
                            <section class="weibo-compose-section"><div class="weibo-compose-box"><div class="weibo-avatar" id="weiboUserAvatar"></div><div class="weibo-compose-input"><textarea placeholder="分享新鲜事..." id="weiboText"></textarea><div class="weibo-compose-actions"><select class="weibo-category-select" id="weiboCategorySelect"><option value="">选择分类</option></select><button class="weibo-publish-btn" id="weiboPublishBtn">发布</button></div></div></div></section>
                            <section class="weibo-list" id="weiboList"></section>
                        </section>
                        <section id="weiboDiscoverPage" class="weibo-page-content">
                            <div class="weibo-discover-section"><div class="weibo-discover-title">发现精彩内容</div><div class="weibo-trending-topics"><div class="weibo-trending-header"><div class="weibo-trending-title">热门话题</div><button class="weibo-refresh-btn" id="weiboRefreshTopics">换一批</button></div><div class="weibo-topic-list" id="weiboTopicList"></div></div><div class="weibo-recommended-users"><div class="weibo-trending-header"><div class="weibo-trending-title">推荐用户</div><button class="weibo-refresh-btn" id="weiboRefreshUsers">换一批</button></div><div class="weibo-user-list" id="weiboUserList"></div></div><div class="weibo-random-quote" id="weiboRandomQuote"></div></div>
                        </section>
                        <section id="weiboProfilePage" class="weibo-page-content">
                            <div class="weibo-discover-section"><div class="weibo-discover-title">个人主页</div><div class="chat-character-profile"><div class="chat-character-header"><div class="chat-character-avatar" id="myProfileAvatar"></div><div class="chat-character-info"><div class="chat-character-name" id="myProfileName">微博用户</div><div class="chat-character-bio" id="myProfileBio">这个人很懒，什么都没有写...</div></div></div><div class="chat-character-stats"><div class="chat-character-stat"><div class="chat-character-stat-number" id="myProfileFollowers">0</div><div class="chat-character-stat-label">粉丝</div></div><div class="chat-character-stat"><div class="chat-character-stat-number" id="myProfileFollowing">0</div><div class="chat-character-stat-label">关注</div></div><div class="chat-character-stat"><div class="chat-character-stat-number" id="myProfileWeibos">0</div><div class="chat-character-stat-label">微博</div></div></div><button class="chat-character-edit-btn" id="editMyProfileBtn">编辑我的主页</button></div></div>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="weibo-modal" id="weiboCategoryModal"><div class="weibo-modal-content"><div class="weibo-modal-header"><h3>管理分类</h3><button class="weibo-close-modal" id="weiboCloseCategoryModal">×</button></div><div class="weibo-category-input-group"><input type="text" class="weibo-category-input" id="weiboNewCategoryInput" placeholder="输入新分类名称"><button class="weibo-add-category-btn" id="weiboAddCategoryBtn">添加</button></div><div class="weibo-category-list" id="weiboCategoryList"></div></div></div>
    <div class="weibo-modal" id="weiboProfileModal"><div class="weibo-modal-content"><div class="weibo-modal-header"><h3>编辑个人资料</h3><button class="weibo-close-modal" id="weiboCloseProfileModal">×</button></div><div class="weibo-profile-form"><div class="weibo-form-group"><label for="weiboProfileName">姓名</label><input type="text" id="weiboProfileName" placeholder="请输入您的姓名"></div><div class="weibo-form-group"><label for="weiboProfileBio">个人简介</label><textarea id="weiboProfileBio" placeholder="介绍一下自己..."></textarea></div><div class="weibo-form-group"><label for="weiboProfilePersona">人设/标签</label><input type="text" id="weiboProfilePersona" placeholder="例如：摄影爱好者、程序员、美食家等"></div><div class="weibo-form-group"><label for="weiboProfileLocation">所在地</label><input type="text" id="weiboProfileLocation" placeholder="请输入您所在的城市"></div><div class="weibo-form-group"><label for="weiboProfileFollowers">粉丝数量</label><input type="number" id="weiboProfileFollowers" placeholder="请输入粉丝数量"></div><div class="weibo-form-group"><label for="weiboProfileFollowing">关注数量</label><input type="number" id="weiboProfileFollowing" placeholder="请输入关注数量"></div><button class="weibo-save-profile-btn" id="weiboSaveProfileBtn">保存资料</button></div></div></div>
    <div class="weibo-comment-modal" id="weiboCommentModal"><div class="weibo-comment-content"><div class="weibo-modal-header"><h3>评论</h3><button class="weibo-close-modal" id="weiboCloseCommentModal">×</button></div><textarea class="weibo-comment-input" id="weiboCommentInput" placeholder="写下您的评论..."></textarea><div class="weibo-comment-actions"><button class="weibo-cancel-comment" id="weiboCancelComment">取消</button><button class="weibo-submit-comment" id="weiboSubmitComment">发布评论</button></div><div class="weibo-comments-list" id="weiboCommentsList"></div></div></div>

    <script>
        const utilityPrices = { "豪宅、庄园、城堡": { water: 800, electricity: 1200 }, "别墅、独栋": { water: 500, electricity: 800 }, "高档公寓、大平层": { water: 300, electricity: 500 }, "普通公寓、居民楼、小区": { water: 150, electricity: 300 }, "经济适用房、小户型": { water: 100, electricity: 200 }, "宿舍、合租房": { water: 80, electricity: 150 }, "老破小、旧房": { water: 50, electricity: 100 }, "农村自建房、乡村": { water: 30, electricity: 80 } };
        class WorldbookManager { constructor() { this.records = JSON.parse(localStorage.getItem('worldbook')) || []; this.currentEditingId = null; } addRecord(title, content) { const record = { id: Date.now() + Math.random().toString(36).substr(2, 9), title: title, content: content, active: true, timestamp: new Date().toISOString() }; this.records.push(record); this.saveRecords(); return record; } updateRecord(id, title, content) { const record = this.records.find(r => r.id === id); if (record) { record.title = title; record.content = content; record.timestamp = new Date().toISOString(); this.saveRecords(); return true; } return false; } deleteRecord(id) { const index = this.records.findIndex(r => r.id === id); if (index !== -1) { this.records.splice(index, 1); this.saveRecords(); return true; } return false; } toggleRecord(id) { const record = this.records.find(r => r.id === id); if (record) { record.active = !record.active; this.saveRecords(); return record.active; } return false; } getActiveRecords() { return this.records.filter(r => r.active); } getAllRecords() { return [...this.records]; } getRecordById(id) { return this.records.find(r => r.id === id); } saveRecords() { localStorage.setItem('worldbook', JSON.stringify(this.records)); } }
        class MultiPersonaManager { constructor() { this.personas = JSON.parse(localStorage.getItem('multiPersonas')) || []; this.currentPersonaId = JSON.parse(localStorage.getItem('currentMultiPersonaId')) || null; } addPersona(name, description) { const persona = { id: Date.now() + Math.random().toString(36).substr(2, 9), name: name, description: description, timestamp: new Date().toISOString() }; this.personas.push(persona); this.savePersonas(); return persona; } updatePersona(id, name, description) { const persona = this.personas.find(p => p.id === id); if (persona) { persona.name = name; persona.description = description; persona.timestamp = new Date().toISOString(); this.savePersonas(); return true; } return false; } deletePersona(id) { const index = this.personas.findIndex(p => p.id === id); if (index !== -1) { this.personas.splice(index, 1); this.savePersonas(); if (this.currentPersonaId === id) { this.currentPersonaId = this.personas.length > 0 ? this.personas[0].id : null; this.saveCurrentPersonaId(); } return true; } return false; } getPersonaById(id) { return this.personas.find(p => p.id === id); } getCurrentPersona() { if (!this.currentPersonaId && this.personas.length > 0) { this.currentPersonaId = this.personas[0].id; this.saveCurrentPersonaId(); } return this.personas.find(p => p.id === this.currentPersonaId); } setCurrentPersona(id) { this.currentPersonaId = id; this.saveCurrentPersonaId(); } getAllPersonas() { return [...this.personas]; } getPersonaCount() { return this.personas.length; } savePersonas() { localStorage.setItem('multiPersonas', JSON.stringify(this.personas)); } saveCurrentPersonaId() { localStorage.setItem('currentMultiPersonaId', JSON.stringify(this.currentPersonaId)); } }
        const musicPlayer = { audio: new Audio(), playlist: [], currentIndex: -1, isPlaying: false, loopMode: 'list', init: function() { this.bindEvents(); this.audio.addEventListener('loadedmetadata', () => { this.updateTotalTime(); }); this.audio.addEventListener('timeupdate', () => { this.updateProgress(); }); this.audio.addEventListener('ended', () => { if (this.loopMode === 'single') { this.audio.currentTime = 0; this.audio.play(); } else { this.next(); } }); this.updateMusicStatusIndicator(); this.setLoopMode('list'); }, bindEvents: function() { document.getElementById('play-pause-btn').addEventListener('click', () => { this.togglePlay(); }); document.getElementById('prev-btn').addEventListener('click', () => { this.prev(); }); document.getElementById('next-btn').addEventListener('click', () => { this.next(); }); document.getElementById('progress-bar').addEventListener('click', (e) => { this.seek(e); }); document.getElementById('import-btn').addEventListener('click', () => { document.getElementById('file-input').click(); }); document.getElementById('single-loop-btn').addEventListener('click', () => { this.setLoopMode('single'); }); document.getElementById('list-loop-btn').addEventListener('click', () => { this.setLoopMode('list'); }); document.getElementById('file-input').addEventListener('change', (e) => { this.handleFileSelect(e); }); }, handleFileSelect: function(e) { const files = e.target.files; if (files.length === 0) return; for (let i = 0; i < files.length; i++) { const file = files[i]; if (file.type.startsWith('audio/')) { const url = URL.createObjectURL(file); this.addToPlaylist(file.name, url, file); } } if (this.currentIndex === -1 && this.playlist.length > 0) { this.play(0); } e.target.value = ''; }, addToPlaylist: function(name, url, file) { const playlist = document.getElementById('playlist'); if (playlist.querySelector('.empty')) { playlist.innerHTML = ''; } const item = document.createElement('div'); item.className = 'playlist-item'; item.dataset.url = url; const tempAudio = new Audio(url); tempAudio.addEventListener('loadedmetadata', () => { const duration = this.formatTime(tempAudio.duration); item.innerHTML = `<div class="song-title">${name}</div><div class="song-duration">${duration}</div>`; item.dataset.duration = tempAudio.duration; }); item.addEventListener('click', () => { const index = Array.from(playlist.children).indexOf(item); this.play(index); }); playlist.appendChild(item); this.playlist.push({ name: name, url: url, file: file }); }, play: function(index) { if (index < 0 || index >= this.playlist.length) return; this.currentIndex = index; const song = this.playlist[index]; this.audio.src = song.url; document.getElementById('song-title').textContent = song.name; document.getElementById('song-artist').textContent = '本地音乐'; const playlistItems = document.querySelectorAll('.playlist-item'); playlistItems.forEach(item => item.classList.remove('active')); playlistItems[index].classList.add('active'); this.audio.play(); this.isPlaying = true; this.updatePlayState(); }, togglePlay: function() { if (this.currentIndex === -1) { if (this.playlist.length > 0) { this.play(0); } return; } if (this.isPlaying) { this.audio.pause(); } else { this.audio.play(); } this.isPlaying = !this.isPlaying; this.updatePlayState(); }, updatePlayState: function() { const disc = document.getElementById('disc'); const playPauseIcon = document.getElementById('play-pause-btn'); if (this.isPlaying) { disc.classList.add('playing'); playPauseIcon.textContent = '❚❚'; } else { disc.classList.remove('playing'); playPauseIcon.textContent = '▶'; } this.updateMusicStatusIndicator(); }, updateMusicStatusIndicator: function() { const musicStatus = document.getElementById('music-status'); if (this.isPlaying) { musicStatus.className = 'status-indicator status-online'; musicStatus.title = '正在播放'; } else { musicStatus.className = 'status-indicator status-offline'; musicStatus.title = '未播放'; } }, prev: function() { if (this.playlist.length === 0) return; let newIndex = this.currentIndex - 1; if (newIndex < 0) { newIndex = this.playlist.length - 1; } this.play(newIndex); }, next: function() { if (this.playlist.length === 0) return; let newIndex = this.currentIndex + 1; if (newIndex >= this.playlist.length) { newIndex = 0; } this.play(newIndex); }, seek: function(e) { if (this.currentIndex === -1) return; const progressBar = document.getElementById('progress-bar'); const rect = progressBar.getBoundingClientRect(); const percent = (e.clientX - rect.left) / rect.width; this.audio.currentTime = percent * this.audio.duration; }, updateProgress: function() { const progress = document.getElementById('progress'); const currentTime = document.getElementById('current-time'); if (this.audio.duration) { const percent = (this.audio.currentTime / this.audio.duration) * 100; progress.style.width = `${percent}%`; currentTime.textContent = this.formatTime(this.audio.currentTime); } }, updateTotalTime: function() { const duration = document.getElementById('duration'); duration.textContent = this.formatTime(this.audio.duration); }, formatTime: function(seconds) { if (isNaN(seconds)) return '0:00'; const mins = Math.floor(seconds / 60); const secs = Math.floor(seconds % 60); return `${mins}:${secs < 10 ? '0' : ''}${secs}`; }, setLoopMode: function(mode) { const singleBtn = document.getElementById('single-loop-btn'); const listBtn = document.getElementById('list-loop-btn'); singleBtn.classList.remove('active'); listBtn.classList.remove('active'); this.loopMode = mode; if (mode === 'single') { singleBtn.classList.add('active'); } else { listBtn.classList.add('active'); } } };
        function saveSignature() { const signature = document.getElementById('desktop-signature').textContent; localStorage.setItem('desktopSignature', signature); }
        function loadSignature() { const savedSignature = localStorage.getItem('desktopSignature'); if (savedSignature) { document.getElementById('desktop-signature').textContent = savedSignature; } }
        class ChatManager { 
            constructor() { 
                this.messages = JSON.parse(localStorage.getItem('chatMessages')) || []; 
                this.currentEditingId = null; 
                this.listeners = []; 
                this.messages = this.createObservableArray(this.messages); 
            } 
            
            createObservableArray(array) { 
                const self = this; 
                return new Proxy(array, { 
                    set(target, property, value) { 
                        const result = Reflect.set(target, property, value); 
                        self.notifyListeners('messagesChanged', target); 
                        self.saveMessages(); 
                        return result; 
                    }, 
                    get(target, property) { 
                        const value = Reflect.get(target, property); 
                        if (typeof value === 'function') { 
                            return function(...args) { 
                                const result = value.apply(target, args); 
                                if (['push', 'pop', 'shift', 'unshift', 'splice'].includes(property)) { 
                                    self.notifyListeners('messagesChanged', target); 
                                    self.saveMessages(); 
                                } 
                                return result; 
                            }; 
                        } 
                        return value; 
                    } 
                }); 
            } 
            
            addListener(event, callback) { 
                this.listeners.push({ event, callback }); 
            } 
            
            notifyListeners(event, data) { 
                this.listeners.forEach(listener => { 
                    if (listener.event === event) { 
                        listener.callback(data); 
                    } 
                }); 
            } 
            
            saveMessages() { 
                localStorage.setItem('chatMessages', JSON.stringify(this.messages)); 
            } 
            
            // 修改：添加senderName和personaId参数来保存发送者信息
            addMessage(sender, content, senderName = '', personaId = null, type = 'text') { 
                // 如果senderName没有提供，根据sender类型设置默认值
                if (!senderName) {
                    if (sender === 'user') {
                        const userPersona = JSON.parse(localStorage.getItem('userPersona') || '{}');
                        senderName = userPersona.name || '您';
                    } else { // ai
                        // 单聊模式：使用AI人设名称
                        if (appState.chatType === 'single') {
                            const aiPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}');
                            senderName = aiPersona.name || '助手';
                        } else { // 多聊模式：使用当前多聊角色名称
                            const currentPersona = appState.multiPersonaManager.getCurrentPersona();
                            senderName = currentPersona ? currentPersona.name : '助手';
                        }
                    }
                }
                
                const message = { 
                    id: Date.now() + Math.random().toString(36).substr(2, 9), 
                    sender: sender, 
                    senderName: senderName, // 保存发送者名称
                    content: content, 
                    personaId: personaId, // 保存角色ID（多聊模式下使用）
                    type: type, 
                    timestamp: new Date().toISOString() 
                }; 
                this.messages.push(message); 
                return message; 
            } 
            
            updateMessage(id, newContent) { 
                const message = this.messages.find(msg => msg.id === id); 
                if (message) { 
                    message.content = newContent; 
                    message.timestamp = new Date().toISOString(); 
                    this.saveMessages(); 
                    this.notifyListeners('messageUpdated', message); 
                    return true; 
                } 
                return false; 
            } 
            
            deleteMessage(id) { 
                const index = this.messages.findIndex(msg => msg.id === id); 
                if (index !== -1) { 
                    const deletedMessage = this.messages[index]; 
                    this.messages.splice(index, 1); 
                    this.saveMessages(); 
                    this.notifyListeners('messageDeleted', deletedMessage); 
                    return true; 
                } 
                return false; 
            } 
            
            deleteMessages(ids) { 
                const deletedCount = ids.length; 
                ids.sort((a, b) => b - a).forEach(id => { 
                    const index = this.messages.findIndex(msg => msg.id === id); 
                    if (index !== -1) { 
                        this.messages.splice(index, 1); 
                    } 
                }); 
                if (deletedCount > 0) { 
                    this.saveMessages(); 
                    this.notifyListeners('messagesChanged', this.messages); 
                } 
                return deletedCount; 
            } 
            
            clearAllMessages() { 
                const count = this.messages.length; 
                this.messages.length = 0; 
                this.saveMessages(); 
                this.notifyListeners('messagesChanged', this.messages); 
                return count; 
            } 
            
            getMessages() { 
                return [...this.messages]; 
            } 
            
            getMessageCount() { 
                return this.messages.length; 
            } 
        }
        class ApiService { 
            constructor() { 
                this.config = JSON.parse(localStorage.getItem('apiConfig')) || { provider: 'openai', apiKey: '', apiUrl: 'https://api.openai.com/v1', model: 'gpt-3.5-turbo', replyCount: 1 }; 
            } 
            
            async getModels() { 
                try { 
                    const response = await fetch(`${this.config.apiUrl}/models`, { method: 'GET', headers: { 'Authorization': `Bearer ${this.config.apiKey}`, 'Content-Type': 'application/json' } }); 
                    if (!response.ok) { 
                        const errorData = await response.json(); 
                        throw new Error(errorData.error?.message || `API请求失败: ${response.status}`); 
                    } 
                    const data = await response.json(); 
                    return data.data.map(model => model.id); 
                } catch (error) { 
                    console.error('获取模型列表失败:', error); 
                    throw error; 
                } 
            } 
            
            async chatWithRole(rolePrompt, userMessage, temperature = 0.7, replyCount = 1, chatMode = 'online', chatType = 'single', currentAiName = '') {
                if (!this.config.apiKey) {
                    throw new Error('API密钥未配置');
                }

                // 获取全局配置
                const aiPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}');
                const userPersona = JSON.parse(localStorage.getItem('userPersona') || '{}');
                const activeRecords = appState.worldbookManager.getActiveRecords();
                
                let systemPrompt = "";

                // --- 核心修改：区分单聊和多聊的 System Prompt 构建 ---
                if (chatType === 'multi') {
                    // 【多聊模式】：纯净模式，只使用当前传入的 rolePrompt (多聊角色设定)
                    // 强制告诉 AI 这是一个群聊环境
                    systemPrompt = `你现在的身份是：${currentAiName}。\n\n你的详细人设如下：\n${rolePrompt}\n\n【场景说明】\n这是一个多人聊天群组（Group Chat）。\n请时刻保持你的角色设定，不要跳出戏，不要说自己是AI或语言模型。\n你需要根据群里的对话内容，以${currentAiName}的口吻进行回复。`;
                    
                    // 加入用户设定（如果需要用户在群里也有特定身份）
                    if (userPersona.name || userPersona.description) {
                        systemPrompt += `\n\n和你对话的用户设定：`;
                        if (userPersona.name) systemPrompt += `\n- 姓名：${userPersona.name}`;
                        if (userPersona.description) systemPrompt += `\n- 描述：${userPersona.description}`;
                    }

                } else {
                    // 【单聊模式】：保持原有逻辑，叠加全局人设
                    systemPrompt = rolePrompt;
                    if (aiPersona.name || aiPersona.description) {
                        systemPrompt += `\n\n角色信息：`;
                        if (aiPersona.name) systemPrompt += `\n- 姓名：${aiPersona.name}`;
                        if (aiPersona.description) systemPrompt += `\n- 描述：${aiPersona.description}`;
                    }
                    if (userPersona.name || userPersona.description) {
                        systemPrompt += `\n\n用户信息：`;
                        if (userPersona.name) systemPrompt += `\n- 姓名：${userPersona.name}`;
                        if (userPersona.description) systemPrompt += `\n- 描述：${userPersona.description}`;
                    }
                }

                if (activeRecords.length > 0) { 
                    systemPrompt += `\n\n世界书记录：`; 
                    activeRecords.forEach((record, index) => { 
                        systemPrompt += `\n${index + 1}. ${record.content}`; 
                    }); 
                } 
                
                if (chatMode === 'online') { 
                    systemPrompt += `\n\n重要：请使用线上模式（短信模式）回复：\n1. 回复要简短精炼，像日常短信对话\n2. 使用日常说话语气，自然亲切\n3. 避免使用复杂的修饰词和文学性描述\n4. 尽量使用短句，表达直接\n5. 回复长度控制在100字以内`; 
                } else { 
                    systemPrompt += `\n\n重要：请使用线下模式（剧情模式）回复：\n1. 回复要详细、有画面感，像小说剧情\n2. 使用唯美、文学性的语言，可以大量使用修饰词\n3. 注重情感表达和氛围营造\n4. 可以展开想象，创造生动的场景和细节\n5. 回复可以较长，200-500字为宜\n6. 保持角色的一致性，让对话有剧情推进感`; 
                } 
                
                if (replyCount > 1) { 
                    systemPrompt += `\n\n重要：请连续回复${replyCount}条消息，这些回复应该是自然的、连贯的对话。\n示例：\n用户说："你好"\n你应该回复：\n你好！今天过得怎么样？\n|||\n我是AI助手，有什么可以帮你的吗？\n|||\n看起来你今天心情不错呢！\n注意：\n1. 每条回复都应该是对话的自然延续\n2. 不要添加任何序号前缀（如"第二条消息："、"回复2："等）\n3. 不要添加任何说明性文字\n4. 每条回复之间用"|||"分隔\n5. 保持语气和角色的一致性`; 
                } 
                
                // --- 历史消息构建优化：带上名字 ---
                const allMessages = appState.chatManager.getMessages(); 
                const recentMessages = allMessages.filter(msg => msg.content !== '正在思考...' && msg.content !== userMessage).slice(-15); 
                const messages = [{ role: 'system', content: systemPrompt }]; 
                
                recentMessages.forEach(msg => { 
                    // 确保 senderName 存在，如果不存在则根据 sender 类型给默认值
                    let name = msg.senderName;
                    if (!name) {
                        name = msg.sender === 'user' ? (userPersona.name || '用户') : '群友';
                    }

                    // 将名字嵌入到内容中，这样 AI 才知道这句话是谁说的
                    const contentWithName = `[${name}]: ${msg.content}`;

                    if (msg.sender === 'user') { 
                        messages.push({ role: 'user', content: contentWithName }); 
                    } else { 
                        messages.push({ role: 'assistant', content: contentWithName }); 
                    } 
                }); 
                
                // 当前用户的最新消息也带上名字
                const currentUserName = userPersona.name || '我';
                messages.push({ role: 'user', content: `[${currentUserName}]: ${userMessage}` }); 
                
                try { 
                    const response = await fetch(`${this.config.apiUrl}/chat/completions`, { 
                        method: 'POST', 
                        headers: { 
                            'Authorization': `Bearer ${this.config.apiKey}`, 
                            'Content-Type': 'application/json' 
                        }, 
                        body: JSON.stringify({ 
                            model: this.config.model, 
                            messages: messages, 
                            temperature: temperature, 
                            max_tokens: parseInt(document.getElementById('max-tokens').value) || 1000 
                        }) 
                    }); 
                    
                    if (!response.ok) { 
                        const errorData = await response.json(); 
                        throw new Error(`API请求失败: ${errorData.error?.message || response.status}`); 
                    } 
                    
                    const data = await response.json(); 
                    let content = data.choices[0].message.content; 
                    
                    // 清理可能 AI 自己带出来的名字前缀
                    const namePrefixRegex = new RegExp(`^\\[?${currentAiName}\\]?[:：]\\s*`, 'i');
                    content = content.replace(namePrefixRegex, '');

                    let replies = []; 
                    if (replyCount > 1) { 
                        replies = content.split(/\|\|\|/).map(str => str.trim()).filter(str => str.length > 0); 
                        replies = replies.map(reply => { 
                            return reply.replace(/^(第[一二三四五六七八九十\d]+条(消息|回复)[:：]\s*)/, '').replace(/^((回复|消息)[一二三四五六七八九十\d]+[:：]\s*)/, '').replace(/^((回复|消息)[\d]+[:：]\s*)/, '').replace(/^[\d]+[\.、:：]\s*/, '').trim(); 
                        }).filter(reply => reply.length > 0); 
                        
                        if (replies.length <= 1 && content.includes('\n')) { 
                            const lines = content.split('\n').map(str => str.trim()).filter(str => str.length > 0 && !str.startsWith('回复') && !str.startsWith('第') && !str.match(/^\d+[\.:：]/) && !str.includes('|||')); 
                            if (lines.length > 1) { 
                                replies = lines; 
                            } 
                        } 
                        if (replies.length <= 1) { 
                            replies = [content]; 
                        } else { 
                            replies = replies.slice(0, replyCount); 
                        } 
                    } else { 
                        replies = [content]; 
                    } 
                    return replies; 
                } catch (error) { 
                    console.error('API调用失败:', error); 
                    throw error; 
                } 
            } 
            
            async generateRawContent(systemPrompt, userPrompt, temperature = 0.8) { 
                if (!this.config.apiKey) { 
                    throw new Error('API密钥未配置'); 
                } 
                const messages = [{ role: 'system', content: systemPrompt }, { role: 'user', content: userPrompt }]; 
                try { 
                    const response = await fetch(`${this.config.apiUrl}/chat/completions`, { 
                        method: 'POST', 
                        headers: { 
                            'Authorization': `Bearer ${this.config.apiKey}`, 
                            'Content-Type': 'application/json' 
                        }, 
                        body: JSON.stringify({ 
                            model: this.config.model, 
                            messages: messages, 
                            temperature: temperature, 
                            max_tokens: 500 
                        }) 
                    }); 
                    if (!response.ok) { 
                        throw new Error(`API请求失败: ${response.status}`); 
                    } 
                    const data = await response.json(); 
                    return data.choices[0].message.content; 
                } catch (error) { 
                    console.error('API generateRawContent 调用失败:', error); 
                    throw error; 
                } 
            } 
            
            async testConnection() { 
                try { 
                    const models = await this.getModels(); 
                    return { success: true, models: models }; 
                } catch (error) { 
                    return { success: false, error: error.message }; 
                } 
            } 
            
            updateConfig(newConfig) { 
                this.config = { ...this.config, ...newConfig }; 
                localStorage.setItem('apiConfig', JSON.stringify(this.config)); 
            } 
            
            getCurrentConfig() { 
                return { ...this.config }; 
            } 
        }
        const walletManager = { loadWalletData: function() { const savedData = localStorage.getItem('walletData'); if (savedData) { return JSON.parse(savedData); } else { return { totalBalance: 0, todayExpense: 0, monthIncome: 0, lastUtilityPayMonth: null, transactions: [] }; } }, saveWalletData: function() { localStorage.setItem('walletData', JSON.stringify(this.walletData)); }, walletData: null, loadHouseType: function() { const savedHouseType = localStorage.getItem('userHouseType'); return savedHouseType || "老破小、旧房"; }, saveHouseType: function(houseType) { localStorage.setItem('userHouseType', houseType); }, initWallet: function() { this.walletData = this.loadWalletData(); document.getElementById('totalBalance').textContent = this.walletData.totalBalance.toFixed(2); document.getElementById('todayExpense').textContent = this.walletData.todayExpense.toFixed(2); document.getElementById('monthIncome').textContent = this.walletData.monthIncome.toFixed(2); this.renderTransactions(); }, renderTransactions: function() { const transactionList = document.getElementById('transaction-list'); if (this.walletData.transactions.length === 0) { transactionList.innerHTML = '<div class="empty-state"><p>暂无交易记录</p><p style="font-size: 0.8em; margin-top: 10px; color: #999;">所有消费和收入将在这里显示</p></div>'; return; } const sortedTransactions = [...this.walletData.transactions].sort((a, b) => new Date(b.date) - new Date(a.date)); transactionList.innerHTML = ''; sortedTransactions.forEach(transaction => { const transactionElement = document.createElement('div'); transactionElement.className = 'transaction-item'; const amountClass = transaction.type === 'expense' ? 'transaction-expense' : 'transaction-income'; const amountPrefix = transaction.type === 'expense' ? '-' : '+'; transactionElement.innerHTML = `<div class="transaction-info"><div class="transaction-title">${transaction.description}</div><div class="transaction-date">${this.formatDate(transaction.date)}</div></div><div class="transaction-amount ${amountClass}">${amountPrefix}¥${transaction.amount.toFixed(2)}</div>`; transactionList.appendChild(transactionElement); }); }, formatDate: function(dateString) { const date = new Date(dateString); return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`; }, addTransaction: function(type, amount, description) { const transaction = { id: Date.now() + Math.random().toString(36).substr(2, 9), type: type, amount: amount, description: description, date: new Date().toISOString() }; this.walletData.transactions.push(transaction); this.saveWalletData(); this.renderTransactions(); }, setupEventListeners: function() { document.getElementById('rechargeBtn').addEventListener('click', function() { document.getElementById('rechargeModal').style.display = 'flex'; document.getElementById('rechargeAmount').focus(); }); document.getElementById('closeModal').addEventListener('click', function() { document.getElementById('rechargeModal').style.display = 'none'; document.getElementById('rechargeAmount').value = ''; }); document.getElementById('confirmRecharge').addEventListener('click', function() { const amountInput = document.getElementById('rechargeAmount'); const amount = parseFloat(amountInput.value); if (isNaN(amount) || amount <= 0) { alert('请输入有效的充值金额！'); amountInput.focus(); return; } walletManager.recharge(amount); }); document.getElementById('rechargeModal').addEventListener('click', function(e) { if (e.target === this) { this.style.display = 'none'; document.getElementById('rechargeAmount').value = ''; } }); document.getElementById('rechargeAmount').addEventListener('keypress', function(e) { if (e.key === 'Enter') { document.getElementById('confirmRecharge').click(); } }); document.getElementById('utilityBtn').addEventListener('click', function() { walletManager.openUtilityModal(); }); document.getElementById('closeUtilityModal').addEventListener('click', function() { document.getElementById('utilityModal').style.display = 'none'; }); document.getElementById('confirmUtility').addEventListener('click', function() { walletManager.payUtility(); }); document.getElementById('utilityModal').addEventListener('click', function(e) { if (e.target === this) { this.style.display = 'none'; } }); document.getElementById('houseTypeSelect').addEventListener('change', function() { walletManager.updateUtilityPrices(); }); }, recharge: function(amount) { this.walletData.totalBalance += amount; document.getElementById('totalBalance').textContent = this.walletData.totalBalance.toFixed(2); this.saveWalletData(); document.getElementById('rechargeModal').style.display = 'none'; document.getElementById('rechargeAmount').value = ''; alert(`成功充值 ${amount.toFixed(2)} 元！`); }, openUtilityModal: function() { const houseType = this.loadHouseType(); document.getElementById('houseTypeSelect').value = houseType; this.updateUtilityPrices(); document.getElementById('utilityModal').style.display = 'flex'; }, updateUtilityPrices: function() { const selectedHouseType = document.getElementById('houseTypeSelect').value; const prices = utilityPrices[selectedHouseType] || utilityPrices["老破小、旧房"]; document.getElementById('utility-house-type').textContent = selectedHouseType; document.getElementById('utility-water').textContent = `${prices.water.toFixed(2)} 元`; document.getElementById('utility-electricity').textContent = `${prices.electricity.toFixed(2)} 元`; document.getElementById('utility-total').textContent = `${(prices.water + prices.electricity).toFixed(2)} 元`; }, hasPaidUtilityThisMonth: function() { if (!this.walletData.lastUtilityPayMonth) { return false; } const currentMonth = new Date().getMonth(); const currentYear = new Date().getFullYear(); const lastPayMonth = new Date(this.walletData.lastUtilityPayMonth).getMonth(); const lastPayYear = new Date(this.walletData.lastUtilityPayMonth).getFullYear(); return currentMonth === lastPayMonth && currentYear === lastPayYear; }, payUtility: function() { if (this.hasPaidUtilityThisMonth()) { alert('本月水电费已经缴纳过了，下个月再来吧！'); document.getElementById('utilityModal').style.display = 'none'; return; } const selectedHouseType = document.getElementById('houseTypeSelect').value; const prices = utilityPrices[selectedHouseType] || utilityPrices["老破小、旧房"]; const totalAmount = prices.water + prices.electricity; if (this.walletData.totalBalance < totalAmount) { alert('余额不足，无法缴纳水电费！'); return; } this.walletData.totalBalance -= totalAmount; document.getElementById('totalBalance').textContent = this.walletData.totalBalance.toFixed(2); this.walletData.todayExpense += totalAmount; document.getElementById('todayExpense').textContent = this.walletData.todayExpense.toFixed(2); this.walletData.lastUtilityPayMonth = new Date().toISOString(); this.addTransaction('expense', totalAmount, `${selectedHouseType}水电费`); this.saveHouseType(selectedHouseType); this.saveWalletData(); document.getElementById('utilityModal').style.display = 'none'; alert(`成功缴纳水电费 ${totalAmount.toFixed(2)} 元！`); } };
        const weiboManager = { categories: JSON.parse(localStorage.getItem('weiboCategories')) || [], weibos: JSON.parse(localStorage.getItem('weibos')) || [], userProfile: JSON.parse(localStorage.getItem('weiboUserProfile')) || { name: '微博用户', bio: '这个人很懒，什么都没有写...', persona: '普通用户', location: '', followers: 0, following: 0 }, neutralNPCs: Array(26).fill().map((_, i) => ({ name: `网友${String.fromCharCode(65 + i)}`, description: '中性化角色，根据题材发动态' })), fanNPCs: Array(26).fill().map((_, i) => ({ name: `网友${String.fromCharCode(65 + i)}`, description: '吃瓜角色，围绕用户和角色发动态' })), trendingTopics: [{ name: '#AI技术分享#', posts: '12.3万', trend: '上升' }, { name: '#日常生活#', posts: '8.7万', trend: '热门' }, { name: '#数码新品#', posts: '15.6万', trend: '新' }, { name: '#旅行日记#', posts: '23.1万', trend: '上升' }, { name: '#美食探索#', posts: '18.9万', trend: '热门' }, { name: '#财经新闻#', posts: '31.2万', trend: '爆款' }, { name: '#体育赛事#', posts: '5.4万', trend: '新' }, { name: '#娱乐八卦#', posts: '7.8万', trend: '上升' }, { name: '#恐怖故事#', posts: '9.2万', trend: '新' }], quotes: ["如果世界真的不喜欢你 那世界就是我的敌人", "童年的梦境锈迹斑斑 所罗门式的痛苦曾钻透月亮", "生命生来就如璀璨的夏日之花 不凋不败", "和蒲公英密谋一场叛逃 目的地为乌托邦银河渡口", "吾与吾爱皆亡于高塔 君与君心皆留于盛夏", "我永恒的灵魂注视着你的心 纵然黑夜孤寂 白昼如焚", "我观春山意难容 青也惊鸿 颓也从容", "爱诞生于每一次垂眸相视的瞬间里"], dynamicConfig: { userWeiboFrequency: 0, maxUserWeibosPerRefresh: 0 }, identityKeywords: { entertainment: ['明星', '演员', '歌手', '偶像', '艺人', '巨星', '歌星', '影星', '娱乐圈', '演艺圈', '娱乐'], detective: ['法医', '警察', '侦探', '刑侦', '案件', '尸体', '刑警', '警探', '犯罪', '侦查'], tech: ['程序员', '工程师', '科学家', '研究员', '技术', '开发', '编程', '码农', 'IT'], medical: ['医生', '护士', '医疗', '医学', '医院', '诊所', '医师', '治疗'], education: ['老师', '教师', '教授', '教育', '学校', '学生', '教学'] }, categoryIdentityMap: { '娱乐': 'entertainment', '科技': 'tech', '数码': 'tech', '恐怖': 'detective', '刑侦': 'detective', '案件': 'detective', '医疗': 'medical', '教育': 'education' }, dynamicContent: { topicStyles: { '恐怖': '语气必须令人感到绝望、恐惧、阴森、不安、毛骨悚然。侧重于心理恐怖或未知的恐惧。绝对不要搞笑。', '灵异': '语气必须令人感到绝望、恐惧、阴森、不安、毛骨悚然。侧重于心理恐怖或未知的恐惧。绝对不要搞笑。', '生活': '语气必须温馨、治愈、积极向上、充满生活气息、轻松愉快。', '日常': '语气必须温馨、治愈、积极向上、充满生活气息、轻松愉快。', '科技': '语气必须专业、理性、对未来科技充满向往、强调先进性、硬核。', '数码': '语气必须专业、理性、对未来科技充满向往、强调先进性、硬核。', '娱乐': '语气八卦、兴奋、或者犀利点评，充满娱乐精神，可以使用饭圈用语。', '明星': '语气八卦、兴奋、或者犀利点评，充满娱乐精神，可以使用饭圈用语。', '体育': '语气热血、充满激情、强调拼搏精神和竞技状态。', '运动': '语气热血、充满激情、强调拼搏精神和竞技状态。', '财经': '语气严谨、客观、分析透彻、关注利益和风险。', '金融': '语气严谨、客观、分析透彻、关注利益和风险。', 'default': '语气符合该话题的常规社交媒体风格。' }, emojis: ['😊', '😂', '❤️', '👍', '🔥', '⭐', '🙏', '🎉', '💡', '👏', '🎮', '📚', '✈️', '🍕', '☕', '😭', '🥰'], horrorEmojis: ['😨', '👻', '💀', '🕯️', '🌑', '🕷️', '🦇', '⚰️', '🩸', '👁️', '🧟', '🧛'], generateNPCWeibo: async function(category = null) { const aiPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}'); const userPersona = JSON.parse(localStorage.getItem('userPersona') || '{}'); const roleName = aiPersona.name || '某人'; const userName = userPersona.name || '某人'; const aiIdentity = this.extractIdentity(aiPersona.description || ''); const userIdentity = this.extractIdentity(userPersona.description || ''); const categoryIdentity = weiboManager.categoryIdentityMap[category] || null; const canMentionRole = aiIdentity && categoryIdentity && this.isIdentityMatch(aiIdentity, categoryIdentity); const canMentionUser = userIdentity && categoryIdentity && this.isIdentityMatch(userIdentity, categoryIdentity); const roleType = Math.random(); let username, userBio, isChatCharacter = false, isFanRole = false; if (aiPersona.name && aiPersona.description && roleType < 0.1 && canMentionRole) { username = aiPersona.name; userBio = aiPersona.description; isChatCharacter = true; } else if (roleType < 0.4 && (canMentionRole || canMentionUser)) { isFanRole = true; const fanNPC = weiboManager.fanNPCs[Math.floor(Math.random() * weiboManager.fanNPCs.length)]; username = fanNPC.name; userBio = fanNPC.description; } else { const neutralNPC = weiboManager.neutralNPCs[Math.floor(Math.random() * weiboManager.neutralNPCs.length)]; username = neutralNPC.name; userBio = neutralNPC.description; } const topic = category || this.getRandomTopic(); const styleInstruction = this.getTopicStyle(topic); let contextPrompt = ""; let specialInstructions = ""; if (isChatCharacter) { contextPrompt = `角色设定：${userBio}\n`; specialInstructions = `以${username}的身份发布关于"${topic}"的微博。`; } else if (isFanRole) { const fanTypes = []; if (canMentionRole) { fanTypes.push(`单独讨论${roleName}的人设`); fanTypes.push(`作为${roleName}的崇拜者/粉丝`); fanTypes.push(`评论${roleName}的最新动态`); } if (canMentionUser) { fanTypes.push(`单独讨论${userName}的人设`); fanTypes.push(`作为${userName}的崇拜者/粉丝`); fanTypes.push(`评论${userName}的最新动态`); } if (canMentionRole && canMentionUser) { fanTypes.push(`吃${roleName}和${userName}的瓜`); fanTypes.push(`评论${roleName}和${userName}的关系`); } if (fanTypes.length === 0) { specialInstructions = `以${username}的身份，发布关于"${topic}"的微博。`; } else { const fanType = fanTypes[Math.floor(Math.random() * fanTypes.length)]; contextPrompt = `角色设定：${userBio}\n`; specialInstructions = `以${username}的身份，${fanType}，发布关于"${topic}"的微博。`; } } else { contextPrompt = `角色设定：${userBio}\n`; specialInstructions = `以${username}的身份，发布关于"${topic}"的微博。`; } const prompt = `任务：${specialInstructions}\n${contextPrompt}\n情感基调/风格要求：${styleInstruction}\n其他要求：\n1. 字数控制在140字以内。\n2. 直接输出内容，不要包含解释。`; const neutralPersona = isChatCharacter ? userBio : `你是一个名为"${username}"的社交媒体用户，${userBio}`; try { const content = await appState.apiService.generateRawContent(neutralPersona, prompt, 0.8); return { content: this.cleanContent(content), username: username, userBio: userBio, isChatCharacter: isChatCharacter, isFanRole: isFanRole }; } catch (error) { console.error('生成NPC微博内容失败:', error); return { content: this.generateFallbackContent(topic), username: username, userBio: userBio, isChatCharacter: isChatCharacter, isFanRole: isFanRole }; } }, getRandomTopic: function() { const topics = ['日常生活', '科技动态', '美食分享', '旅行见闻', '心情随笔', '影视推荐', '音乐分享', '读书感悟', '健康养生', '运动健身', '时尚穿搭', '美妆技巧', '宠物日常', '亲子教育', '职场心得', '学习成长', '摄影作品', '游戏体验', '动漫讨论', '时事热点']; return topics[Math.floor(Math.random() * topics.length)]; }, getTopicStyle: function(categoryName) { if (!categoryName) return this.topicStyles['default']; const lowerName = categoryName.toLowerCase(); for (const [key, style] of Object.entries(this.topicStyles)) { if (lowerName.includes(key.toLowerCase())) { return style; } } return this.topicStyles['default']; }, extractIdentity: function(description) { const desc = description.toLowerCase(); for (const [identity, keywords] of Object.entries(weiboManager.identityKeywords)) { for (const keyword of keywords) { if (desc.includes(keyword.toLowerCase())) { return identity; } } } return null; }, isIdentityMatch: function(identity, categoryIdentity) { if (identity === categoryIdentity) return true; const specialMatches = { 'detective': ['horror'], 'entertainment': ['life'], 'tech': ['finance'] }; if (specialMatches[identity] && specialMatches[identity].includes(categoryIdentity)) return true; return false; }, generateFallbackContent: function(topic) { const templates = [`今天遇到了关于${topic}的有趣事情，感觉挺有意思的 🎉`, `分享一下我对${topic}的看法，大家觉得呢？${this.getRandomEmojis()}`, `刚刚体验了${topic}，感觉还不错！推荐给大家 👍`, `关于${topic}，我有一个小技巧要分享 💡`, `被${topic}惊艳到了！强烈安利 ${this.getRandomEmojis()}`]; return templates[Math.floor(Math.random() * templates.length)]; }, cleanContent: function(content) { return content.replace(/^["']|["']$/g, '').replace(/^(这是一条|我生成|我写|我创作|我发布|这是一张|这是一段|这是一个)/g, '').replace(/^(关于|今天|刚刚|最近)/g, '').trim(); }, getRandomEmojis: function() { const count = Math.floor(Math.random() * 2) + 1; let result = ''; for (let i = 0; i < count; i++) { result += this.emojis[Math.floor(Math.random() * this.emojis.length)]; } return result; }, generateTimestamp: function(daysAgo = 0) { if (daysAgo > 0) return `${daysAgo}天前`; const now = new Date(); const hoursAgo = Math.floor(Math.random() * 24); const minutesAgo = Math.floor(Math.random() * 60); if (hoursAgo > 0) return `${hoursAgo}小时前`; else if (minutesAgo > 0) return `${minutesAgo}分钟前`; else return '刚刚'; } }, getRandomNPCPersona: function() { const isFanRole = Math.random() < 0.5; const npcList = isFanRole ? this.fanNPCs : this.neutralNPCs; const index = Math.floor(Math.random() * npcList.length); return npcList[index]; }, generateComment: async function(weiboContent) { const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''); const randomLetter = letters[Math.floor(Math.random() * letters.length)]; const username = `网友${randomLetter}`; const prompt = `针对以下微博内容写一条评论，直接输出评论内容，不要提及生成过程，不要使用引号，不要解释，像真人评论一样。微博内容：${weiboContent}`; try { const content = await appState.apiService.generateRawContent("你是一个普通的社交媒体用户。", prompt, 0.7); return this.dynamicContent.cleanContent(content); } catch (error) { console.error('生成评论失败:', error); const fallbackComments = ['说得好！', '很有意思！', '点赞！', '收藏了！', '转发啦！', '期待更多分享！', '太吓人了！', '这个经历跟我好像！']; return fallbackComments[Math.floor(Math.random() * fallbackComments.length)]; } }, currentCategory: '', currentWeiboId: null, currentDeletingWeiboId: null, init: function() { this.renderCategoryTags(); this.renderCategoryList(); this.renderCategorySelect(); this.loadUserProfile(); this.switchPage('home'); this.bindEvents(); this.renderWeiboList(); this.renderDiscoverPage(); this.updateUserAvatar(); this.bindDeleteDialogEvents(); }, bindDeleteDialogEvents: function() { document.getElementById('confirm-weibo-delete-btn').addEventListener('click', () => { this.confirmDeleteWeibo(); }); document.getElementById('cancel-weibo-delete-btn').addEventListener('click', () => { this.cancelDeleteWeibo(); }); }, deleteWeibo: function(weiboId) { const index = this.weibos.findIndex(w => w.id === weiboId); if (index !== -1) { this.weibos.splice(index, 1); localStorage.setItem('weibos', JSON.stringify(this.weibos)); this.renderWeiboList(); this.loadUserProfile(); return true; } return false; }, showDeleteWeiboConfirm: function(weiboId) { this.currentDeletingWeiboId = weiboId; document.getElementById('weibo-delete-dialog').style.display = 'flex'; }, confirmDeleteWeibo: function() { if (this.currentDeletingWeiboId) { this.deleteWeibo(this.currentDeletingWeiboId); document.getElementById('weibo-delete-dialog').style.display = 'none'; this.currentDeletingWeiboId = null; } }, cancelDeleteWeibo: function() { document.getElementById('weibo-delete-dialog').style.display = 'none'; this.currentDeletingWeiboId = null; }, updateUserAvatar: function() { const userAvatar = document.getElementById('weiboUserAvatar'); if (userAvatar) { userAvatar.textContent = this.userProfile.name.charAt(0); } }, loadDynamicWeibos: async function() { const weiboList = document.getElementById('weiboList'); weiboList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">正在加载动态内容...</div>'; const newWeibos = []; const totalPostsToGenerate = 3; for (let i = 0; i < totalPostsToGenerate; i++) { try { const npcWeibo = await this.dynamicContent.generateNPCWeibo(this.currentCategory); const newWeibo = { id: Date.now() + i, username: npcWeibo.username, content: npcWeibo.content, timestamp: this.dynamicContent.generateTimestamp(Math.floor(Math.random() * 3)), category: this.currentCategory || this.getRandomCategory(), likes: Math.floor(Math.random() * 50), comments: Math.floor(Math.random() * 20), reposts: Math.floor(Math.random() * 15), commentsList: this.generateRandomComments(), userBio: npcWeibo.userBio, isLiked: false, isChatCharacter: npcWeibo.isChatCharacter || false, isFanRole: npcWeibo.isFanRole || false }; if (newWeibo) { newWeibos.push(newWeibo); } } catch (error) { console.error('生成微博失败:', error); } } this.weibos = [...newWeibos, ...this.weibos]; localStorage.setItem('weibos', JSON.stringify(this.weibos)); this.renderWeiboList(); }, getRandomCategory: function() { if (this.categories.length > 0) { return this.categories[Math.floor(Math.random() * this.categories.length)]; } return '生活'; }, generateRandomComments: function() { const comments = []; const count = Math.floor(Math.random() * 3); const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''); for(let i=0; i<count; i++) { const randomLetter = letters[Math.floor(Math.random() * letters.length)]; comments.push({ user: `网友${randomLetter}`, content: '很有意思！', time: '1小时前' }); } return comments; }, renderCategoryTags: function() { const categoryTags = document.getElementById('weiboCategoryTags'); categoryTags.innerHTML = ''; const allTag = document.createElement('div'); allTag.className = `weibo-category-tag ${this.currentCategory === '' ? 'active' : ''}`; allTag.textContent = '全部'; allTag.setAttribute('data-category', ''); allTag.addEventListener('click', () => this.filterByCategory('')); categoryTags.appendChild(allTag); this.categories.forEach(category => { const tag = document.createElement('div'); tag.className = `weibo-category-tag ${this.currentCategory === category ? 'active' : ''}`; tag.textContent = category; tag.setAttribute('data-category', category); tag.addEventListener('click', () => this.filterByCategory(category)); categoryTags.appendChild(tag); }); }, renderCategoryList: function() { const categoryList = document.getElementById('weiboCategoryList'); categoryList.innerHTML = ''; this.categories.forEach(category => { const item = document.createElement('div'); item.className = 'weibo-category-item'; item.innerHTML = `<span>${category}</span><button class="weibo-delete-category" data-category="${category}">删除</button>`; categoryList.appendChild(item); }); document.querySelectorAll('.weibo-delete-category').forEach(button => { button.addEventListener('click', (e) => { const categoryToDelete = e.target.getAttribute('data-category'); this.deleteCategory(categoryToDelete); }); }); }, renderCategorySelect: function() { const categorySelect = document.getElementById('weiboCategorySelect'); categorySelect.innerHTML = '<option value="">选择分类</option>'; this.categories.forEach(category => { const option = document.createElement('option'); option.value = category; option.textContent = category; categorySelect.appendChild(option); }); }, renderWeiboList: function() { const weiboList = document.getElementById('weiboList'); weiboList.innerHTML = ''; const filteredWeibos = this.currentCategory ? this.weibos.filter(weibo => weibo.category === this.currentCategory) : this.weibos; if (filteredWeibos.length === 0) { weiboList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">暂无微博内容，点击"刷新动态"按钮加载内容</div>'; return; } filteredWeibos.forEach(weibo => { if (typeof weibo.isLiked === 'undefined') { weibo.isLiked = false; } const weiboItem = document.createElement('div'); weiboItem.className = 'weibo-item'; const likeClass = weibo.isLiked ? 'like-btn liked' : 'like-btn'; let avatarLetter = weibo.username.charAt(0); if (weibo.username.startsWith('网友')) { avatarLetter = weibo.username.replace('网友', ''); } weiboItem.innerHTML = `<div class="weibo-avatar">${avatarLetter}</div><div class="weibo-content"><div class="weibo-item-header"><span class="weibo-username">${weibo.username}</span>${weibo.category ? `<span class="weibo-item-category">${weibo.category}</span>` : ''}<span class="weibo-timestamp">${weibo.timestamp}</span></div><div class="weibo-item-text">${weibo.content}</div><div class="weibo-item-actions"><button class="repost-btn">转发 ${weibo.reposts}</button><button class="comment-btn" data-weibo-id="${weibo.id}">评论 ${weibo.comments}</button><button class="${likeClass}" data-weibo-id="${weibo.id}">点赞 ${weibo.likes}</button><button class="delete-btn" data-weibo-id="${weibo.id}">删除</button></div></div>`; weiboList.appendChild(weiboItem); }); document.querySelectorAll('.like-btn').forEach(button => { button.addEventListener('click', function() { const weiboId = parseInt(this.getAttribute('data-weibo-id')); const weibo = weiboManager.weibos.find(w => w.id === weiboId); if (weibo) { if (weibo.isLiked) { weibo.likes = Math.max(0, weibo.likes - 1); weibo.isLiked = false; this.classList.remove('liked'); } else { weibo.likes += 1; weibo.isLiked = true; this.classList.add('liked'); } this.textContent = `点赞 ${weibo.likes}`; localStorage.setItem('weibos', JSON.stringify(weiboManager.weibos)); } }); }); document.querySelectorAll('.comment-btn').forEach(button => { button.addEventListener('click', function() { const weiboId = parseInt(this.getAttribute('data-weibo-id')); weiboManager.openCommentModal(weiboId); }); }); document.querySelectorAll('.repost-btn').forEach(button => { button.addEventListener('click', function() { const weiboId = parseInt(this.closest('.weibo-item').querySelector('.comment-btn').getAttribute('data-weibo-id')); const weibo = weiboManager.weibos.find(w => w.id === weiboId); if (weibo) { weibo.reposts += 1; localStorage.setItem('weibos', JSON.stringify(weiboManager.weibos)); this.textContent = `转发 ${weibo.reposts}`; alert('转发成功！'); } }); }); document.querySelectorAll('.delete-btn').forEach(button => { button.addEventListener('click', function() { const weiboId = parseInt(this.getAttribute('data-weibo-id')); weiboManager.showDeleteWeiboConfirm(weiboId); }); }); }, openCommentModal: function(weiboId) { this.currentWeiboId = weiboId; const weibo = this.weibos.find(w => w.id === weiboId); const commentsList = document.getElementById('weiboCommentsList'); commentsList.innerHTML = ''; if (weibo.commentsList && weibo.commentsList.length > 0) { weibo.commentsList.forEach(comment => { const commentItem = document.createElement('div'); commentItem.className = 'weibo-comment-item'; commentItem.innerHTML = `<div><span class="weibo-comment-user">${comment.user}</span><span style="font-size: 12px; color: #666;">${comment.time}</span></div><div class="weibo-comment-text">${comment.content}</div>`; commentsList.appendChild(commentItem); }); } else { commentsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">暂无评论</div>'; } document.getElementById('weiboCommentModal').style.display = 'flex'; document.getElementById('weiboCommentInput').focus(); }, submitNewComment: async function() { let content = document.getElementById('weiboCommentInput').value.trim(); if (!content && this.currentWeiboId) { const weibo = this.weibos.find(w => w.id === this.currentWeiboId); if (weibo) { const commentInput = document.getElementById('weiboCommentInput'); commentInput.value = '正在生成评论...'; commentInput.disabled = true; try { content = await this.generateComment(weibo.content); commentInput.value = content; } catch (error) { console.error('生成评论失败:', error); commentInput.value = '评论一下！'; } finally { commentInput.disabled = false; } } } if (content && this.currentWeiboId) { this.addComment(this.currentWeiboId, content); } }, addComment: function(weiboId, content) { const weibo = this.weibos.find(w => w.id === weiboId); if (weibo) { if (!weibo.commentsList) { weibo.commentsList = []; } weibo.commentsList.unshift({ user: this.userProfile.name, content: content, time: '刚刚' }); weibo.comments += 1; localStorage.setItem('weibos', JSON.stringify(this.weibos)); document.getElementById('weiboCommentInput').value = ''; document.getElementById('weiboCommentModal').style.display = 'none'; this.renderWeiboList(); } }, renderDiscoverPage: function() { this.renderTrendingTopics(); this.renderRecommendedUsers(); this.renderRandomQuote(); this.generateTrendingTopics(); }, renderTrendingTopics: function() { const topicList = document.getElementById('weiboTopicList'); topicList.innerHTML = ''; const shuffledTopics = [...this.trendingTopics].sort(() => 0.5 - Math.random()); const selectedTopics = shuffledTopics.slice(0, 3); selectedTopics.forEach(topic => { const topicItem = document.createElement('div'); topicItem.className = 'weibo-topic-item'; topicItem.innerHTML = `<div class="weibo-topic-name">${topic.name}</div><div class="weibo-topic-stats">${topic.posts} 帖子 · ${topic.trend}</div>`; topicList.appendChild(topicItem); }); }, generateTrendingTopics: function() { const topics = [{ name: '#AI技术分享#', posts: (Math.floor(Math.random() * 50) + 10) + '万', trend: '热' }, { name: '#日常生活#', posts: (Math.floor(Math.random() * 100) + 20) + '万', trend: '新' }, { name: '#美食探店#', posts: (Math.floor(Math.random() * 80) + 15) + '万', trend: '沸' }, { name: '#恐怖故事#', posts: (Math.floor(Math.random() * 60) + 5) + '万', trend: '新' }]; this.trendingTopics = topics; this.renderTrendingTopics(); }, renderRecommendedUsers: function() { const userList = document.getElementById('weiboUserList'); userList.innerHTML = ''; const aiPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}'); if (aiPersona.name && aiPersona.description) { const aiUserItem = document.createElement('div'); aiUserItem.className = 'weibo-user-item'; const avatarLetter = aiPersona.name.charAt(0); aiUserItem.innerHTML = `<div class="weibo-user-avatar">${avatarLetter}</div><div class="weibo-user-info"><div class="weibo-user-name">${aiPersona.name}</div><div class="weibo-user-bio">${aiPersona.description}</div></div><button class="weibo-follow-btn">关注</button>`; userList.appendChild(aiUserItem); } const shuffledNeutralNPCs = [...this.neutralNPCs].sort(() => 0.5 - Math.random()); const shuffledFanNPCs = [...this.fanNPCs].sort(() => 0.5 - Math.random()); const selectedNeutralNPCs = shuffledNeutralNPCs.slice(0, Math.floor(Math.random() * 2) + 1); const selectedFanNPCs = shuffledFanNPCs.slice(0, Math.floor(Math.random() * 2) + 1); const allNPCs = [...selectedNeutralNPCs, ...selectedFanNPCs]; allNPCs.forEach(npc => { const userItem = document.createElement('div'); userItem.className = 'weibo-user-item'; let avatarLetter = npc.name.charAt(0); if (npc.name.startsWith('网友')) { avatarLetter = npc.name.replace('网友', ''); } userItem.innerHTML = `<div class="weibo-user-avatar">${avatarLetter}</div><div class="weibo-user-info"><div class="weibo-user-name">${npc.name}</div><div class="weibo-user-bio">${npc.description}</div></div><button class="weibo-follow-btn">关注</button>`; userList.appendChild(userItem); }); document.querySelectorAll('.weibo-follow-btn').forEach(button => { button.addEventListener('click', function() { if (this.textContent === '关注') { this.textContent = '已关注'; this.style.backgroundColor = '#000'; this.style.color = '#fff'; } else { this.textContent = '关注'; this.style.backgroundColor = ''; this.style.color = ''; } }); }); }, renderRandomQuote: function() { const randomIndex = Math.floor(Math.random() * this.quotes.length); document.getElementById('weiboRandomQuote').textContent = this.quotes[randomIndex]; }, loadUserProfile: function() { document.getElementById('weiboProfileName').value = this.userProfile.name; document.getElementById('weiboProfileBio').value = this.userProfile.bio; document.getElementById('weiboProfilePersona').value = this.userProfile.persona; document.getElementById('weiboProfileLocation').value = this.userProfile.location; document.getElementById('weiboProfileFollowers').value = this.userProfile.followers; document.getElementById('weiboProfileFollowing').value = this.userProfile.following; document.getElementById('myProfileName').textContent = this.userProfile.name; document.getElementById('myProfileBio').textContent = this.userProfile.bio; document.getElementById('myProfileFollowers').textContent = this.userProfile.followers; document.getElementById('myProfileFollowing').textContent = this.userProfile.following; document.getElementById('myProfileWeibos').textContent = this.weibos.filter(w => w.username === this.userProfile.name).length; const myProfileAvatar = document.getElementById('myProfileAvatar'); if (myProfileAvatar) { myProfileAvatar.textContent = this.userProfile.name.charAt(0); } }, saveUserProfile: function() { this.userProfile = { name: document.getElementById('weiboProfileName').value.trim() || '微博用户', bio: document.getElementById('weiboProfileBio').value.trim() || '这个人很懒，什么都没有写...', persona: document.getElementById('weiboProfilePersona').value.trim() || '普通用户', location: document.getElementById('weiboProfileLocation').value.trim(), followers: parseInt(document.getElementById('weiboProfileFollowers').value) || 0, following: parseInt(document.getElementById('weiboProfileFollowing').value) || 0 }; localStorage.setItem('weiboUserProfile', JSON.stringify(this.userProfile)); document.getElementById('weiboProfileModal').style.display = 'none'; this.updateUserWeibos(); this.updateUserAvatar(); this.loadUserProfile(); }, updateUserWeibos: function() { this.weibos.forEach(weibo => { if (weibo.username === '当前用户') { weibo.username = this.userProfile.name; } }); localStorage.setItem('weibos', JSON.stringify(this.weibos)); this.renderWeiboList(); }, filterByCategory: function(category) { this.currentCategory = category; this.renderCategoryTags(); this.renderWeiboList(); }, addCategory: function() { const newCategory = document.getElementById('weiboNewCategoryInput').value.trim(); if (newCategory && !this.categories.includes(newCategory)) { this.categories.push(newCategory); localStorage.setItem('weiboCategories', JSON.stringify(this.categories)); this.renderCategoryTags(); this.renderCategoryList(); this.renderCategorySelect(); document.getElementById('weiboNewCategoryInput').value = ''; } }, deleteCategory: function(category) { this.categories = this.categories.filter(c => c !== category); localStorage.setItem('weiboCategories', JSON.stringify(this.categories)); this.renderCategoryTags(); this.renderCategoryList(); this.renderCategorySelect(); if (this.currentCategory === category) { this.filterByCategory(''); } }, publishWeibo: async function() { const content = document.getElementById('weiboText').value.trim(); const category = document.getElementById('weiboCategorySelect').value; if (!content) { alert('请输入微博内容！'); return; } if (content) { const newWeibo = { id: Date.now(), username: this.userProfile.name, content: content, timestamp: '刚刚', category: category, likes: 0, comments: 0, reposts: 0, commentsList: [], isLiked: false, isChatCharacter: false, isFanRole: false }; this.weibos.unshift(newWeibo); localStorage.setItem('weibos', JSON.stringify(this.weibos)); document.getElementById('weiboText').value = ''; document.getElementById('weiboCategorySelect').value = ''; this.renderWeiboList(); this.loadUserProfile(); alert('微博发布成功！'); } }, refreshDynamicContent: async function() { await this.loadDynamicWeibos(); this.renderDiscoverPage(); alert('已添加新动态！'); }, switchPage: function(pageName) { document.getElementById('weiboHomePage').classList.remove('active'); document.getElementById('weiboDiscoverPage').classList.remove('active'); document.getElementById('weiboProfilePage').classList.remove('active'); document.getElementById('weiboHomeLink').classList.remove('active'); document.getElementById('weiboDiscoverLink').classList.remove('active'); document.getElementById('weiboProfileLink').classList.remove('active'); if (pageName === 'home') { document.getElementById('weiboHomePage').classList.add('active'); document.getElementById('weiboHomeLink').classList.add('active'); } else if (pageName === 'discover') { document.getElementById('weiboDiscoverPage').classList.add('active'); document.getElementById('weiboDiscoverLink').classList.add('active'); this.renderDiscoverPage(); } else if (pageName === 'profile') { document.getElementById('weiboProfilePage').classList.add('active'); document.getElementById('weiboProfileLink').classList.add('active'); this.loadUserProfile(); } }, bindEvents: function() { document.getElementById('weiboManageCategories').addEventListener('click', () => { document.getElementById('weiboCategoryModal').style.display = 'flex'; }); document.getElementById('weiboCloseCategoryModal').addEventListener('click', () => { document.getElementById('weiboCategoryModal').style.display = 'none'; }); document.getElementById('weiboProfileLink').addEventListener('click', (e) => { e.preventDefault(); this.switchPage('profile'); }); document.getElementById('weiboCloseProfileModal').addEventListener('click', () => { document.getElementById('weiboProfileModal').style.display = 'none'; }); document.getElementById('weiboUserAvatar').addEventListener('click', () => { this.loadUserProfile(); document.getElementById('weiboProfileModal').style.display = 'flex'; }); document.getElementById('weiboHomeLink').addEventListener('click', (e) => { e.preventDefault(); this.switchPage('home'); }); document.getElementById('weiboDiscoverLink').addEventListener('click', (e) => { e.preventDefault(); this.switchPage('discover'); }); document.getElementById('weiboAddCategoryBtn').addEventListener('click', () => { this.addCategory(); }); document.getElementById('weiboNewCategoryInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') { this.addCategory(); } }); document.getElementById('weiboSaveProfileBtn').addEventListener('click', () => { this.saveUserProfile(); }); document.getElementById('weiboPublishBtn').addEventListener('click', () => { this.publishWeibo(); }); document.getElementById('weiboText').addEventListener('keypress', (e) => { if (e.ctrlKey && e.key === 'Enter') { this.publishWeibo(); } }); document.getElementById('weiboRefreshTopics').addEventListener('click', () => { this.renderTrendingTopics(); }); document.getElementById('weiboRefreshUsers').addEventListener('click', () => { this.renderRecommendedUsers(); }); document.getElementById('weiboCloseCommentModal').addEventListener('click', () => { document.getElementById('weiboCommentModal').style.display = 'none'; }); document.getElementById('weiboCancelComment').addEventListener('click', () => { document.getElementById('weiboCommentModal').style.display = 'none'; }); document.getElementById('weiboSubmitComment').addEventListener('click', () => { this.submitNewComment(); }); document.getElementById('weiboCommentInput').addEventListener('keypress', (e) => { if (e.key === 'Enter' && e.ctrlKey) { this.submitNewComment(); } }); document.getElementById('weiboRefreshDynamicBtn').addEventListener('click', () => { this.refreshDynamicContent(); }); document.getElementById('editMyProfileBtn').addEventListener('click', () => { this.loadUserProfile(); document.getElementById('weiboProfileModal').style.display = 'flex'; }); } };
        const appState = { currentPersona: null, apiConfig: {}, customCSS: '', isGenerating: false, models: [], lastUpdated: null, apiService: new ApiService(), chatManager: new ChatManager(), worldbookManager: new WorldbookManager(), multiPersonaManager: new MultiPersonaManager(), currentPersonaTab: 'ai', currentEditingMessageId: null, selectionMode: false, selectedMessageIds: [], chatMode: 'online', chatType: 'single' };
        const API_ENDPOINTS = { openai: 'https://api.openai.com/v1', anthropic: 'https://api.anthropic.com/v1', google: 'https://generativelanguage.googleapis.com/v1' };
        const MODEL_LISTS = { openai: ['gpt-4', 'gpt-4-turbo', 'gpt-3.5-turbo', 'gpt-3.5-turbo-16k'], anthropic: ['claude-3-opus', 'claude-3-sonnet', 'claude-3-haiku'], google: ['gemini-pro', 'gemini-pro-vision'] };
        let currentInterface = 'desktop'; let deleteMessageId = null; let deleteWorldbookId = null;
        appState.chatManager.addListener('messagesChanged', (messages) => { renderChatMessages(); }); appState.chatManager.addListener('messageUpdated', (message) => { renderChatMessages(); }); appState.chatManager.addListener('messageDeleted', (message) => { renderChatMessages(); });
        function switchChatType(type) { appState.chatType = type; localStorage.setItem('chatType', type); updateChatTypeUI(); const typeNames = { 'single': '单聊模式', 'multi': '多聊模式' }; const typeDescriptions = { 'single': '和一个角色进行聊天', 'multi': '和多个角色进行聊天，可切换不同角色回复' }; alert(`已切换到${typeNames[type]}！\n${typeDescriptions[type]}`); }
        function updateChatTypeUI() { const singleBtn = document.getElementById('single-chat-btn'); const multiBtn = document.getElementById('multi-chat-btn'); const personaSelector = document.getElementById('multi-persona-selector'); singleBtn.classList.remove('active'); multiBtn.classList.remove('active'); if (appState.chatType === 'single') { singleBtn.classList.add('active'); personaSelector.classList.remove('active'); } else { multiBtn.classList.add('active'); personaSelector.classList.add('active'); refreshMultiPersonaSelect(); } }
        function loadChatType() { const savedType = localStorage.getItem('chatType'); if (savedType) { appState.chatType = savedType; } updateChatTypeUI(); }
        function refreshMultiPersonaSelect() { const personaSelect = document.getElementById('multi-persona-select'); const personas = appState.multiPersonaManager.getAllPersonas(); personaSelect.innerHTML = ''; if (personas.length === 0) { const option = document.createElement('option'); option.value = ''; option.textContent = '请先添加多聊角色'; personaSelect.appendChild(option); return; } personas.forEach(persona => { const option = document.createElement('option'); option.value = persona.id; option.textContent = persona.name; if (appState.multiPersonaManager.currentPersonaId === persona.id) { option.selected = true; } personaSelect.appendChild(option); }); }
        function switchMultiPersona() { const personaSelect = document.getElementById('multi-persona-select'); const selectedId = personaSelect.value; if (selectedId) { appState.multiPersonaManager.setCurrentPersona(selectedId); const currentPersona = appState.multiPersonaManager.getCurrentPersona(); if (currentPersona) { alert(`已切换到角色: ${currentPersona.name}`); } } }
        function addMultiPersona() { const nameInput = document.getElementById('multi-persona-name'); const descInput = document.getElementById('multi-persona-desc'); const name = nameInput.value.trim(); const desc = descInput.value.trim(); if (!name || !desc) { alert('请填写角色姓名和人设描述！'); return; } const persona = appState.multiPersonaManager.addPersona(name, desc); nameInput.value = ''; descInput.value = ''; refreshMultiPersonaPreview(); if (appState.chatType === 'multi') { refreshMultiPersonaSelect(); } alert(`已添加角色: ${persona.name}`); }
        function saveMultiPersonas() { alert('多聊角色已保存！'); }
        function refreshMultiPersonaPreview() { const previewContent = document.getElementById('multi-preview-content'); const personas = appState.multiPersonaManager.getAllPersonas(); if (personas.length === 0) { previewContent.innerHTML = '暂无多聊角色'; return; } let html = ''; personas.forEach(persona => { html += `<div style="margin-bottom: 10px; padding: 8px; border: 1px solid #000; border-radius: 4px; background: white;"><strong>${persona.name}</strong><div style="font-size: 10px; color: #000; margin-top: 4px;">${persona.description}</div><div style="font-size: 9px; color: #333; margin-top: 2px;">${new Date(persona.timestamp).toLocaleString()}</div><button onclick="deleteMultiPersona('${persona.id}')" style="margin-top: 5px; padding: 2px 6px; font-size: 10px; background: white; border: 1px solid #000; border-radius: 3px; cursor: pointer; color: #000;">删除</button></div>`; }); previewContent.innerHTML = html; }
        function deleteMultiPersona(personaId) { if (confirm('确定要删除这个角色吗？')) { const success = appState.multiPersonaManager.deletePersona(personaId); if (success) { refreshMultiPersonaPreview(); if (appState.chatType === 'multi') { refreshMultiPersonaSelect(); } alert('角色已删除！'); } } }
        function switchChatMode(mode) { appState.chatMode = mode; localStorage.setItem('chatMode', mode); updateChatModeUI(); const modeNames = { 'online': '线上模式', 'offline': '线下模式' }; const modeDescriptions = { 'online': '短信模式：短文本，日常说话语气，不加修饰词', 'offline': '剧情模式：长文本，走唯美长剧情，小说式，各种修饰词都可以写' }; alert(`已切换到${modeNames[mode]}！\n${modeDescriptions[mode]}`); }
        function updateChatModeUI() { const onlineBtn = document.getElementById('online-mode-btn'); const offlineBtn = document.getElementById('offline-mode-btn'); const modeDisplay = document.getElementById('chat-mode-display'); const modeIndicator = document.getElementById('chat-mode-indicator'); onlineBtn.classList.remove('active'); offlineBtn.classList.remove('active'); if (appState.chatMode === 'online') { onlineBtn.classList.add('active'); modeDisplay.textContent = '线上模式'; modeIndicator.className = 'chat-mode-indicator chat-mode-online'; } else { offlineBtn.classList.add('active'); modeDisplay.textContent = '线下模式'; modeIndicator.className = 'chat-mode-indicator chat-mode-offline'; } }
        function loadChatMode() { const savedMode = localStorage.getItem('chatMode'); if (savedMode) { appState.chatMode = savedMode; } updateChatModeUI(); }
        function clearAllChatHistory() { const messageCount = appState.chatManager.getMessageCount(); if (messageCount === 0) { alert('聊天记录已经是空的！'); return; } document.getElementById('clear-chat-text').textContent = `您确定要清空所有 ${messageCount} 条聊天记录吗？此操作不可撤销。`; document.getElementById('clear-chat-dialog').style.display = 'flex'; }
        function confirmClearChatHistory() { const deletedCount = appState.chatManager.clearAllMessages(); document.getElementById('clear-chat-dialog').style.display = 'none'; alert(`已成功清空 ${deletedCount} 条聊天记录！`); renderChatMessages(); }
        function cancelClearChatHistory() { document.getElementById('clear-chat-dialog').style.display = 'none'; }
        function toggleSelectionMode() { appState.selectionMode = !appState.selectionMode; const chatMessages = document.getElementById('chat-messages'); const selectionModeInfo = document.getElementById('selection-mode-info'); const selectionActions = document.getElementById('selection-actions'); const selectionModeBtn = document.getElementById('selection-mode-btn'); if (appState.selectionMode) { chatMessages.classList.add('selection-mode'); selectionModeInfo.classList.add('active'); selectionActions.classList.add('active'); selectionModeBtn.textContent = '退出选择模式'; selectionModeBtn.classList.add('danger'); appState.selectedMessageIds = []; updateSelectionCount(); } else { chatMessages.classList.remove('selection-mode'); selectionModeInfo.classList.remove('active'); selectionActions.classList.remove('active'); selectionModeBtn.textContent = '选择消息清空'; selectionModeBtn.classList.remove('danger'); document.querySelectorAll('.message.selected').forEach(message => { message.classList.remove('selected'); }); appState.selectedMessageIds = []; } renderChatMessages(); }
        function toggleMessageSelection(messageId, checkbox) { const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`); if (checkbox.checked) { if (!appState.selectedMessageIds.includes(messageId)) { appState.selectedMessageIds.push(messageId); messageElement.classList.add('selected'); } } else { const index = appState.selectedMessageIds.indexOf(messageId); if (index !== -1) { appState.selectedMessageIds.splice(index, 1); messageElement.classList.remove('selected'); } } updateSelectionCount(); }
        function updateSelectionCount() { const selectionCount = document.getElementById('selection-count'); selectionCount.textContent = appState.selectedMessageIds.length; }
        function deleteSelectedMessages() { const selectedCount = appState.selectedMessageIds.length; if (selectedCount === 0) { alert('请先选择要删除的消息！'); return; } document.getElementById('delete-selected-text').textContent = `您确定要删除选中的 ${selectedCount} 条消息吗？此操作不可撤销。`; document.getElementById('delete-selected-dialog').style.display = 'flex'; }
        function confirmDeleteSelectedMessages() { const deletedCount = appState.chatManager.deleteMessages(appState.selectedMessageIds); document.getElementById('delete-selected-dialog').style.display = 'none'; toggleSelectionMode(); alert(`已成功删除 ${deletedCount} 条消息！`); }
        function cancelDeleteSelectedMessages() { document.getElementById('delete-selected-dialog').style.display = 'none'; }
        let sendButtonClickCount = 0; let sendButtonTimer = null; let lastClickTime = 0;
        function handleSendButtonClick() { const currentTime = new Date().getTime(); const timeDiff = currentTime - lastClickTime; lastClickTime = currentTime; sendButtonClickCount++; if (sendButtonTimer) { clearTimeout(sendButtonTimer); } if (sendButtonClickCount === 1 || timeDiff > 2000) { sendButtonTimer = setTimeout(() => { addUserMessageOnly(); sendButtonClickCount = 0; sendButtonTimer = null; }, 200); } else if (sendButtonClickCount === 2 && timeDiff <= 2000) { clearTimeout(sendButtonTimer); addUserMessageAndCallAI(); sendButtonClickCount = 0; sendButtonTimer = null; } }
        function addUserMessageOnly() { 
            const input = document.getElementById('message-input'); 
            const message = input.value.trim(); 
            if (!message) return; 
            input.value = ''; 
            
            // 获取用户人设名称
            const userPersona = JSON.parse(localStorage.getItem('userPersona') || '{}');
            const userName = userPersona.name || '您';
            
            // 用户消息不关联personaId
            appState.chatManager.addMessage('user', message, userName, null); 
            renderChatMessages(); 
        }
        function addUserMessageAndCallAI() { 
            const input = document.getElementById('message-input'); 
            const message = input.value.trim(); 
            if (!message) return; 
            input.value = ''; 
            
            // 获取用户人设名称
            const userPersona = JSON.parse(localStorage.getItem('userPersona') || '{}');
            const userName = userPersona.name || '您';
            
            // 用户消息不关联personaId
            appState.chatManager.addMessage('user', message, userName, null); 
            renderChatMessages(); 
            callAI(); 
        }
        async function callAI() { 
            if (appState.isGenerating) return; 
            const sendButton = document.getElementById('send-button'); 
            appState.isGenerating = true; 
            sendButton.disabled = true; 
            sendButton.textContent = '生成中...'; 
            updateStatusIndicators(); 
            
            const messages = appState.chatManager.getMessages(); 
            const lastUserMessage = messages.filter(msg => msg.sender === 'user').pop(); 
            if (!lastUserMessage) { 
                appState.isGenerating = false; 
                sendButton.disabled = false; 
                sendButton.textContent = '发送'; 
                return; 
            } 
            
            // 获取当前角色的名称和ID
            let aiName;
            let personaId = null;
            let rolePrompt;

            if (appState.chatType === 'single') {
                const aiPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}');
                aiName = aiPersona.name || '助手';
                rolePrompt = getCurrentRolePrompt();
                personaId = null;
            } else {
                const currentPersona = appState.multiPersonaManager.getCurrentPersona();
                if (!currentPersona) { 
                    alert('请先选择多聊角色！'); 
                    appState.isGenerating = false; 
                    sendButton.disabled = false; 
                    sendButton.textContent = '发送'; 
                    return; 
                } 
                aiName = currentPersona.name;
                rolePrompt = currentPersona.description;
                personaId = currentPersona.id; // 保存角色ID
            }
            
            const thinkingMessage = appState.chatManager.addMessage('ai', '正在思考...', aiName, personaId); 
            renderChatMessages(); 
            
            try { 
                const temperature = parseFloat(document.getElementById('temperature').value) || 0.7; 
                const replyCount = parseInt(document.getElementById('reply-count').value) || 1; 
                
                const replies = await appState.apiService.chatWithRole(
                    rolePrompt, 
                    lastUserMessage.content, 
                    temperature, 
                    replyCount, 
                    appState.chatMode,
                    appState.chatType, 
                    aiName
                ); 
                
                appState.chatManager.deleteMessage(thinkingMessage.id); 
                
                replies.forEach((reply, index) => { 
                    let finalContent = reply; 
                    if (index > 0 && replyCount > 1) { 
                        finalContent = `（继续）\n${reply}`; 
                    } 
                    // 保存消息时传入personaId，这样每个AI消息都知道是哪个角色发送的
                    appState.chatManager.addMessage('ai', finalContent, aiName, personaId); 
                }); 
                
                renderChatMessages(); 
            } catch (error) { 
                appState.chatManager.updateMessage(thinkingMessage.id, `抱歉，生成回复时出现错误：${error.message}`); 
                renderChatMessages(); 
            } finally { 
                appState.isGenerating = false; 
                sendButton.disabled = false; 
                sendButton.textContent = '发送'; 
                updateStatusIndicators(); 
            } 
        }
        function exportWorldbookRecords() { const records = appState.worldbookManager.getAllRecords(); if (records.length === 0) { showWorldbookBackupStatus('没有世界书记录可以导出', 'error'); return; } const exportData = { version: '1.0', exportTime: new Date().toISOString(), recordCount: records.length, records: records }; const dataStr = JSON.stringify(exportData, null, 2); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `worldbook_records_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); showWorldbookBackupStatus(`成功导出 ${records.length} 条世界书记录`, 'success'); }
        function importWorldbookRecords() { document.getElementById('worldbook-backup-file-input').click(); }
        document.getElementById('worldbook-backup-file-input').addEventListener('change', function(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const importData = JSON.parse(e.target.result); if (!importData.records || !Array.isArray(importData.records)) { showWorldbookBackupStatus('文件格式不正确', 'error'); return; } showWorldbookImportConfirm(importData); } catch (error) { console.error('解析文件失败:', error); showWorldbookBackupStatus('文件解析失败，请检查文件格式', 'error'); } }; reader.readAsText(file); e.target.value = ''; });
        function showWorldbookImportConfirm(importData) { const dialog = document.createElement('div'); dialog.className = 'confirm-dialog'; dialog.style.display = 'flex'; dialog.innerHTML = `<div class="confirm-content"><h3>导入世界书记录</h3><p>导入世界书记录将覆盖当前的所有记录，此操作不可撤销。确定要导入 ${importData.recordCount} 条记录吗？</p><div class="confirm-buttons"><button id="worldbook-confirm-import-btn">确认导入</button><button id="worldbook-cancel-import-btn">取消</button></div></div>`; document.body.appendChild(dialog); document.getElementById('worldbook-confirm-import-btn').onclick = function() { performWorldbookImport(importData); document.body.removeChild(dialog); }; document.getElementById('worldbook-cancel-import-btn').onclick = function() { document.body.removeChild(dialog); }; }
        function performWorldbookImport(importData) { try { appState.worldbookManager.records.length = 0; importData.records.forEach(record => { appState.worldbookManager.records.push(record); }); appState.worldbookManager.saveRecords(); renderWorldbookList(); updateWorldbookStatusIndicator(); showWorldbookBackupStatus(`成功导入 ${importData.recordCount} 条世界书记录`, 'success'); } catch (error) { console.error('导入世界书记录失败:', error); showWorldbookBackupStatus('导入世界书记录失败', 'error'); } }
        function backupWorldbookToLocal() { const records = appState.worldbookManager.getAllRecords(); if (records.length === 0) { showWorldbookBackupStatus('没有世界书记录可以备份', 'error'); return; } const backupData = { version: '1.0', backupTime: new Date().toISOString(), recordCount: records.length, records: records }; localStorage.setItem('worldbookBackup', JSON.stringify(backupData)); showWorldbookBackupStatus(`成功备份 ${records.length} 条世界书记录到本地`, 'success'); }
        function restoreWorldbookFromLocal() { const backupDataStr = localStorage.getItem('worldbookBackup'); if (!backupDataStr) { showWorldbookBackupStatus('没有找到本地备份', 'error'); return; } try { const backupData = JSON.parse(backupDataStr); if (!backupData.records || !Array.isArray(backupData.records)) { showWorldbookBackupStatus('备份数据格式不正确', 'error'); return; } const dialog = document.createElement('div'); dialog.className = 'confirm-dialog'; dialog.style.display = 'flex'; dialog.innerHTML = `<div class="confirm-content"><h3>恢复世界书记录</h3><p>恢复世界书记录将覆盖当前的所有记录，此操作不可撤销。确定要恢复 ${backupData.recordCount} 条记录吗？</p><div class="confirm-buttons"><button id="worldbook-confirm-restore-btn">确认恢复</button><button id="worldbook-cancel-restore-btn">取消</button></div></div>`; document.body.appendChild(dialog); document.getElementById('worldbook-confirm-restore-btn').onclick = function() { performWorldbookRestore(backupData); document.body.removeChild(dialog); }; document.getElementById('worldbook-cancel-restore-btn').onclick = function() { document.body.removeChild(dialog); }; } catch (error) { console.error('解析备份数据失败:', error); showWorldbookBackupStatus('备份数据解析失败', 'error'); } }
        function performWorldbookRestore(backupData) { try { appState.worldbookManager.records.length = 0; backupData.records.forEach(record => { appState.worldbookManager.records.push(record); }); appState.worldbookManager.saveRecords(); renderWorldbookList(); updateWorldbookStatusIndicator(); showWorldbookBackupStatus(`成功恢复 ${backupData.recordCount} 条世界书记录`, 'success'); } catch (error) { console.error('恢复世界书记录失败:', error); showWorldbookBackupStatus('恢复世界书记录失败', 'error'); } }
        function showWorldbookBackupStatus(message, type) { const statusDiv = document.getElementById('worldbook-backup-status'); statusDiv.textContent = message; statusDiv.className = `worldbook-backup-status worldbook-backup-${type}`; statusDiv.style.display = 'block'; setTimeout(() => { statusDiv.style.display = 'none'; }, 3000); }
        function updateDesktopTime() { const now = new Date(); const hours = now.getHours().toString().padStart(2, '0'); const minutes = now.getMinutes().toString().padStart(2, '0'); document.getElementById('desktop-time').textContent = `${hours}:${minutes}`; }
        function openApp(appName) { document.getElementById('desktop-interface').classList.remove('active'); document.getElementById(`${appName}-interface`).classList.add('active'); currentInterface = appName; updateStatusIndicators(); if (appName === 'worldbook') { renderWorldbookList(); updateWorldbookStatusIndicator(); } if (appName === 'wallet') { walletManager.initWallet(); walletManager.setupEventListeners(); } if (appName === 'weibo') { weiboManager.init(); } }
        function goBackToDesktop() { document.querySelectorAll('.interface').forEach(interface => { interface.classList.remove('active'); }); document.getElementById('desktop-interface').classList.add('active'); currentInterface = 'desktop'; }
        function showDeleteConfirm(messageId) { deleteMessageId = messageId; document.getElementById('confirm-dialog').style.display = 'flex'; }
        function confirmDelete() { if (!deleteMessageId) { document.getElementById('confirm-dialog').style.display = 'none'; return; } appState.chatManager.deleteMessage(deleteMessageId); renderChatMessages(); document.getElementById('confirm-dialog').style.display = 'none'; deleteMessageId = null; }
        function cancelDelete() { document.getElementById('confirm-dialog').style.display = 'none'; deleteMessageId = null; }
        function openPersonaModal() { document.getElementById('persona-modal').style.display = 'flex'; loadPersonaPreviews(); refreshMultiPersonaPreview(); }
        function closePersonaModal() { document.getElementById('persona-modal').style.display = 'none'; }
        function switchPersonaTab(tabName) { document.querySelectorAll('.persona-tab').forEach(tab => { tab.classList.remove('active'); }); document.querySelectorAll('.persona-form-section').forEach(section => { section.classList.remove('active'); }); document.querySelector(`.persona-tab[onclick="switchPersonaTab('${tabName}')"]`).classList.add('active'); document.getElementById(`${tabName}-persona-section`).classList.add('active'); appState.currentPersonaTab = tabName; loadPersonaPreviews(); if (tabName === 'multi') { refreshMultiPersonaPreview(); } }
        function loadPersonaPreviews() { const aiPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}'); const userPersona = JSON.parse(localStorage.getItem('userPersona') || '{}'); if (aiPersona.name || aiPersona.description) { document.getElementById('ai-preview-content').innerHTML = `<strong>姓名:</strong> ${aiPersona.name || '未设置'}<br><strong>描述:</strong> ${aiPersona.description || '未设置'}`; } else { document.getElementById('ai-preview-content').textContent = '暂无角色人设'; } if (userPersona.name || userPersona.description) { document.getElementById('user-preview-content').innerHTML = `<strong>姓名:</strong> ${userPersona.name || '未设置'}<br><strong>描述:</strong> ${userPersona.description || '未设置'}`; } else { document.getElementById('user-preview-content').textContent = '暂无我的人设'; } }
        function saveAIPersona() { const name = document.getElementById('ai-persona-name').value.trim(); const desc = document.getElementById('ai-persona-desc').value.trim(); const persona = { name: name, description: desc, timestamp: new Date().toISOString() }; localStorage.setItem('aiPersona', JSON.stringify(persona)); loadPersonaPreviews(); renderChatMessages(); alert('角色人设保存成功！'); }
        function loadAIPersona() { const savedPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}'); document.getElementById('ai-persona-name').value = savedPersona.name || ''; document.getElementById('ai-persona-desc').value = savedPersona.description || ''; loadPersonaPreviews(); renderChatMessages(); alert('角色人设加载成功！'); }
        function saveUserPersona() { const name = document.getElementById('user-persona-name').value.trim(); const desc = document.getElementById('user-persona-desc').value.trim(); const persona = { name: name, description: desc, timestamp: new Date().toISOString() }; localStorage.setItem('userPersona', JSON.stringify(persona)); loadPersonaPreviews(); renderChatMessages(); alert('我的人设保存成功！'); }
        function loadUserPersona() { const savedPersona = JSON.parse(localStorage.getItem('userPersona') || '{}'); document.getElementById('user-persona-name').value = savedPersona.name || ''; document.getElementById('user-persona-desc').value = savedPersona.description || ''; loadPersonaPreviews(); renderChatMessages(); alert('我的人设加载成功！'); }
        function editMessage(button, messageId) { const messageElement = button.closest('.message'); const contentElement = messageElement.querySelector('.message-content'); const currentContent = contentElement.textContent; messageElement.classList.add('editing'); contentElement.innerHTML = `<textarea class="edit-input">${currentContent}</textarea><div class="edit-actions"><button onclick="saveEdit('${messageId}')">保存</button><button onclick="cancelEdit('${messageId}')">取消</button></div>`; appState.currentEditingMessageId = messageId; }
        function saveEdit(messageId) { const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`); const textarea = messageElement.querySelector('.edit-input'); const newContent = textarea.value.trim(); if (newContent) { if (appState.chatManager.updateMessage(messageId, newContent)) { messageElement.classList.remove('editing'); messageElement.querySelector('.message-content').innerHTML = newContent; } } appState.currentEditingMessageId = null; }
        function cancelEdit(messageId) { const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`); messageElement.classList.remove('editing'); const message = appState.chatManager.messages.find(msg => msg.id === messageId); if (message) { messageElement.querySelector('.message-content').innerHTML = message.content; } appState.currentEditingMessageId = null; }
        function updateStatusIndicators() { const chatStatus = document.getElementById('chat-status'); const apiStatus = document.getElementById('api-status-indicator'); const styleStatus = document.getElementById('style-status'); const musicStatus = document.getElementById('music-status'); const walletStatus = document.getElementById('wallet-status'); const weiboStatus = document.getElementById('weibo-status'); if (appState.isGenerating) { chatStatus.className = 'status-indicator status-generating'; chatStatus.title = '正在生成回复...'; } else { if (appState.currentPersona) { chatStatus.className = 'status-indicator status-online'; chatStatus.title = '人设已应用'; } else { chatStatus.className = 'status-indicator status-offline'; chatStatus.title = '使用默认人设'; } } const currentConfig = appState.apiService.getCurrentConfig(); if (currentConfig.apiKey && currentConfig.model) { apiStatus.className = 'status-indicator status-online'; apiStatus.title = 'API配置完成'; } else { apiStatus.className = 'status-indicator status-offline'; apiStatus.title = 'API未配置'; } if (appState.customCSS) { styleStatus.className = 'status-indicator status-online'; styleStatus.title = '自定义样式已应用'; } else { styleStatus.className = 'status-indicator status-offline'; styleStatus.title = '使用默认样式'; } if (musicPlayer.isPlaying) { musicStatus.className = 'status-indicator status-online'; musicStatus.title = '正在播放'; } else { musicStatus.className = 'status-indicator status-offline'; musicStatus.title = '未播放'; } if (walletManager.walletData && walletManager.walletData.totalBalance > 0) { walletStatus.className = 'status-indicator status-online'; walletStatus.title = '钱包余额充足'; } else { walletStatus.className = 'status-indicator status-offline'; walletStatus.title = '钱包余额为空'; } if (weiboManager.weibos && weiboManager.weibos.length > 0) { weiboStatus.className = 'status-indicator status-online'; weiboStatus.title = `有 ${weiboManager.weibos.length} 条动态微博`; } else { weiboStatus.className = 'status-indicator status-offline'; weiboStatus.title = '微博内容加载中'; } }
        function updateWorldbookStatusIndicator() { const headerIndicator = document.getElementById('worldbook-status-indicator'); const titleIndicator = document.getElementById('worldbook-status-indicator-title'); const activeRecords = appState.worldbookManager.getActiveRecords(); if (activeRecords.length > 0) { headerIndicator.className = 'status-indicator status-online'; headerIndicator.title = `有 ${activeRecords.length} 条激活的世界书记录`; titleIndicator.className = 'status-indicator status-online'; titleIndicator.title = `有 ${activeRecords.length} 条激活的世界书记录`; } else { headerIndicator.className = 'status-indicator status-offline'; headerIndicator.title = '没有激活的世界书记录'; titleIndicator.className = 'status-indicator status-offline'; titleIndicator.title = '没有激活的世界书记录'; } }
        function handleMessageKeypress(event) { if (event.key === 'Enter') { event.preventDefault(); addUserMessageAndCallAI(); } }
        function renderChatMessages() { 
            const chatMessages = document.getElementById('chat-messages'); 
            const messages = appState.chatManager.getMessages(); 
            chatMessages.innerHTML = ''; 
            
            messages.forEach(message => { 
                const messageElement = document.createElement('div'); 
                const isUser = message.sender === 'user'; 
                
                // 使用消息中保存的发送者名称，而不是动态获取
                const senderName = message.senderName || (isUser ? '您' : '助手');
                
                messageElement.className = `message ${isUser ? 'user-message' : 'ai-message'}`; 
                messageElement.setAttribute('data-message-id', message.id); 
                
                const isSelected = appState.selectedMessageIds.includes(message.id); 
                if (isSelected) { 
                    messageElement.classList.add('selected'); 
                } 
                
                messageElement.innerHTML = ` 
                    <div class="message-sender">${senderName}</div> 
                    <div class="message-content">${message.content}</div> 
                    <input type="checkbox" class="message-checkbox" onchange="toggleMessageSelection('${message.id}', this)" ${isSelected ? 'checked' : ''}> 
                    <div class="message-actions"> 
                        <button class="message-action" title="编辑" onclick="editMessage(this, '${message.id}')">✤</button> 
                        <button class="message-action" title="删除" onclick="showDeleteConfirm('${message.id}')">✖</button> 
                    </div> 
                `; 
                chatMessages.appendChild(messageElement); 
            }); 
            
            chatMessages.scrollTop = chatMessages.scrollHeight; 
        }
        function getCurrentAiName() { const savedPersona = localStorage.getItem('aiPersona'); if (savedPersona) { try { const persona = JSON.parse(savedPersona); return persona.name || '助手'; } catch (e) { return '助手'; } } return '助手'; }
        function getCurrentUserName() { const savedPersona = localStorage.getItem('userPersona'); if (savedPersona) { try { const persona = JSON.parse(savedPersona); return persona.name || '您'; } catch (e) { return '您'; } } return '您'; }
        function getCurrentRolePrompt() { const savedPersona = localStorage.getItem('aiPersona'); if (savedPersona) { const persona = JSON.parse(savedPersona); return persona.description || '你是一个有用的助手'; } return '你是一个有用的助手'; }
        function updateApiEndpoints() { const provider = document.getElementById('api-provider').value; const endpointInput = document.getElementById('api-url'); const modelSelect = document.getElementById('model-select'); const providerBadge = document.getElementById('model-provider-badge'); if (provider !== 'custom') { endpointInput.value = API_ENDPOINTS[provider] || ''; providerBadge.textContent = provider.charAt(0).toUpperCase() + provider.slice(1); modelSelect.innerHTML = '<option value="">请选择模型</option>'; const models = MODEL_LISTS[provider] || []; models.forEach(model => { const option = document.createElement('option'); option.value = model; option.textContent = model; option.selected = model === appState.apiService.config.model; modelSelect.appendChild(option); }); } }
        function updateSelectedModel() { const modelSelect = document.getElementById('model-select'); const currentModelDisplay = document.getElementById('current-model-display'); const selectedModel = modelSelect.value; if (selectedModel) { currentModelDisplay.textContent = `当前模型: ${selectedModel}`; appState.apiService.updateConfig({ model: selectedModel }); } else { currentModelDisplay.textContent = '当前模型: 未选择'; appState.apiService.updateConfig({ model: '' }); } }
        async function testApiConnection() { const apiKey = document.getElementById('api-key').value; const apiUrl = document.getElementById('api-url').value; const provider = document.getElementById('api-provider').value; const statusDiv = document.getElementById('api-status'); if (!apiKey) { statusDiv.style.display = 'block'; statusDiv.className = 'api-status status-error'; statusDiv.textContent = '✖ 请输入API密钥'; return; } statusDiv.style.display = 'block'; statusDiv.className = 'api-status'; statusDiv.textContent = '测试连接中...'; try { appState.apiService.updateConfig({ provider: provider, apiKey: apiKey, apiUrl: apiUrl }); const result = await appState.apiService.testConnection(); if (result.success) { statusDiv.className = 'api-status status-success'; statusDiv.textContent = '✔ API连接成功！'; } else { throw new Error(result.error); } } catch (error) { statusDiv.className = 'api-status status-error'; statusDiv.textContent = `✖ API连接失败: ${error.message}`; } updateStatusIndicators(); }
        async function refreshModels() { const apiKey = document.getElementById('api-key').value; const apiUrl = document.getElementById('api-url').value; const provider = document.getElementById('api-provider').value; const statusDiv = document.getElementById('api-status'); const lastUpdated = document.getElementById('last-updated'); const providerBadge = document.getElementById('model-provider-badge'); if (!apiKey) { statusDiv.style.display = 'block'; statusDiv.className = 'api-status status-error'; statusDiv.textContent = '✖ 请先输入API密钥'; return; } statusDiv.style.display = 'block'; statusDiv.className = 'api-status'; statusDiv.textContent = '获取模型中...'; try { appState.apiService.updateConfig({ provider: provider, apiKey: apiKey, apiUrl: apiUrl }); const models = await appState.apiService.getModels(); updateModelSelect(models); statusDiv.className = 'api-status status-success'; statusDiv.textContent = `✔ 成功获取 ${models.length} 个模型`; appState.models = models; appState.lastUpdated = new Date(); lastUpdated.textContent = `上次更新: ${appState.lastUpdated.toLocaleTimeString()}`; updateSelectedModel(); providerBadge.textContent = provider.charAt(0).toUpperCase() + provider.slice(1); } catch (error) { statusDiv.className = 'api-status status-error'; statusDiv.textContent = `✖ 获取模型失败: ${error.message}`; const models = MODEL_LISTS[provider] || ['default-model']; updateModelSelect(models); appState.models = models; appState.lastUpdated = new Date(); lastUpdated.textContent = `上次更新: ${appState.lastUpdated.toLocaleTimeString()}`; updateSelectedModel(); providerBadge.textContent = provider.charAt(0).toUpperCase() + provider.slice(1); } }
        function updateModelSelect(models) { const modelSelect = document.getElementById('model-select'); modelSelect.innerHTML = '<option value="">请选择模型</option>'; models.forEach(model => { const option = document.createElement('option'); option.value = model; option.textContent = model; if (model === appState.apiService.config.model) { option.selected = true; } modelSelect.appendChild(option); }); }
        function saveApiConfig() { const apiKey = document.getElementById('api-key').value; const apiUrl = document.getElementById('api-url').value; const model = document.getElementById('model-select').value; const provider = document.getElementById('api-provider').value; const temperature = document.getElementById('temperature').value; const maxTokens = document.getElementById('max-tokens').value; const replyCount = document.getElementById('reply-count').value; if (apiKey && model) { appState.apiService.updateConfig({ provider: provider, apiKey: apiKey, apiUrl: apiUrl, model: model, replyCount: parseInt(replyCount) || 1 }); updateStatusIndicators(); alert('API配置保存成功！'); } else { alert('请填写完整的API配置信息。'); } }
        function clearApiConfig() { document.getElementById('api-key').value = ''; document.getElementById('api-url').value = 'https://api.openai.com/v1'; document.getElementById('model-select').innerHTML = '<option value="">请选择模型</option>'; document.getElementById('api-provider').value = 'openai'; document.getElementById('temperature').value = '0.7'; document.getElementById('max-tokens').value = '1000'; document.getElementById('reply-count').value = '1'; document.getElementById('current-model-display').textContent = '当前模型: 未选择'; appState.apiService.updateConfig({ provider: 'openai', apiKey: '', apiUrl: 'https://api.openai.com/v1', model: '', replyCount: 1 }); updateStatusIndicators(); alert('API配置已清除！'); }
        function applyGlobalCSS() { const cssCode = document.getElementById('css-editor').value; let styleElement = document.getElementById('global-css'); if (!styleElement) { styleElement = document.createElement('style'); styleElement.id = 'global-css'; document.head.appendChild(styleElement); } styleElement.textContent = cssCode; appState.customCSS = cssCode; localStorage.setItem('customCSS', cssCode); updateStatusIndicators(); alert('全局CSS应用成功！'); }
        function resetCSS() { document.getElementById('css-editor').value = `/* 在这里输入您的自定义CSS */\n.message {\n    border: 1px solid #000;\n    background: white;\n    margin: 8px 0;\n    max-width: 85%;\n}\n\n.user-message {\n    margin-left: auto;\n    background: #f8f8f8;\n}\n\n.ai-message {\n    margin-right: auto;\n    background: #f0f0f0;\n}\n\n.ai-circle {\n    border: 3px solid #000;\n    background: white;\n    transition: all 0.3s ease;\n}\n\n.ai-circle:hover {\n    transform: scale(1.05);\n    box-shadow: 0 5px 15px rgba(0,0,0,0.1);\n}`; appState.customCSS = ''; localStorage.removeItem('customCSS'); const styleElement = document.getElementById('global-css'); if (styleElement) { styleElement.remove(); } updateStatusIndicators(); alert('CSS已重置为默认值！'); }
        function exportCSS() { const cssCode = document.getElementById('css-editor').value; const blob = new Blob([cssCode], { type: 'text/css' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'ai_app_styles.css'; a.click(); URL.revokeObjectURL(url); alert('CSS代码已导出！'); }
        function importCSS() { const input = document.createElement('input'); input.type = 'file'; input.accept = '.css'; input.onchange = function(e) { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = function(e) { document.getElementById('css-editor').value = e.target.result; alert('CSS代码已导入！'); }; reader.readAsText(file); }; input.click(); }
        function updateTemperatureValue() { const temperature = document.getElementById('temperature'); const valueSpan = document.getElementById('temperature-value'); valueSpan.textContent = temperature.value; }
        function openWorldbookModal(recordId = null) { const modal = document.getElementById('worldbook-modal'); const titleInput = document.getElementById('worldbook-title'); const contentInput = document.getElementById('worldbook-content'); const modalTitle = document.getElementById('worldbook-modal-title'); const statusDiv = document.getElementById('worldbook-status'); titleInput.value = ''; contentInput.value = ''; statusDiv.style.display = 'none'; if (recordId) { modalTitle.textContent = '编辑世界书记录'; const record = appState.worldbookManager.getRecordById(recordId); if (record) { titleInput.value = record.title; contentInput.value = record.content; appState.worldbookManager.currentEditingId = recordId; } } else { modalTitle.textContent = '添加世界书记录'; appState.worldbookManager.currentEditingId = null; } modal.style.display = 'flex'; }
        function closeWorldbookModal() { document.getElementById('worldbook-modal').style.display = 'none'; appState.worldbookManager.currentEditingId = null; }
        function saveWorldbookRecord() { const titleInput = document.getElementById('worldbook-title'); const contentInput = document.getElementById('worldbook-content'); const statusDiv = document.getElementById('worldbook-status'); const title = titleInput.value.trim(); const content = contentInput.value.trim(); if (!title || !content) { statusDiv.textContent = '请填写记录标题和内容'; statusDiv.className = 'worldbook-status worldbook-status-error'; statusDiv.style.display = 'block'; return; } let success = false; if (appState.worldbookManager.currentEditingId) { success = appState.worldbookManager.updateRecord(appState.worldbookManager.currentEditingId, title, content); } else { appState.worldbookManager.addRecord(title, content); success = true; } if (success) { statusDiv.textContent = '世界书记录保存成功'; statusDiv.className = 'worldbook-status worldbook-status-success'; statusDiv.style.display = 'block'; renderWorldbookList(); setTimeout(() => { closeWorldbookModal(); }, 1000); } else { statusDiv.textContent = '保存世界书记录失败'; statusDiv.className = 'worldbook-status worldbook-status-error'; statusDiv.style.display = 'block'; } updateWorldbookStatusIndicator(); }
        function deleteWorldbookRecord(recordId) { const record = appState.worldbookManager.getRecordById(recordId); if (!record) return; deleteWorldbookId = recordId; document.getElementById('delete-worldbook-dialog').style.display = 'flex'; }
        function confirmDeleteWorldbookRecord() { if (!deleteWorldbookId) { document.getElementById('delete-worldbook-dialog').style.display = 'none'; return; } appState.worldbookManager.deleteRecord(deleteWorldbookId); renderWorldbookList(); document.getElementById('delete-worldbook-dialog').style.display = 'none'; deleteWorldbookId = null; updateWorldbookStatusIndicator(); }
        function cancelDeleteWorldbookRecord() { document.getElementById('delete-worldbook-dialog').style.display = 'none'; deleteWorldbookId = null; }
        function toggleWorldbookRecord(recordId) { appState.worldbookManager.toggleRecord(recordId); renderWorldbookList(); updateWorldbookStatusIndicator(); }
        function toggleWorldbookContent(recordId) { const contentElement = document.querySelector(`.worldbook-content[data-record-id="${recordId}"]`); if (contentElement) { contentElement.classList.toggle('expanded'); const toggleButton = document.querySelector(`.worldbook-toggle[data-record-id="${recordId}"]`); if (toggleButton) { if (contentElement.classList.contains('expanded')) { toggleButton.textContent = '收起'; } else { toggleButton.textContent = '展开'; } } } }
        function renderWorldbookList() { const worldbookList = document.getElementById('worldbook-list'); const records = appState.worldbookManager.getAllRecords(); if (records.length === 0) { worldbookList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">暂无世界书记录，点击右上角"+"添加</div>'; return; } worldbookList.innerHTML = ''; records.forEach(record => { const recordElement = document.createElement('div'); recordElement.className = 'worldbook-item'; recordElement.innerHTML = `<div class="worldbook-title"><span class="worldbook-active-indicator ${record.active ? 'worldbook-active' : 'worldbook-inactive'}"></span>${record.title}</div><div class="worldbook-content" data-record-id="${record.id}">${record.content}</div><button class="worldbook-toggle" data-record-id="${record.id}" onclick="toggleWorldbookContent('${record.id}')">展开</button><div class="worldbook-actions"><button class="worldbook-action" onclick="toggleWorldbookRecord('${record.id}')">${record.active ? '停用' : '启用'}</button><button class="worldbook-action" onclick="openWorldbookModal('${record.id}')">编辑</button><button class="worldbook-action" onclick="deleteWorldbookRecord('${record.id}')">删除</button></div>`; worldbookList.appendChild(recordElement); }); }
        function exportChatHistory() { const messages = appState.chatManager.getMessages(); if (messages.length === 0) { showBackupStatus('没有聊天记录可以导出', 'error'); return; } const exportData = { version: '1.0', exportTime: new Date().toISOString(), messageCount: messages.length, messages: messages }; const dataStr = JSON.stringify(exportData, null, 2); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `chat_history_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); showBackupStatus(`成功导出 ${messages.length} 条聊天记录`, 'success'); }
        function importChatHistory() { document.getElementById('backup-file-input').click(); }
        document.getElementById('backup-file-input').addEventListener('change', function(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const importData = JSON.parse(e.target.result); if (!importData.messages || !Array.isArray(importData.messages)) { showBackupStatus('文件格式不正确', 'error'); return; } window.currentImportData = importData; document.getElementById('import-confirm-dialog').style.display = 'flex'; } catch (error) { console.error('解析文件失败:', error); showBackupStatus('文件解析失败，请检查文件格式', 'error'); } }; reader.readAsText(file); e.target.value = ''; });
        document.getElementById('confirm-import-btn').addEventListener('click', function() { if (window.currentImportData) { performImport(window.currentImportData); document.getElementById('import-confirm-dialog').style.display = 'none'; } });
        document.getElementById('cancel-import-btn').addEventListener('click', function() { document.getElementById('import-confirm-dialog').style.display = 'none'; });
        function performImport(importData) { try { appState.chatManager.messages.length = 0; importData.messages.forEach(msg => { appState.chatManager.messages.push(msg); }); appState.chatManager.saveMessages(); renderChatMessages(); showBackupStatus(`成功导入 ${importData.messages.length} 条聊天记录`, 'success'); } catch (error) { console.error('导入聊天记录失败:', error); showBackupStatus('导入聊天记录失败', 'error'); } }
        function backupToLocal() { const messages = appState.chatManager.getMessages(); if (messages.length === 0) { showBackupStatus('没有聊天记录可以备份', 'error'); return; } const backupData = { version: '1.0', backupTime: new Date().toISOString(), messageCount: messages.length, messages: messages }; localStorage.setItem('chatBackup', JSON.stringify(backupData)); showBackupStatus(`成功备份 ${messages.length} 条聊天记录到本地`, 'success'); }
        function restoreFromLocal() { const backupDataStr = localStorage.getItem('chatBackup'); if (!backupDataStr) { showBackupStatus('没有找到本地备份', 'error'); return; } try { const backupData = JSON.parse(backupDataStr); if (!backupData.messages || !Array.isArray(backupData.messages)) { showBackupStatus('备份数据格式不正确', 'error'); return; } window.currentBackupData = backupData; document.getElementById('restore-confirm-dialog').style.display = 'flex'; document.getElementById('restore-confirm-text').textContent = `恢复聊天记录将覆盖当前的所有消息，此操作不可撤销。确定要恢复 ${backupData.messageCount} 条消息吗？`; } catch (error) { console.error('解析备份数据失败:', error); showBackupStatus('备份数据解析失败', 'error'); } }
        document.getElementById('confirm-restore-btn').addEventListener('click', function() { if (window.currentBackupData) { performRestore(window.currentBackupData); document.getElementById('restore-confirm-dialog').style.display = 'none'; } });
        document.getElementById('cancel-restore-btn').addEventListener('click', function() { document.getElementById('restore-confirm-dialog').style.display = 'none'; });
        function performRestore(backupData) { try { appState.chatManager.messages.length = 0; backupData.messages.forEach(msg => { appState.chatManager.messages.push(msg); }); appState.chatManager.saveMessages(); renderChatMessages(); showBackupStatus(`成功恢复 ${backupData.messageCount} 条聊天记录`, 'success'); } catch (error) { console.error('恢复聊天记录失败:', error); showBackupStatus('恢复聊天记录失败', 'error'); } }
        function showBackupStatus(message, type) { const statusDiv = document.getElementById('backup-status'); statusDiv.textContent = message; statusDiv.className = `backup-status backup-${type}`; statusDiv.style.display = 'block'; setTimeout(() => { statusDiv.style.display = 'none'; }, 3000); }
        document.addEventListener('DOMContentLoaded', function() { loadSignature(); document.getElementById('desktop-signature').addEventListener('blur', saveSignature); document.getElementById('desktop-signature').addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); this.blur(); } }); document.getElementById('confirm-delete-btn').addEventListener('click', confirmDelete); document.getElementById('cancel-delete-btn').addEventListener('click', cancelDelete); document.getElementById('confirm-import-btn').addEventListener('click', function() { const importData = window.currentImportData; if (importData) { performImport(importData); document.getElementById('import-confirm-dialog').style.display = 'none'; } }); document.getElementById('cancel-import-btn').addEventListener('click', function() { document.getElementById('import-confirm-dialog').style.display = 'none'; }); document.getElementById('confirm-restore-btn').addEventListener('click', function() { const backupData = window.currentBackupData; if (backupData) { performRestore(backupData); document.getElementById('restore-confirm-dialog').style.display = 'none'; } }); document.getElementById('cancel-restore-btn').addEventListener('click', function() { document.getElementById('restore-confirm-dialog').style.display = 'none'; }); document.getElementById('confirm-clear-chat-btn').addEventListener('click', confirmClearChatHistory); document.getElementById('cancel-clear-chat-btn').addEventListener('click', cancelClearChatHistory); document.getElementById('confirm-delete-selected-btn').addEventListener('click', confirmDeleteSelectedMessages); document.getElementById('cancel-delete-selected-btn').addEventListener('click', cancelDeleteSelectedMessages); document.getElementById('save-worldbook-btn').addEventListener('click', saveWorldbookRecord); document.getElementById('cancel-worldbook-btn').addEventListener('click', closeWorldbookModal); document.getElementById('confirm-delete-worldbook-btn').addEventListener('click', confirmDeleteWorldbookRecord); document.getElementById('cancel-delete-worldbook-btn').addEventListener('click', cancelDeleteWorldbookRecord); document.getElementById('confirm-weibo-delete-btn').addEventListener('click', function() { weiboManager.confirmDeleteWeibo(); }); document.getElementById('cancel-weibo-delete-btn').addEventListener('click', function() { weiboManager.cancelDeleteWeibo(); }); updateDesktopTime(); setInterval(updateDesktopTime, 1000); document.querySelectorAll('.interface').forEach(interface => { interface.classList.remove('active'); }); document.getElementById('desktop-interface').classList.add('active'); currentInterface = 'desktop'; const savedPersona = localStorage.getItem('aiPersona'); if (savedPersona) { const persona = JSON.parse(savedPersona); } const currentConfig = appState.apiService.getCurrentConfig(); if (currentConfig.apiKey) { document.getElementById('api-key').value = currentConfig.apiKey || ''; document.getElementById('api-url').value = currentConfig.apiUrl || 'https://api.openai.com/v1'; document.getElementById('api-provider').value = currentConfig.provider || 'openai'; document.getElementById('temperature').value = 0.7; document.getElementById('max-tokens').value = 1000; document.getElementById('reply-count').value = currentConfig.replyCount || 1; if (currentConfig.model) { const modelSelect = document.getElementById('model-select'); setTimeout(() => { const options = Array.from(modelSelect.options); const option = options.find(opt => opt.value === currentConfig.model); if (option) { option.selected = true; updateSelectedModel(); } }, 100); } } const savedCSS = localStorage.getItem('customCSS'); if (savedCSS) { document.getElementById('css-editor').value = savedCSS; appState.customCSS = savedCSS; let styleElement = document.getElementById('global-css'); if (!styleElement) { styleElement = document.createElement('style'); styleElement.id = 'global-css'; document.head.appendChild(styleElement); } styleElement.textContent = savedCSS; } updateTemperatureValue(); document.getElementById('temperature').addEventListener('input', updateTemperatureValue); updateApiEndpoints(); updateStatusIndicators(); renderChatMessages(); musicPlayer.init(); updateWorldbookStatusIndicator(); loadChatMode(); loadChatType(); refreshMultiPersonaPreview(); });
    </script>
</body>
</html>