<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>世纪白昼的极简机</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #ffffff;
            color: #000000;
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 800px;
            margin: 0 auto;
            background: #ffffff;
            border: 1px solid #f0f0f0;
        }
        
        .header {
            background-color: #ffffff;
            color: #000000;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 400;
        }
        
        .content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .page {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .page.active {
            display: flex;
        }
        
        .footer {
            display: flex;
            background-color: #ffffff;
            border-top: 1px solid #f0f0f0;
        }            
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 16px 0;
            color: #666666;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            color: #000000;
            border-bottom-color: #000000;
        }
        
        .tab:hover {
            color: #000000;
            background-color: #fafafa;
        }
        
        /* 聊天页面样式 */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-header {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffffff;
        }       
        
        .chat-header h2 {
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #ffffff;
        }  
        
        .message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 70%;
            position: relative;
            font-size: 0.95rem;
            line-height: 1.4;
            border: 1px solid #f0f0f0;
            background: #ffffff;
            transition: all 0.2s;
        }        
        
        .user-message {
            margin-left: auto;
            border-bottom-right-radius: 6px;
        }
        
        .bot-message {
            margin-right: auto;
            border-bottom-left-radius: 6px;
        }
        
        .message:hover .message-actions {
            opacity: 1;
        }
        
        .message-actions {
            position: absolute;
            top: -10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
            background: white;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #f0f0f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .message-action {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 3px;
            color: #666;
        }
        
        .message-action:hover {
            background: #f5f5f5;
            color: #000;
        }
        
        .edit-message-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #f0f0f0;
            border-radius: 4px;
            font-size: 0.95rem;
            resize: vertical;
            min-height: 60px;
        }
        
        .edit-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
        }
        
        .chat-input-container {
            padding: 16px 20px;
            border-top: 1px solid #f0f0f0;
            background: #ffffff;
        }
        
        .chat-input {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }          
        
        .chat-input textarea {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #f0f0f0;
            border-radius: 24px;
            resize: none;
            font-size: 0.95rem;
            background: #ffffff;
            min-height: 44px;
            max-height: 120px;
        }
        
        .chat-input button {
            padding: 12px 24px;
            background: #000000;
            color: #ffffff;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background 0.2s;
        }
        
        .chat-input button:hover {
            background: #333333;
        }
        
        /* API配置页面样式 */
        .api-container {
            padding: 20px;
            overflow-y: auto;
            height: 100%;
        }
        
        .api-form {
            background: #ffffff;
        }
        
        .api-form h2 {
            margin-bottom: 24px;
            font-weight: 500;
            font-size: 1.3rem;
        }           
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #000000;
        }    
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #f0f0f0;
            border-radius: 8px;
            font-size: 0.95rem;
            background: #ffffff;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }
        
        .btn {      
            padding: 10px 20px;
            border: 1px solid #f0f0f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            background: #ffffff;
            color: #000000;
        }
        
        .btn-primary {
            background: #000000;
            color: #ffffff;
            border-color: #000000;
        }          

        .btn-secondary {
            background: #f8f8f8;
            color: #000000;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        /* 角色管理页面样式 */
        .roles-container {
            padding: 20px;
            overflow-y: auto;
            height: 100%;
        }                                                                                   
        
        .roles-container h2 {
            margin-bottom: 20px;
            font-weight: 500;
            font-size: 1.3rem;
        }
        
        .role-list {
            margin-bottom: 20px;
        }
        
        .role-card {
            background: #ffffff;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #f0f0f0;
            border-radius: 8px;
        }
        
        .role-card h3 {
            margin-bottom: 8px;
            font-weight: 500;
        }       
        
        .role-card p {
            color: #666666;
            font-size: 0.9rem;
            margin-bottom: 12px;
        }
        
        .role-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }       
         
        /* 加载动画 */
        .loading-dots {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #cccccc;
            animation: loadingAnimation 1.4s infinite ease-in-out;
            margin: 0 2px;
        }
        
        .loading-dots:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dots:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes loadingAnimation {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* 提示信息 */
        .alert {
            padding: 12px 16px;
            margin-bottom: 16px;
            border-radius: 8px;
            border: 1px solid #f0f0f0;
        }
        
        .alert-success {
            background: #f0f9f0;
            color: #0a6c0a;
        }

        .alert-error {
            background: #fdf0f0;
            color: #c53030;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .container {
                height: 100vh;
                max-width: 100%;
            }             
            
            .message {
                max-width: 85%;
            }
            
            .tab {
                padding: 14px 0;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>世纪白昼的极简机</h1>
        </div>
        
        <div class="content">
            <!-- 聊天页面 -->
            <div id="chat-page" class="page active">
                <div class="chat-container">
                    <div class="chat-header">
                        <h2 id="current-role">未选择角色</h2>
                        <button id="add-role-btn" class="btn btn-primary">添加角色</button>
                    </div>
                    <div class="chat-messages" id="chat-messages">
                        <!-- 消息将在这里动态添加 -->
                    </div>
                    <div class="chat-input-container">
                        <div class="chat-input">
                            <textarea id="user-input" placeholder="输入消息..."></textarea>
                            <button id="send-btn">发送</button>
                        </div>
                    </div>
                </div>
            </div>  
            
            <!-- API配置页面 -->
            <div id="api-page" class="page">
                <div class="api-container">
                    <div class="api-form">
                        <h2>API配置</h2>
                        <div id="api-alert" class="alert" style="display: none;"></div>
                        <div class="form-group">
                            <label for="api-provider">API提供商</label>
                            <select id="api-provider">
                                <option value="openai">OpenAI</option>
                                <option value="custom">自定义</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="api-key">API密钥</label>
                            <input type="password" id="api-key" placeholder="请输入API密钥">
                        </div>
                        <div class="form-group">
                            <label for="api-url">API地址</label>
                            <input type="text" id="api-url" placeholder="https://api.openai.com/v1">
                        </div>   
                        <div class="form-group">
                            <label for="model-select">模型选择</label>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <select id="model-select" style="flex: 1;">
                                    <option value="">请先获取模型列表</option>
                                </select>
                                <button id="refresh-models" class="btn btn-secondary">刷新模型</button>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button id="test-api" class="btn btn-secondary">测试连接</button>
                            <button id="save-api" class="btn btn-primary">保存配置</button>
                        </div>
                    </div>
                </div>
            </div>    
            
            <!-- 角色管理页面 -->
            <div id="roles-page" class="page">
                <div class="roles-container">
                    <h2>角色管理</h2>
                    <div class="role-list" id="role-list">
                        <!-- 角色卡片将在这里动态添加 -->
                    </div>
                    <button id="new-role-btn" class="btn btn-primary">新建角色</button>
                    
                    <!-- 角色编辑表单 (初始隐藏) -->
                    <div id="role-form" style="display: none; margin-top: 24px;">
                        <h3 id="form-title" style="margin-bottom: 16px;">新建角色</h3>
                        <div class="form-group">
                            <label for="role-name">角色名称</label>
                            <input type="text" id="role-name" placeholder="请输入角色名称">
                        </div>    
                        <div class="form-group">
                            <label for="role-description">角色描述</label>
                            <textarea id="role-description" placeholder="请输入角色描述" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="role-prompt">角色提示词</label>
                            <textarea id="role-prompt" placeholder="请输入角色提示词（用于指导AI如何扮演这个角色）" rows="4"></textarea>
                        </div>
                        <div class="form-actions">
                            <button id="cancel-role" class="btn btn-secondary">取消</button>
                            <button id="save-role" class="btn btn-primary">保存</button>
                        </div>                                                              
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <div class="tab active" data-page="chat-page">聊天</div>
            <div class="tab" data-page="api-page">API配置</div>
            <div class="tab" data-page="roles-page">角色管理</div>
        </div>
    </div>

    <script>
        // API服务类
        class ApiService {
            constructor() {    
                this.config = JSON.parse(localStorage.getItem('apiConfig')) || {
                    provider: 'openai',
                    apiKey: '',
                    apiUrl: 'https://api.openai.com/v1',
                    model: 'gpt-3.5-turbo'
                };
            }             

            async getModels() {
                try {
                    const response = await fetch(`${this.config.apiUrl}/models`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${this.config.apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });   
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `API请求失败: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.data.map(model => model.id);
                } catch (error) {
                    console.error('获取模型列表失败:', error);
                    throw error;
                }
            }      

            async chatWithRole(rolePrompt, userMessage, temperature = 0.7) {
                if (!this.config.apiKey) {
                    throw new Error('API密钥未配置');
                }

                const messages = [
                    { role: 'system', content: rolePrompt },
                    { role: 'user', content: userMessage }
                ];

                try {
                    const response = await fetch(`${this.config.apiUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.config.apiKey}`,
                            'Content-Type': 'application/json'
                        },     
                        body: JSON.stringify({
                            model: this.config.model,
                            messages: messages,
                            temperature: temperature
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API请求失败: ${errorData.error?.message || response.status}`);
                    }

                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error('API调用失败:', error);
                    throw error;
                }
            }

            async testConnection() {
                try {
                    const models = await this.getModels();
                    return { success: true, models: models };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
        }              

        // 应用主逻辑
        const apiService = new ApiService();
        let roles = JSON.parse(localStorage.getItem('roles')) || [];
        let currentRoleId = null;
        let editingRoleId = null;
        let messages = []; // 存储所有消息

        // 页面切换逻辑
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const pageId = tab.getAttribute('data-page');
                document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
            });
        });    

        // 角色管理功能
        function renderRoles() {
            const roleList = document.getElementById('role-list');
            roleList.innerHTML = '';
            
            if (roles.length === 0) {
                roleList.innerHTML = '<p style="color: #666; text-align: center; padding: 40px 0;">暂无角色，点击"新建角色"开始创建</p>';
                return;
            }
            
            roles.forEach(role => {
                const roleCard = document.createElement('div');
                roleCard.className = 'role-card';
                roleCard.innerHTML = `
                    <h3>${role.name}</h3>
                    <p>${role.description || '暂无描述'}</p>
                    <div class="role-actions">
                        <button class="btn btn-primary use-role" data-id="${role.id}">使用</button>
                        <button class="btn btn-secondary edit-role" data-id="${role.id}">编辑</button>
                        <button class="btn btn-secondary delete-role" data-id="${role.id}">删除</button>
                    </div>
                `;
                roleList.appendChild(roleCard);
            });
            
            // 绑定角色按钮事件
            document.querySelectorAll('.use-role').forEach(btn => {
                btn.addEventListener('click', () => {
                    const roleId = btn.getAttribute('data-id');
                    selectRole(roleId);
                    document.querySelector('.tab[data-page="chat-page"]').click();
                });
            });
            
            document.querySelectorAll('.edit-role').forEach(btn => {
                btn.addEventListener('click', () => {
                    const roleId = btn.getAttribute('data-id');
                    editRole(roleId);
                });
            });
            
            document.querySelectorAll('.delete-role').forEach(btn => {
                btn.addEventListener('click', () => {
                    const roleId = btn.getAttribute('data-id');
                    deleteRole(roleId);
                });
            });
        }

        function selectRole(roleId) {
            const role = roles.find(r => r.id === roleId);
            if (role) {
                currentRoleId = roleId;
                document.getElementById('current-role').textContent = role.name;
                messages = []; // 清空消息历史
                renderMessages();
            }
        }

        function editRole(roleId) {
            const role = roles.find(r => r.id === roleId);
            if (role) {
                editingRoleId = roleId;
                document.getElementById('form-title').textContent = '编辑角色';
                document.getElementById('role-name').value = role.name;
                document.getElementById('role-description').value = role.description || '';
                document.getElementById('role-prompt').value = role.prompt || '';
                document.getElementById('role-form').style.display = 'block';
                document.getElementById('role-form').scrollIntoView({ behavior: 'smooth' });
            }
        }   

        function deleteRole(roleId) {
            if (confirm('确定要删除这个角色吗？')) {
                roles = roles.filter(r => r.id !== roleId);
                saveRoles();
                renderRoles();
                if (currentRoleId === roleId) {
                    currentRoleId = null;
                    document.getElementById('current-role').textContent = '未选择角色';
                }
            }
        } 

        function saveRole() {
            const name = document.getElementById('role-name').value.trim();
            const description = document.getElementById('role-description').value.trim();
            const prompt = document.getElementById('role-prompt').value.trim();
            
            if (!name) {
                alert('请输入角色名称');
                return;
            }                            
            
            if (editingRoleId) {
                const role = roles.find(r => r.id === editingRoleId);
                if (role) {
                    role.name = name;
                    role.description = description;
                    role.prompt = prompt;
                }
            } else {
                const newRole = {
                    id: Date.now().toString(),
                    name,
                    description,
                    prompt,
                    createdAt: new Date().toISOString()
                };
                roles.push(newRole);
            }
            
            saveRoles();
            renderRoles();
            resetRoleForm();
        }
                                                                                            
        function resetRoleForm() {
            editingRoleId = null;
            document.getElementById('form-title').textContent = '新建角色';
            document.getElementById('role-name').value = '';
            document.getElementById('role-description').value = '';
            document.getElementById('role-prompt').value = '';
            document.getElementById('role-form').style.display = 'none';
        }

        function saveRoles() {
            localStorage.setItem('roles', JSON.stringify(roles));
        }

        // API配置功能
        function initApiForm() {
            const config = apiService.config;
            document.getElementById('api-provider').value = config.provider;
            document.getElementById('api-key').value = config.apiKey;
            document.getElementById('api-url').value = config.apiUrl;
            
            const modelSelect = document.getElementById('model-select');
            if (config.model) {
                const option = document.createElement('option');
                option.value = config.model;
                option.textContent = config.model;
                modelSelect.innerHTML = '';
                modelSelect.appendChild(option);
            }
        }

        function showAlert(message, type = 'success') {
            const alertDiv = document.getElementById('api-alert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        async function refreshModels() {
            try {
                const modelSelect = document.getElementById('model-select');
                modelSelect.innerHTML = '<option value="">加载中...</option>';
                
                const { success, models, error } = await apiService.testConnection();
                
                if (success) {
                    modelSelect.innerHTML = '';
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                    
                    if (apiService.config.model) {
                        modelSelect.value = apiService.config.model;
                    }
                    
                    showAlert(`成功获取 ${models.length} 个模型`, 'success');
                } else {
                    modelSelect.innerHTML = '<option value="">获取失败</option>';
                    throw new Error(error);
                }
            } catch (error) {
                showAlert(`刷新模型失败: ${error.message}`, 'error');
            }   
        }

        async function testApiConnection() {
            try {
                const testBtn = document.getElementById('test-api');
                const originalText = testBtn.textContent;
                testBtn.textContent = '测试中...';
                testBtn.disabled = true;
                
                const { success, error } = await apiService.testConnection();
                
                testBtn.textContent = originalText;
                testBtn.disabled = false;
                
                if (success) {
                    showAlert('API连接测试成功！', 'success');
                } else {
                    throw new Error(error);
                }  
            } catch (error) {
                let errorMessage = `连接失败: ${error.message}\n\n可能原因:\n`;
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage += '1. API地址不正确或服务器不可达\n';
                    errorMessage += '2. 网络连接问题或防火墙限制\n';
                    errorMessage += '3. 跨域问题(CORS)，尝试使用代理\n';
                } else if (error.message.includes('401')) {
                    errorMessage += '1. API密钥不正确或已过期\n';
                    errorMessage += '2. 密钥格式错误\n';
                } else if (error.message.includes('404')) {
                    errorMessage += '1. API端点路径不正确\n';
                    errorMessage += '2. 服务未部署在该路径\n';
                } else if (error.message.includes('429')) {
                    errorMessage += '1. API调用频率超限\n';
                    errorMessage += '2. 账户配额已用完\n';
                } else {       
                    errorMessage += '1. 服务器内部错误\n';
                    errorMessage += '2. 请求格式不正确\n';
                }
                
                showAlert(errorMessage, 'error');
            }
        }

        function saveApiConfig() {
            apiService.config = {
                provider: document.getElementById('api-provider').value,
                apiKey: document.getElementById('api-key').value,
                apiUrl: document.getElementById('api-url').value.trim(),
                model: document.getElementById('model-select').value
            };
            localStorage.setItem('apiConfig', JSON.stringify(apiService.config));
            showAlert('API配置已保存', 'success');
        }  

        // 聊天功能 - 新增消息编辑和删除功能
        function renderMessages() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            
            messages.forEach((message, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.sender}-message`;
                messageDiv.setAttribute('data-index', index);
                
                if (message.isEditing) {
                    // 编辑模式
                    messageDiv.innerHTML = `
                        <textarea class="edit-message-input">${message.content}</textarea>
                        <div class="edit-actions">
                            <button class="btn btn-secondary save-edit">保存</button>
                            <button class="btn btn-secondary cancel-edit">取消</button>
                        </div>
                    `;  
                } else {
                    // 显示模式
                    messageDiv.innerHTML = `
                        <div class="message-content">${message.content}</div>
                        <div class="message-actions">
                            <button class="message-action edit-btn">编辑</button>
                            <button class="message-action delete-btn">删除</button>
                        </div>
                    `;
                }  
                
                messagesContainer.appendChild(messageDiv);
                
                // 绑定编辑和删除事件
                if (!message.isEditing) {
                    const editBtn = messageDiv.querySelector('.edit-btn');
                    const deleteBtn = messageDiv.querySelector('.delete-btn');
                    
                    editBtn.addEventListener('click', () => {
                        enterEditMode(index);
                    });
                    
                    deleteBtn.addEventListener('click', () => {
                        deleteMessage(index);
                    });     
                } else {
                    const saveBtn = messageDiv.querySelector('.save-edit');
                    const cancelBtn = messageDiv.querySelector('.cancel-edit');
                    
                    saveBtn.addEventListener('click', () => {
                        saveEdit(index, messageDiv.querySelector('.edit-message-input').value);
                    });
                    
                    cancelBtn.addEventListener('click', () => {
                        cancelEdit(index);
                    });
                }
            });    
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function enterEditMode(index) {
            messages[index].isEditing = true;
            renderMessages();
        } 

        function saveEdit(index, newContent) {
            if (newContent.trim()) {
                messages[index].content = newContent.trim();
                messages[index].isEditing = false;
                renderMessages();
            }
        }

        function cancelEdit(index) {
            messages[index].isEditing = false;
            renderMessages();
        }   

        function deleteMessage(index) {
            messages.splice(index, 1);
            renderMessages();
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!currentRoleId) {
                alert('请先选择一个角色');
                return;
            }
            
            // 添加用户消息
            messages.push({
                content: message,
                sender: 'user',
                timestamp: new Date().toISOString(),
                isEditing: false
            });      
            
            renderMessages();
            input.value = '';
            
            try {
                const role = roles.find(r => r.id === currentRoleId);
                
                // 显示加载状态
                const loadingId = messages.length;
                messages.push({
                    content: '思考中...',
                    sender: 'bot',
                    timestamp: new Date().toISOString(),
                    isEditing: false,
                    isLoading: true
                });     
                renderMessages();
                
                // 调用API获取回复
                const botReply = await apiService.chatWithRole(role.prompt, message);
                
                // 移除加载状态，添加实际回复
                messages.pop(); // 移除加载消息
                messages.push({
                    content: botReply,
                    sender: 'bot',
                    timestamp: new Date().toISOString(),
                    isEditing: false
                }); 
                
                renderMessages();
            } catch (error) {
                console.error('聊天出错:', error);
                // 移除加载消息
                if (messages.length > 0 && messages[messages.length-1].isLoading) {
                    messages.pop();
                }
                // 添加错误消息
                messages.push({
                    content: `出错: ${error.message}`,
                    sender: 'bot',
                    timestamp: new Date().toISOString(),
                    isEditing: false
                });
                renderMessages();
            }
        } 

        // 初始化事件监听
        document.addEventListener('DOMContentLoaded', () => {
            renderRoles();
            initApiForm();
            
            document.getElementById('add-role-btn').addEventListener('click', () => {
                document.querySelector('.tab[data-page="roles-page"]').click();
                document.getElementById('new-role-btn').click();
            });            
            
            document.getElementById('new-role-btn').addEventListener('click', () => {
                resetRoleForm();
                document.getElementById('role-form').style.display = 'block';
                document.getElementById('role-form').scrollIntoView({ behavior: 'smooth' });
            });
            
            document.getElementById('cancel-role').addEventListener('click', resetRoleForm);
            document.getElementById('save-role').addEventListener('click', saveRole);
            
            document.getElementById('save-api').addEventListener('click', saveApiConfig);
            document.getElementById('test-api').addEventListener('click', testApiConnection);
            document.getElementById('refresh-models').addEventListener('click', refreshModels);
            
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('user-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });   
            
            // 自动调整输入框高度
            const textarea = document.getElementById('user-input');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        });
    </script>
</body>
</html>                                                                                                                                                                                                                                                                                                                                                                                                                                               